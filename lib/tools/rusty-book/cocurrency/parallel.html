<!doctype html><html lang=zh-CN class="sidebar-visible no-js light"><meta charset=UTF-8><title>使用rayon并行处理数据 - Rusty Book(锈书)</title><meta content="text/html; charset=utf-8" http-equiv=Content-Type><meta name=description content=""><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content=#ffffff><link rel=icon href=../favicon.svg><link rel="shortcut icon" href=../favicon.png><link rel=stylesheet href=../css/variables.css><link rel=stylesheet href=../css/general.css><link rel=stylesheet href=../css/chrome.css><link rel=stylesheet href=../css/print.css media=print><link rel=stylesheet href=../FontAwesome/css/font-awesome.css><link rel=stylesheet href=../fonts/fonts.css><link rel=stylesheet href=../highlight.css><link rel=stylesheet href=../tomorrow-night.css><link rel=stylesheet href=../ayu-highlight.css><link rel=stylesheet href=../theme/style1.css><body><script>var path_to_root="../",default_theme=window.matchMedia("(prefers-color-scheme: dark)").matches?"navy":"light"</script><script>try{var theme=localStorage.getItem("mdbook-theme"),sidebar=localStorage.getItem("mdbook-sidebar");theme.startsWith('"')&&theme.endsWith('"')&&localStorage.setItem("mdbook-theme",theme.slice(1,theme.length-1)),sidebar.startsWith('"')&&sidebar.endsWith('"')&&localStorage.setItem("mdbook-sidebar",sidebar.slice(1,sidebar.length-1))}catch(e){}</script><script>var theme;try{theme=localStorage.getItem("mdbook-theme")}catch(e){}null==theme&&(theme=default_theme);var html=document.querySelector("html");html.classList.remove("no-js"),html.classList.remove("light"),html.classList.add(theme),html.classList.add("js")</script><script>var html=document.querySelector("html"),sidebar="hidden";if(document.body.clientWidth>=1080){try{sidebar=localStorage.getItem("mdbook-sidebar")}catch(e){}sidebar=sidebar||"visible"}html.classList.remove("sidebar-visible"),html.classList.add("sidebar-"+sidebar)</script><nav id=sidebar class=sidebar aria-label="Table of contents"><div class=sidebar-scrollbox><ol class=chapter><li class="chapter-item expanded affix"><a href=../about.html>Rusty Book</a><li class="chapter-item expanded affix"><li class=part-title>Awesome<li class=spacer><li class="chapter-item expanded"><a href=../daily-dev.html>日常开发常用库</a><li class="chapter-item expanded"><a href=../superstar.html>Rust 明星项目</a><li class="chapter-item expanded"><a href=../empowering-js.html>使用 Rust 增强 JS</a><li class="chapter-item expanded"><a href=../games.html>Rust开发的游戏</a><li class="chapter-item expanded"><a href=../gamedev.html>游戏引擎</a><li class="chapter-item expanded affix"><li class=part-title>Awesome + Cookbook<li class=spacer><li class="chapter-item expanded"><a href=../algos/awesome.html>实用算法</a><a class=toggle><div>❱</div></a><li><ol class=section><li class="chapter-item expanded"><a href=../algos/randomness.html>生成随机值</a><li class="chapter-item expanded"><a href=../algos/sorting.html>Vec 排序</a><li class="chapter-item expanded"><div>压缩算法</div><a class=toggle><div>❱</div></a><li><ol class=section><li class=chapter-item><a href=../algos/compression/tar.html>使用.tar包</a></ol><li class="chapter-item expanded"><div>密码学</div><a class=toggle><div>❱</div></a><li><ol class=section><li class=chapter-item><a href=../algos/cryptography/hashing.html>哈希</a><li class=chapter-item><a href=../algos/cryptography/encryption.html>加密</a></ol><li class="chapter-item expanded"><div>数学计算</div><a class=toggle><div>❱</div></a><li><ol class=section><li class=chapter-item><a href=../algos/math/linear-algebra.html>线性代数</a><li class=chapter-item><a href=../algos/math/trigonometry.html>三角函数</a><li class=chapter-item><a href=../algos/math/complex.html>复数</a><li class=chapter-item><a href=../algos/math/statistics.html>统计学</a><li class=chapter-item><a href=../algos/math/misc.html>杂项</a></ol></ol><li class="chapter-item expanded"><a href=../datastructures/awesome.html>数据结构</a><a class=toggle><div>❱</div></a><li><ol class=section><li class="chapter-item expanded"><a href=../datastructures/bitfield.html>位字段</a></ol><li class="chapter-item expanded"><a href=../cmd/awesome.html>命令行</a><a class=toggle><div>❱</div></a><li><ol class=section><li class="chapter-item expanded"><a href=../cmd/parsing.html>参数解析</a><li class="chapter-item expanded"><a href=../cmd/ansi.html>终端输出格式化</a></ol><li class="chapter-item expanded"><a href=../os/awesome.html>操作系统</a><a class=toggle><div>❱</div></a><li><ol class=section><li class="chapter-item expanded"><a href=../os/processor.html>处理器</a><li class="chapter-item expanded"><a href=../os/command.html>调用系统命令</a></ol><li class="chapter-item expanded"><div>并发</div><a class=toggle><div>❱</div></a><li><ol class=section><li class="chapter-item expanded"><a href=../cocurrency/threads.html>线程</a><li class="chapter-item expanded"><a href=../cocurrency/parallel.html class=active>使用rayon并行处理数据</a></ol><li class="chapter-item expanded"><div>数据库</div><a class=toggle><div>❱</div></a><li><ol class=section><li class="chapter-item expanded"><a href=../database/sqlite.html>SQLite</a><li class="chapter-item expanded"><a href=../database/postgres.html>Postgres</a></ol><li class="chapter-item expanded"><div>日期和时间</div><a class=toggle><div>❱</div></a><li><ol class=section><li class="chapter-item expanded"><a href=../datetime/duration.html>时间计算和转换</a><li class="chapter-item expanded"><a href=../datetime/parsing.html>解析和显示</a></ol><li class="chapter-item expanded"><div>开发者工具</div><a class=toggle><div>❱</div></a><li><ol class=section><li class="chapter-item expanded"><a href=../devtools/log.html>日志</a><li class="chapter-item expanded"><a href=../devtools/config-log.html>配置日志</a><li class="chapter-item expanded"><a href=../devtools/version.html>版本号</a><li class="chapter-item expanded"><a href=../devtools/build-tools.html>构建时工具</a></ol><li class="chapter-item expanded"><div>编解码</div><a class=toggle><div>❱</div></a><li><ol class=section><li class="chapter-item expanded"><a href=../encoding/strings.html>字符编码</a><li class="chapter-item expanded"><a href=../encoding/csv.html>CSV</a><li class="chapter-item expanded"><a href=../encoding/structured.html>结构化数据</a></ol><li class="chapter-item expanded"><div>错误处理</div><li class="chapter-item expanded"><div>文件操作</div><a class=toggle><div>❱</div></a><li><ol class=section><li class="chapter-item expanded"><a href=../files/read-write.html>文件读写</a><li class="chapter-item expanded"><a href=../files/dir.html>目录访问</a></ol><li class="chapter-item expanded"><div>内存管理</div><a class=toggle><div>❱</div></a><li><ol class=section><li class="chapter-item expanded"><a href=../memory/global-vars.html>全局变量</a></ol><li class="chapter-item expanded"><div>网络协议</div><a class=toggle><div>❱</div></a><li><ol class=section><li class="chapter-item expanded"><a href=../protocols/tcpip.html>TCP/IP</a></ol><li class="chapter-item expanded"><div>文本处理</div><a class=toggle><div>❱</div></a><li><ol class=section><li class="chapter-item expanded"><a href=../text/regex.html>正则表达式</a><li class="chapter-item expanded"><a href=../text/string.html>字符串解析</a></ol></ol></div><div id=sidebar-resize-handle class=sidebar-resize-handle></div></nav><div id=page-wrapper class=page-wrapper><div class=page><div id=menu-bar-hover-placeholder></div><div id=menu-bar class="menu-bar sticky bordered"><div class=left-buttons><button id=sidebar-toggle class=icon-button type=button title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls=sidebar><i class="fa fa-bars"></i></button> <button id=theme-toggle class=icon-button type=button title="Change theme" aria-label="Change theme" aria-haspopup=true aria-expanded=false aria-controls=theme-list><i class="fa fa-paint-brush"></i></button><ul id=theme-list class=theme-popup aria-label=Themes role=menu><li role=none><button role=menuitem class=theme id=light>Light (default)</button><li role=none><button role=menuitem class=theme id=rust>Rust</button><li role=none><button role=menuitem class=theme id=coal>Coal</button><li role=none><button role=menuitem class=theme id=navy>Navy</button><li role=none><button role=menuitem class=theme id=ayu>Ayu</button></ul><button id=search-toggle class=icon-button type=button title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded=false aria-keyshortcuts=S aria-controls=searchbar><i class="fa fa-search"></i></button></div><h1 class=menu-title>Rusty Book(锈书)</h1><div class=right-buttons><a href=../print.html title="Print this book" aria-label="Print this book"><i id=print-button class="fa fa-print"></i> </a><a href=https://github.com/studyrs/rusty-book title="Git repository" aria-label="Git repository"><i id=git-repository-button class="fa fa-github"></i> </a><a href=https://github.com/studyrs/rusty-book/edit/main/src/cocurrency/parallel.md title="Suggest an edit" aria-label="Suggest an edit"><i id=git-edit-button class="fa fa-edit"></i></a></div></div><div id=search-wrapper class=hidden><form id=searchbar-outer class=searchbar-outer><input type=search id=searchbar name=searchbar placeholder="Search this book ..." aria-controls=searchresults-outer aria-describedby=searchresults-header></form><div id=searchresults-outer class="searchresults-outer hidden"><div id=searchresults-header class=searchresults-header></div><ul id=searchresults></ul></div></div><script>document.getElementById("sidebar-toggle").setAttribute("aria-expanded","visible"===sidebar),document.getElementById("sidebar").setAttribute("aria-hidden","visible"!==sidebar),Array.from(document.querySelectorAll("#sidebar a")).forEach((function(e){e.setAttribute("tabIndex","visible"===sidebar?0:-1)}))</script><div id=content class=content><div class=sidetoc><nav class=pagetoc></nav></div><main><h1 id=任务并行处理><a class=header href=#任务并行处理>任务并行处理</a></h1><h3 id=并行修改数组中的元素><a class=header href=#并行修改数组中的元素>并行修改数组中的元素</a></h3><p><a href=https://docs.rs/rayon/1.5.1/rayon/index.html>rayon</a> 提供了一个 <a href=https://docs.rs/rayon/*/rayon/iter/trait.IntoParallelRefMutIterator.html#tymethod.par_iter_mut>par_iter_mut</a> 方法用于并行化迭代一个数据集合。<pre><pre class=playground><code class="language-rust editable edition2021">use rayon::prelude::*;

fn main() {
    let mut arr = [0, 7, 9, 11];
    arr.par_iter_mut().for_each(|p| *p -= 1);
    println!(&quot;{:?}&quot;, arr);
}
</code></pre></pre><h3 id=并行测试集合中的元素是否满足给定的条件><a class=header href=#并行测试集合中的元素是否满足给定的条件>并行测试集合中的元素是否满足给定的条件</a></h3><p><a href=https://docs.rs/rayon/*/rayon/iter/trait.ParallelIterator.html#method.any>rayon::any</a> 和 <a href=https://docs.rs/rayon/*/rayon/iter/trait.ParallelIterator.html#method.all>rayon::all</a> 类似于 <a href=https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.any>std::any</a> / <a href=https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.all>std::all</a> ，但是是并行版本的。<ul><li><code>rayon::any</code> 并行检查迭代器中是否有任何元素满足给定的条件，一旦发现符合条件的元素，就立即返回<li><code>rayon::all</code> 并行检查迭代器中的所有元素是否满足给定的条件，一旦发现不满足条件的元素，就立即返回</ul><pre><pre class=playground><code class="language-rust editable edition2021">use rayon::prelude::*;

fn main() {
    let mut vec = vec![2, 4, 6, 8];

    assert!(!vec.par_iter().any(|n| (*n % 2) != 0));
    assert!(vec.par_iter().all(|n| (*n % 2) == 0));
    assert!(!vec.par_iter().any(|n| *n &gt; 8 ));
    assert!(vec.par_iter().all(|n| *n &lt;= 8 ));

    vec.push(9);

    assert!(vec.par_iter().any(|n| (*n % 2) != 0));
    assert!(!vec.par_iter().all(|n| (*n % 2) == 0));
    assert!(vec.par_iter().any(|n| *n &gt; 8 ));
    assert!(!vec.par_iter().all(|n| *n &lt;= 8 )); 
}
</code></pre></pre><h3 id=使用给定条件并行搜索><a class=header href=#使用给定条件并行搜索>使用给定条件并行搜索</a></h3><p>下面例子使用 <a href=https://docs.rs/rayon/*/rayon/iter/trait.IntoParallelRefIterator.html#tymethod.par_iter>par_iter</a> 和 <a href=https://docs.rs/rayon/*/rayon/iter/trait.ParallelIterator.html#method.find_any>rayon::find_any</a> 来并行搜索一个数组，直到找到任意一个满足条件的元素。<p>如果有多个元素满足条件，<code>rayon</code> 会返回第一个找到的元素，注意：第一个找到的元素未必是数组中的顺序最靠前的那个。<pre><pre class=playground><code class="language-rust editable edition2021">use rayon::prelude::*;

fn main() {
    let v = vec![6, 2, 1, 9, 3, 8, 11];

    // 这里使用了 `&amp;&amp;x` 的形式，大家可以在以下链接阅读更多 https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.find
    let f1 = v.par_iter().find_any(|&amp;&amp;x| x == 9);
    let f2 = v.par_iter().find_any(|&amp;&amp;x| x % 2 == 0 &amp;&amp; x &gt; 6);
    let f3 = v.par_iter().find_any(|&amp;&amp;x| x &gt; 8);

    assert_eq!(f1, Some(&amp;9));
    assert_eq!(f2, Some(&amp;8));
    assert!(f3 &gt; Some(&amp;8));
}
</code></pre></pre><h3 id=对数组进行并行排序><a class=header href=#对数组进行并行排序>对数组进行并行排序</a></h3><p>下面的例子将对字符串数组进行并行排序。<p><a href=https://docs.rs/rayon/*/rayon/slice/trait.ParallelSliceMut.html#method.par_sort_unstable>par_sort_unstable</a> 方法的排序性能往往要比<a href=https://docs.rs/rayon/1.5.1/rayon/slice/trait.ParallelSliceMut.html#method.par_sort>稳定的排序算法</a>更高。<pre><pre class=playground><code class="language-rust editable edition2021">use rand::{Rng, thread_rng};
use rand::distributions::Alphanumeric;
use rayon::prelude::*;

fn main() {
  let mut vec = vec![String::new(); 100_000];
  // 并行生成数组中的字符串
  vec.par_iter_mut().for_each(|p| {
    let mut rng = thread_rng();
    *p = (0..5).map(|_| rng.sample(&amp;Alphanumeric)).collect()
  });
  
  // 
  vec.par_sort_unstable();
}
</code></pre></pre><h3 id=并行化-map-reuduce><a class=header href=#并行化-map-reuduce>并行化 Map-Reuduce</a></h3><p>下面例子使用 <a href=https://docs.rs/rayon/*/rayon/iter/trait.ParallelIterator.html#method.filter>rayon::filter</a>, <a href=https://docs.rs/rayon/*/rayon/iter/trait.ParallelIterator.html#method.map>rayon::map</a>, 和 <a href=https://docs.rs/rayon/*/rayon/iter/trait.ParallelIterator.html#method.reduce>rayon::reduce</a> 来超过 30 岁的 <code>Person</code> 的平均年龄。<ul><li><code>rayon::filter</code> 返回集合中所有满足给定条件的元素<li><code>rayon::map</code> 对集合中的每一个元素执行一个操作，创建并返回新的迭代器，类似于<a href=https://course.rs/advance/functional-programing/iterator.html#%E8%BF%AD%E4%BB%A3%E5%99%A8%E9%80%82%E9%85%8D%E5%99%A8>迭代器适配器</a><li><code>rayon::reduce</code> 则迭代器的元素进行不停的聚合运算，直到获取一个最终结果，这个结果跟例子中 <code>rayon::sum</code> 获取的结果是相同的</ul><pre><pre class=playground><code class="language-rust editable edition2021">use rayon::prelude::*;

struct Person {
    age: u32,
}

fn main() {
    let v: Vec&lt;Person&gt; = vec![
        Person { age: 23 },
        Person { age: 19 },
        Person { age: 42 },
        Person { age: 17 },
        Person { age: 17 },
        Person { age: 31 },
        Person { age: 30 },
    ];

    let num_over_30 = v.par_iter().filter(|&amp;x| x.age &gt; 30).count() as f32;
    let sum_over_30 = v.par_iter()
        .map(|x| x.age)
        .filter(|&amp;x| x &gt; 30)
        .reduce(|| 0, |x, y| x + y);

    let alt_sum_30: u32 = v.par_iter()
        .map(|x| x.age)
        .filter(|&amp;x| x &gt; 30)
        .sum();

    let avg_over_30 = sum_over_30 as f32 / num_over_30;
    let alt_avg_over_30 = alt_sum_30 as f32/ num_over_30;

    assert!((avg_over_30 - alt_avg_over_30).abs() &lt; std::f32::EPSILON);
    println!(&quot;The average age of people older than 30 is {}&quot;, avg_over_30);
}
</code></pre></pre><h3 id=并行生成缩略图><a class=header href=#并行生成缩略图>并行生成缩略图</a></h3><p>下面例子将为目录中的所有图片并行生成缩略图，然后将结果存到新的目录 <code>thumbnails</code> 中。<p><a href=https://docs.rs/glob/*/glob/fn.glob_with.html>glob::glob_with</a> 可以找出当前目录下的所有 <code>.jpg</code> 文件，<code>rayon</code> 通过 <a href=https://docs.rs/image/*/image/enum.DynamicImage.html#method.resize>DynamicImage::resize</a> 来并行调整图片的大小。<pre><pre class=playground><code class="language-rust editable edition2021"><span class=boring>use error_chain::error_chain;
</span>
use std::path::Path;
use std::fs::create_dir_all;

<span class=boring>use error_chain::ChainedError;
</span>use glob::{glob_with, MatchOptions};
use image::{FilterType, ImageError};
use rayon::prelude::*;

<span class=boring>error_chain! {
</span><span class=boring>   foreign_links {
</span><span class=boring>       Image(ImageError);
</span><span class=boring>       Io(std::io::Error);
</span><span class=boring>       Glob(glob::PatternError);
</span><span class=boring>   }
</span><span class=boring>}
</span>
fn main() -&gt; Result&lt;()&gt; {
    let options: MatchOptions = Default::default();
    // 找到当前目录中的所有 `jpg` 文件
    let files: Vec&lt;_&gt; = glob_with(&quot;*.jpg&quot;, options)?
        .filter_map(|x| x.ok())
        .collect();

    if files.len() == 0 {
        error_chain::bail!(&quot;No .jpg files found in current directory&quot;);
    }

    let thumb_dir = &quot;thumbnails&quot;;
    create_dir_all(thumb_dir)?;

    println!(&quot;Saving {} thumbnails into '{}'...&quot;, files.len(), thumb_dir);

    let image_failures: Vec&lt;_&gt; = files
        .par_iter()
        .map(|path| {
            make_thumbnail(path, thumb_dir, 300)
                .map_err(|e| e.chain_err(|| path.display().to_string()))
        })
        .filter_map(|x| x.err())
        .collect();

    image_failures.iter().for_each(|x| println!(&quot;{}&quot;, x.display_chain()));

    println!(&quot;{} thumbnails saved successfully&quot;, files.len() - image_failures.len());
    Ok(())
}

fn make_thumbnail&lt;PA, PB&gt;(original: PA, thumb_dir: PB, longest_edge: u32) -&gt; Result&lt;()&gt;
where
    PA: AsRef&lt;Path&gt;,
    PB: AsRef&lt;Path&gt;,
{
    let img = image::open(original.as_ref())?;
    let file_path = thumb_dir.as_ref().join(original);

    Ok(img.resize(longest_edge, longest_edge, FilterType::Nearest)
        .save(file_path)?)
}
</code></pre></pre><div id=giscus-container></div></main><nav class=nav-wrapper aria-label="Page navigation"><a rel=prev href=../cocurrency/threads.html class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts=Left><i class="fa fa-angle-left"></i> </a><a rel=next href=../database/sqlite.html class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts=Right><i class="fa fa-angle-right"></i></a><div style=clear:both></div></nav></div></div><nav class=nav-wide-wrapper aria-label="Page navigation"><a rel=prev href=../cocurrency/threads.html class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts=Left><i class="fa fa-angle-left"></i> </a><a rel=next href=../database/sqlite.html class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts=Right><i class="fa fa-angle-right"></i></a></nav></div><script>window.playground_copyable=!0</script><script src=../ace.js charset=utf-8></script><script src=../editor.js charset=utf-8></script><script src=../mode-rust.js charset=utf-8></script><script src=../theme-dawn.js charset=utf-8></script><script src=../theme-tomorrow_night.js charset=utf-8></script><script src=../elasticlunr.min.js charset=utf-8></script><script src=../mark.min.js charset=utf-8></script><script src=../searcher.js charset=utf-8></script><script src=../clipboard.min.js charset=utf-8></script><script src=../highlight.js charset=utf-8></script><script src=../book.js charset=utf-8></script><script>var pagePath="cocurrency/parallel.md"</script><script src=../assets/custom1.js></script><script src=../assets/bigPicture.js></script>
