"use strict";for(var utils=require("./utils"),support=require("./support"),nodejsUtils=require("./nodejsUtils"),GenericWorker=require("./stream/GenericWorker"),_utf8len=new Array(256),i=0;i<256;i++)_utf8len[i]=i>=252?6:i>=248?5:i>=240?4:i>=224?3:i>=192?2:1;_utf8len[254]=_utf8len[254]=1;var string2buf=function(e){var r,t,o,n,i,u=e.length,s=0;for(n=0;n<u;n++)55296==(64512&(t=e.charCodeAt(n)))&&n+1<u&&56320==(64512&(o=e.charCodeAt(n+1)))&&(t=65536+(t-55296<<10)+(o-56320),n++),s+=t<128?1:t<2048?2:t<65536?3:4;for(r=support.uint8array?new Uint8Array(s):new Array(s),i=0,n=0;i<s;n++)55296==(64512&(t=e.charCodeAt(n)))&&n+1<u&&56320==(64512&(o=e.charCodeAt(n+1)))&&(t=65536+(t-55296<<10)+(o-56320),n++),t<128?r[i++]=t:t<2048?(r[i++]=192|t>>>6,r[i++]=128|63&t):t<65536?(r[i++]=224|t>>>12,r[i++]=128|t>>>6&63,r[i++]=128|63&t):(r[i++]=240|t>>>18,r[i++]=128|t>>>12&63,r[i++]=128|t>>>6&63,r[i++]=128|63&t);return r},utf8border=function(e,r){var t;for((r=r||e.length)>e.length&&(r=e.length),t=r-1;t>=0&&128==(192&e[t]);)t--;return t<0||0===t?r:t+_utf8len[e[t]]>r?t:r},buf2string=function(e){var r,t,o,n,i=e.length,u=new Array(2*i);for(t=0,r=0;r<i;)if((o=e[r++])<128)u[t++]=o;else if((n=_utf8len[o])>4)u[t++]=65533,r+=n-1;else{for(o&=2===n?31:3===n?15:7;n>1&&r<i;)o=o<<6|63&e[r++],n--;n>1?u[t++]=65533:o<65536?u[t++]=o:(o-=65536,u[t++]=55296|o>>10&1023,u[t++]=56320|1023&o)}return u.length!==t&&(u.subarray?u=u.subarray(0,t):u.length=t),utils.applyFromCharCode(u)};function Utf8DecodeWorker(){GenericWorker.call(this,"utf-8 decode"),this.leftOver=null}function Utf8EncodeWorker(){GenericWorker.call(this,"utf-8 encode")}exports.utf8encode=function(e){return support.nodebuffer?nodejsUtils.newBufferFrom(e,"utf-8"):string2buf(e)},exports.utf8decode=function(e){return support.nodebuffer?utils.transformTo("nodebuffer",e).toString("utf-8"):(e=utils.transformTo(support.uint8array?"uint8array":"array",e),buf2string(e))},utils.inherits(Utf8DecodeWorker,GenericWorker),Utf8DecodeWorker.prototype.processChunk=function(e){var r=utils.transformTo(support.uint8array?"uint8array":"array",e.data);if(this.leftOver&&this.leftOver.length){if(support.uint8array){var t=r;(r=new Uint8Array(t.length+this.leftOver.length)).set(this.leftOver,0),r.set(t,this.leftOver.length)}else r=this.leftOver.concat(r);this.leftOver=null}var o=utf8border(r),n=r;o!==r.length&&(support.uint8array?(n=r.subarray(0,o),this.leftOver=r.subarray(o,r.length)):(n=r.slice(0,o),this.leftOver=r.slice(o,r.length))),this.push({data:exports.utf8decode(n),meta:e.meta})},Utf8DecodeWorker.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:exports.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},exports.Utf8DecodeWorker=Utf8DecodeWorker,utils.inherits(Utf8EncodeWorker,GenericWorker),Utf8EncodeWorker.prototype.processChunk=function(e){this.push({data:exports.utf8encode(e.data),meta:e.meta})},exports.Utf8EncodeWorker=Utf8EncodeWorker;
