import{Factory}from"../Factory.js";import{Node}from"../Node.js";import{getNumberValidator}from"../Validators.js";function pixelAt(t,r,a){var o=4*(a*t.width+r),e=[];return e.push(t.data[o++],t.data[o++],t.data[o++],t.data[o++]),e}function rgbDistance(t,r){return Math.sqrt(Math.pow(t[0]-r[0],2)+Math.pow(t[1]-r[1],2)+Math.pow(t[2]-r[2],2))}function rgbMean(t){for(var r=[0,0,0],a=0;a<t.length;a++)r[0]+=t[a][0],r[1]+=t[a][1],r[2]+=t[a][2];return r[0]/=t.length,r[1]/=t.length,r[2]/=t.length,r}function backgroundMask(t,r){var a=pixelAt(t,0,0),o=pixelAt(t,t.width-1,0),e=pixelAt(t,0,t.height-1),h=pixelAt(t,t.width-1,t.height-1),i=r||10;if(rgbDistance(a,o)<i&&rgbDistance(o,h)<i&&rgbDistance(h,e)<i&&rgbDistance(e,a)<i){for(var n=rgbMean([o,a,h,e]),d=[],f=0;f<t.width*t.height;f++){var s=rgbDistance(n,[t.data[4*f],t.data[4*f+1],t.data[4*f+2]]);d[f]=s<i?0:255}return d}}function applyMask(t,r){for(var a=0;a<t.width*t.height;a++)t.data[4*a+3]=r[a]}function erodeMask(t,r,a){for(var o=[1,1,1,1,0,1,1,1,1],e=Math.round(Math.sqrt(o.length)),h=Math.floor(e/2),i=[],n=0;n<a;n++)for(var d=0;d<r;d++){for(var f=n*r+d,s=0,g=0;g<e;g++)for(var M=0;M<e;M++){var l=n+g-h,u=d+M-h;if(l>=0&&l<a&&u>=0&&u<r){var v=o[g*e+M];s+=t[l*r+u]*v}}i[f]=2040===s?255:0}return i}function dilateMask(t,r,a){for(var o=[1,1,1,1,1,1,1,1,1],e=Math.round(Math.sqrt(o.length)),h=Math.floor(e/2),i=[],n=0;n<a;n++)for(var d=0;d<r;d++){for(var f=n*r+d,s=0,g=0;g<e;g++)for(var M=0;M<e;M++){var l=n+g-h,u=d+M-h;if(l>=0&&l<a&&u>=0&&u<r){var v=o[g*e+M];s+=t[l*r+u]*v}}i[f]=s>=1020?255:0}return i}function smoothEdgeMask(t,r,a){for(var o=[1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9],e=Math.round(Math.sqrt(o.length)),h=Math.floor(e/2),i=[],n=0;n<a;n++)for(var d=0;d<r;d++){for(var f=n*r+d,s=0,g=0;g<e;g++)for(var M=0;M<e;M++){var l=n+g-h,u=d+M-h;if(l>=0&&l<a&&u>=0&&u<r){var v=o[g*e+M];s+=t[l*r+u]*v}}i[f]=s}return i}export const Mask=function(t){var r=backgroundMask(t,this.threshold());return r&&applyMask(t,r=smoothEdgeMask(r=dilateMask(r=erodeMask(r,t.width,t.height),t.width,t.height),t.width,t.height)),t};Factory.addGetterSetter(Node,"threshold",0,getNumberValidator(),Factory.afterSetFilter);
