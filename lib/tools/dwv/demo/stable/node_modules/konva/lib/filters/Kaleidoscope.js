import{Factory}from"../Factory.js";import{Node}from"../Node.js";import{Util}from"../Util.js";import{getNumberValidator}from"../Validators.js";var ToPolar=function(a,t,r){var o,e,d,l,i=a.data,h=t.data,f=a.width,n=a.height,s=r.polarCenterX||f/2,M=r.polarCenterY||n/2,p=0,c=0,m=0,g=0,v=Math.sqrt(s*s+M*M);e=f-s,d=n-M,v=(l=Math.sqrt(e*e+d*d))>v?l:v;var F,u,C,P,w=n,N=f,y=360/N*Math.PI/180;for(u=0;u<N;u+=1)for(C=Math.sin(u*y),P=Math.cos(u*y),F=0;F<w;F+=1)e=Math.floor(s+v*F/w*P),p=i[(o=4*((d=Math.floor(M+v*F/w*C))*f+e))+0],c=i[o+1],m=i[o+2],g=i[o+3],h[(o=4*(u+F*f))+0]=p,h[o+1]=c,h[o+2]=m,h[o+3]=g},FromPolar=function(a,t,r){var o,e,d,l,i,h,f=a.data,n=t.data,s=a.width,M=a.height,p=r.polarCenterX||s/2,c=r.polarCenterY||M/2,m=0,g=0,v=0,F=0,u=Math.sqrt(p*p+c*c);e=s-p,d=M-c,u=(h=Math.sqrt(e*e+d*d))>u?h:u;var C,P,w,N=M,y=s,q=r.polarRotation||0;for(e=0;e<s;e+=1)for(d=0;d<M;d+=1)l=e-p,i=d-c,C=Math.sqrt(l*l+i*i)*N/u,P=(P=(180*Math.atan2(i,l)/Math.PI+360+q)%360)*y/360,w=Math.floor(P),m=f[(o=4*(Math.floor(C)*s+w))+0],g=f[o+1],v=f[o+2],F=f[o+3],n[(o=4*(d*s+e))+0]=m,n[o+1]=g,n[o+2]=v,n[o+3]=F};export const Kaleidoscope=function(a){var t,r,o,e,d,l,i,h,f,n=a.width,s=a.height,M=Math.round(this.kaleidoscopePower()),p=Math.round(this.kaleidoscopeAngle()),c=Math.floor(n*(p%360)/360);if(!(M<1)){var m=Util.createCanvasElement();m.width=n,m.height=s;var g=m.getContext("2d").getImageData(0,0,n,s);Util.releaseCanvas(m),ToPolar(a,g,{polarCenterX:n/2,polarCenterY:s/2});for(var v=n/Math.pow(2,M);v<=8;)v*=2,M-=1;var F=v=Math.ceil(v),u=0,C=F,P=1;for(c+v>n&&(u=F,C=0,P=-1),r=0;r<s;r+=1)for(t=u;t!==C;t+=P)h=4*(n*r+Math.round(t+c)%n),e=g.data[h+0],d=g.data[h+1],l=g.data[h+2],i=g.data[h+3],f=4*(n*r+t),g.data[f+0]=e,g.data[f+1]=d,g.data[f+2]=l,g.data[f+3]=i;for(r=0;r<s;r+=1)for(F=Math.floor(v),o=0;o<M;o+=1){for(t=0;t<F+1;t+=1)h=4*(n*r+t),e=g.data[h+0],d=g.data[h+1],l=g.data[h+2],i=g.data[h+3],f=4*(n*r+2*F-t-1),g.data[f+0]=e,g.data[f+1]=d,g.data[f+2]=l,g.data[f+3]=i;F*=2}FromPolar(g,a,{polarRotation:0})}};Factory.addGetterSetter(Node,"kaleidoscopePower",2,getNumberValidator(),Factory.afterSetFilter),Factory.addGetterSetter(Node,"kaleidoscopeAngle",0,getNumberValidator(),Factory.afterSetFilter);
