import{Util,Transform}from"../Util.js";import{Factory}from"../Factory.js";import{Node}from"../Node.js";import{Shape}from"../Shape.js";import{Rect}from"./Rect.js";import{Group}from"../Group.js";import{Konva}from"../Global.js";import{getBooleanValidator,getNumberValidator}from"../Validators.js";import{_registerNode}from"../Global.js";var EVENTS_NAME="tr-konva",ATTR_CHANGE_LIST=["resizeEnabledChange","rotateAnchorOffsetChange","rotateEnabledChange","enabledAnchorsChange","anchorSizeChange","borderEnabledChange","borderStrokeChange","borderStrokeWidthChange","borderDashChange","anchorStrokeChange","anchorStrokeWidthChange","anchorFillChange","anchorCornerRadiusChange","ignoreStrokeChange"].map((t=>t+`.${EVENTS_NAME}`)).join(" "),NODES_RECT="nodesRect",TRANSFORM_CHANGE_STR=["widthChange","heightChange","scaleXChange","scaleYChange","skewXChange","skewYChange","rotationChange","offsetXChange","offsetYChange","transformsEnabledChange","strokeWidthChange"],ANGLES={"top-left":-45,"top-center":0,"top-right":45,"middle-right":-90,"middle-left":90,"bottom-left":-135,"bottom-center":180,"bottom-right":135};const TOUCH_DEVICE="ontouchstart"in Konva._global;function getCursor(t,e){if("rotater"===t)return"crosshair";e+=Util.degToRad(ANGLES[t]||0);var o=(Util.radToDeg(e)%360+360)%360;return Util._inRange(o,337.5,360)||Util._inRange(o,0,22.5)?"ns-resize":Util._inRange(o,22.5,67.5)?"nesw-resize":Util._inRange(o,67.5,112.5)?"ew-resize":Util._inRange(o,112.5,157.5)?"nwse-resize":Util._inRange(o,157.5,202.5)?"ns-resize":Util._inRange(o,202.5,247.5)?"nesw-resize":Util._inRange(o,247.5,292.5)?"ew-resize":Util._inRange(o,292.5,337.5)?"nwse-resize":(Util.error("Transformer has unknown angle for cursor detection: "+o),"pointer")}var ANCHORS_NAMES=["top-left","top-center","top-right","middle-right","middle-left","bottom-left","bottom-center","bottom-right"],MAX_SAFE_INTEGER=1e8;function getCenter(t){return{x:t.x+t.width/2*Math.cos(t.rotation)+t.height/2*Math.sin(-t.rotation),y:t.y+t.height/2*Math.cos(t.rotation)+t.width/2*Math.sin(t.rotation)}}function rotateAroundPoint(t,e,o){const i=o.x+(t.x-o.x)*Math.cos(e)-(t.y-o.y)*Math.sin(e),r=o.y+(t.x-o.x)*Math.sin(e)+(t.y-o.y)*Math.cos(e);return Object.assign(Object.assign({},t),{rotation:t.rotation+e,x:i,y:r})}function rotateAroundCenter(t,e){return rotateAroundPoint(t,e,getCenter(t))}function getSnap(t,e,o){let i=e;for(let r=0;r<t.length;r++){const n=Konva.getAngle(t[r]),a=Math.abs(n-e)%(2*Math.PI);Math.min(a,2*Math.PI-a)<o&&(i=n)}return i}export class Transformer extends Group{constructor(t){super(t),this._transforming=!1,this._createElements(),this._handleMouseMove=this._handleMouseMove.bind(this),this._handleMouseUp=this._handleMouseUp.bind(this),this.update=this.update.bind(this),this.on(ATTR_CHANGE_LIST,this.update),this.getNode()&&this.update()}attachTo(t){return this.setNode(t),this}setNode(t){return Util.warn("tr.setNode(shape), tr.node(shape) and tr.attachTo(shape) methods are deprecated. Please use tr.nodes(nodesArray) instead."),this.setNodes([t])}getNode(){return this._nodes&&this._nodes[0]}_getEventNamespace(){return EVENTS_NAME+this._id}setNodes(t=[]){this._nodes&&this._nodes.length&&this.detach();const e=t.filter((t=>!t.isAncestorOf(this)||(Util.error("Konva.Transformer cannot be an a child of the node you are trying to attach"),!1)));return this._nodes=t=e,1===t.length&&this.useSingleNodeRotation()?this.rotation(t[0].getAbsoluteRotation()):this.rotation(0),this._nodes.forEach((t=>{const e=()=>{1===this.nodes().length&&this.useSingleNodeRotation()&&this.rotation(this.nodes()[0].getAbsoluteRotation()),this._resetTransformCache(),this._transforming||this.isDragging()||this.update()},o=t._attrsAffectingSize.map((t=>t+"Change."+this._getEventNamespace())).join(" ");t.on(o,e),t.on(TRANSFORM_CHANGE_STR.map((t=>t+`.${this._getEventNamespace()}`)).join(" "),e),t.on(`absoluteTransformChange.${this._getEventNamespace()}`,e),this._proxyDrag(t)})),this._resetTransformCache(),!!this.findOne(".top-left")&&this.update(),this}_proxyDrag(t){let e;t.on(`dragstart.${this._getEventNamespace()}`,(o=>{e=t.getAbsolutePosition(),this.isDragging()||t===this.findOne(".back")||this.startDrag(o,!1)})),t.on(`dragmove.${this._getEventNamespace()}`,(o=>{if(!e)return;const i=t.getAbsolutePosition(),r=i.x-e.x,n=i.y-e.y;this.nodes().forEach((e=>{if(e===t)return;if(e.isDragging())return;const i=e.getAbsolutePosition();e.setAbsolutePosition({x:i.x+r,y:i.y+n}),e.startDrag(o)})),e=null}))}getNodes(){return this._nodes||[]}getActiveAnchor(){return this._movingAnchorName}detach(){this._nodes&&this._nodes.forEach((t=>{t.off("."+this._getEventNamespace())})),this._nodes=[],this._resetTransformCache()}_resetTransformCache(){this._clearCache(NODES_RECT),this._clearCache("transform"),this._clearSelfAndDescendantCache("absoluteTransform")}_getNodeRect(){return this._getCache(NODES_RECT,this.__getNodeRect)}__getNodeShape(t,e=this.rotation(),o){var i=t.getClientRect({skipTransform:!0,skipShadow:!0,skipStroke:this.ignoreStroke()}),r=t.getAbsoluteScale(o),n=t.getAbsolutePosition(o),a=i.x*r.x-t.offsetX()*r.x,s=i.y*r.y-t.offsetY()*r.y;const h=(Konva.getAngle(t.getAbsoluteRotation())+2*Math.PI)%(2*Math.PI);return rotateAroundPoint({x:n.x+a*Math.cos(h)+s*Math.sin(-h),y:n.y+s*Math.cos(h)+a*Math.sin(h),width:i.width*r.x,height:i.height*r.y,rotation:h},-Konva.getAngle(e),{x:0,y:0})}__getNodeRect(){if(!this.getNode())return{x:-MAX_SAFE_INTEGER,y:-MAX_SAFE_INTEGER,width:0,height:0,rotation:0};const t=[];this.nodes().map((e=>{const o=e.getClientRect({skipTransform:!0,skipShadow:!0,skipStroke:this.ignoreStroke()});var i=[{x:o.x,y:o.y},{x:o.x+o.width,y:o.y},{x:o.x+o.width,y:o.y+o.height},{x:o.x,y:o.y+o.height}],r=e.getAbsoluteTransform();i.forEach((function(e){var o=r.point(e);t.push(o)}))}));const e=new Transform;var o,i,r,n;e.rotate(-Konva.getAngle(this.rotation())),t.forEach((function(t){var a=e.point(t);void 0===o&&(o=r=a.x,i=n=a.y),o=Math.min(o,a.x),i=Math.min(i,a.y),r=Math.max(r,a.x),n=Math.max(n,a.y)})),e.invert();const a=e.point({x:o,y:i});return{x:a.x,y:a.y,width:r-o,height:n-i,rotation:Konva.getAngle(this.rotation())}}getX(){return this._getNodeRect().x}getY(){return this._getNodeRect().y}getWidth(){return this._getNodeRect().width}getHeight(){return this._getNodeRect().height}_createElements(){this._createBack(),ANCHORS_NAMES.forEach(function(t){this._createAnchor(t)}.bind(this)),this._createAnchor("rotater")}_createAnchor(t){var e=new Rect({stroke:"rgb(0, 161, 255)",fill:"white",strokeWidth:1,name:t+" _anchor",dragDistance:0,draggable:!0,hitStrokeWidth:TOUCH_DEVICE?10:"auto"}),o=this;e.on("mousedown touchstart",(function(t){o._handleMouseDown(t)})),e.on("dragstart",(t=>{e.stopDrag(),t.cancelBubble=!0})),e.on("dragend",(t=>{t.cancelBubble=!0})),e.on("mouseenter",(()=>{var o=Konva.getAngle(this.rotation()),i=getCursor(t,o);e.getStage().content&&(e.getStage().content.style.cursor=i),this._cursorChange=!0})),e.on("mouseout",(()=>{e.getStage().content&&(e.getStage().content.style.cursor=""),this._cursorChange=!1})),this.add(e)}_createBack(){var t=new Shape({name:"back",width:0,height:0,draggable:!0,sceneFunc(t){var e=this.getParent(),o=e.padding();t.beginPath(),t.rect(-o,-o,this.width()+2*o,this.height()+2*o),t.moveTo(this.width()/2,-o),e.rotateEnabled()&&t.lineTo(this.width()/2,-e.rotateAnchorOffset()*Util._sign(this.height())-o),t.fillStrokeShape(this)},hitFunc:(t,e)=>{if(this.shouldOverdrawWholeArea()){var o=this.padding();t.beginPath(),t.rect(-o,-o,e.width()+2*o,e.height()+2*o),t.fillStrokeShape(e)}}});this.add(t),this._proxyDrag(t),t.on("dragstart",(t=>{t.cancelBubble=!0})),t.on("dragmove",(t=>{t.cancelBubble=!0})),t.on("dragend",(t=>{t.cancelBubble=!0})),this.on("dragmove",(t=>{this.update()}))}_handleMouseDown(t){this._movingAnchorName=t.target.name().split(" ")[0];var e=this._getNodeRect(),o=e.width,i=e.height,r=Math.sqrt(Math.pow(o,2)+Math.pow(i,2));this.sin=Math.abs(i/r),this.cos=Math.abs(o/r),"undefined"!=typeof window&&(window.addEventListener("mousemove",this._handleMouseMove),window.addEventListener("touchmove",this._handleMouseMove),window.addEventListener("mouseup",this._handleMouseUp,!0),window.addEventListener("touchend",this._handleMouseUp,!0)),this._transforming=!0;var n=t.target.getAbsolutePosition(),a=t.target.getStage().getPointerPosition();this._anchorDragOffset={x:a.x-n.x,y:a.y-n.y},this._fire("transformstart",{evt:t.evt,target:this.getNode()}),this._nodes.forEach((e=>{e._fire("transformstart",{evt:t.evt,target:e})}))}_handleMouseMove(t){var e,o,i,r=this.findOne("."+this._movingAnchorName),n=r.getStage();n.setPointersPositions(t);const a=n.getPointerPosition();let s={x:a.x-this._anchorDragOffset.x,y:a.y-this._anchorDragOffset.y};const h=r.getAbsolutePosition();this.anchorDragBoundFunc()&&(s=this.anchorDragBoundFunc()(h,s,t)),r.setAbsolutePosition(s);const d=r.getAbsolutePosition();if(h.x!==d.x||h.y!==d.y)if("rotater"!==this._movingAnchorName){var g=this.keepRatio()||t.shiftKey,c=this.centeredScaling()||t.altKey;if("top-left"===this._movingAnchorName){if(g){var f=c?{x:this.width()/2,y:this.height()/2}:{x:this.findOne(".bottom-right").x(),y:this.findOne(".bottom-right").y()};i=Math.sqrt(Math.pow(f.x-r.x(),2)+Math.pow(f.y-r.y(),2));var l=this.findOne(".top-left").x()>f.x?-1:1,m=this.findOne(".top-left").y()>f.y?-1:1;e=i*this.cos*l,o=i*this.sin*m,this.findOne(".top-left").x(f.x-e),this.findOne(".top-left").y(f.y-o)}}else if("top-center"===this._movingAnchorName)this.findOne(".top-left").y(r.y());else if("top-right"===this._movingAnchorName){if(g){f=c?{x:this.width()/2,y:this.height()/2}:{x:this.findOne(".bottom-left").x(),y:this.findOne(".bottom-left").y()};i=Math.sqrt(Math.pow(r.x()-f.x,2)+Math.pow(f.y-r.y(),2));l=this.findOne(".top-right").x()<f.x?-1:1,m=this.findOne(".top-right").y()>f.y?-1:1;e=i*this.cos*l,o=i*this.sin*m,this.findOne(".top-right").x(f.x+e),this.findOne(".top-right").y(f.y-o)}var u=r.position();this.findOne(".top-left").y(u.y),this.findOne(".bottom-right").x(u.x)}else if("middle-left"===this._movingAnchorName)this.findOne(".top-left").x(r.x());else if("middle-right"===this._movingAnchorName)this.findOne(".bottom-right").x(r.x());else if("bottom-left"===this._movingAnchorName){if(g){f=c?{x:this.width()/2,y:this.height()/2}:{x:this.findOne(".top-right").x(),y:this.findOne(".top-right").y()};i=Math.sqrt(Math.pow(f.x-r.x(),2)+Math.pow(r.y()-f.y,2));l=f.x<r.x()?-1:1,m=r.y()<f.y?-1:1;e=i*this.cos*l,o=i*this.sin*m,r.x(f.x-e),r.y(f.y+o)}u=r.position(),this.findOne(".top-left").x(u.x),this.findOne(".bottom-right").y(u.y)}else if("bottom-center"===this._movingAnchorName)this.findOne(".bottom-right").y(r.y());else if("bottom-right"===this._movingAnchorName){if(g){f=c?{x:this.width()/2,y:this.height()/2}:{x:this.findOne(".top-left").x(),y:this.findOne(".top-left").y()};i=Math.sqrt(Math.pow(r.x()-f.x,2)+Math.pow(r.y()-f.y,2));l=this.findOne(".bottom-right").x()<f.x?-1:1,m=this.findOne(".bottom-right").y()<f.y?-1:1;e=i*this.cos*l,o=i*this.sin*m,this.findOne(".bottom-right").x(f.x+e),this.findOne(".bottom-right").y(f.y+o)}}else console.error(new Error("Wrong position argument of selection resizer: "+this._movingAnchorName));if(c=this.centeredScaling()||t.altKey){var _=this.findOne(".top-left"),y=this.findOne(".bottom-right"),p=_.x(),b=_.y(),v=this.getWidth()-y.x(),x=this.getHeight()-y.y();y.move({x:-p,y:-b}),_.move({x:v,y:x})}var A=this.findOne(".top-left").getAbsolutePosition();e=A.x,o=A.y;var N=this.findOne(".bottom-right").x()-this.findOne(".top-left").x(),S=this.findOne(".bottom-right").y()-this.findOne(".top-left").y();this._fitNodesInto({x:e,y:o,width:N,height:S,rotation:Konva.getAngle(this.rotation())},t)}else{var w=this._getNodeRect();e=r.x()-w.width/2,o=-r.y()+w.height/2;let i=Math.atan2(-o,e)+Math.PI/2;w.height<0&&(i-=Math.PI);const n=Konva.getAngle(this.rotation())+i,a=Konva.getAngle(this.rotationSnapTolerance()),s=rotateAroundCenter(w,getSnap(this.rotationSnaps(),n,a)-w.rotation);this._fitNodesInto(s,t)}}_handleMouseUp(t){this._removeEvents(t)}getAbsoluteTransform(){return this.getTransform()}_removeEvents(t){if(this._transforming){this._transforming=!1,"undefined"!=typeof window&&(window.removeEventListener("mousemove",this._handleMouseMove),window.removeEventListener("touchmove",this._handleMouseMove),window.removeEventListener("mouseup",this._handleMouseUp,!0),window.removeEventListener("touchend",this._handleMouseUp,!0));var e=this.getNode();this._fire("transformend",{evt:t,target:e}),e&&this._nodes.forEach((e=>{e._fire("transformend",{evt:t,target:e})})),this._movingAnchorName=null}}_fitNodesInto(t,e){var o=this._getNodeRect();if(Util._inRange(t.width,2*-this.padding()-1,1))return void this.update();if(Util._inRange(t.height,2*-this.padding()-1,1))return void this.update();const i=this.flipEnabled();var r=new Transform;if(r.rotate(Konva.getAngle(this.rotation())),this._movingAnchorName&&t.width<0&&this._movingAnchorName.indexOf("left")>=0){const e=r.point({x:2*-this.padding(),y:0});if(t.x+=e.x,t.y+=e.y,t.width+=2*this.padding(),this._movingAnchorName=this._movingAnchorName.replace("left","right"),this._anchorDragOffset.x-=e.x,this._anchorDragOffset.y-=e.y,!i)return void this.update()}else if(this._movingAnchorName&&t.width<0&&this._movingAnchorName.indexOf("right")>=0){const e=r.point({x:2*this.padding(),y:0});if(this._movingAnchorName=this._movingAnchorName.replace("right","left"),this._anchorDragOffset.x-=e.x,this._anchorDragOffset.y-=e.y,t.width+=2*this.padding(),!i)return void this.update()}if(this._movingAnchorName&&t.height<0&&this._movingAnchorName.indexOf("top")>=0){const e=r.point({x:0,y:2*-this.padding()});if(t.x+=e.x,t.y+=e.y,this._movingAnchorName=this._movingAnchorName.replace("top","bottom"),this._anchorDragOffset.x-=e.x,this._anchorDragOffset.y-=e.y,t.height+=2*this.padding(),!i)return void this.update()}else if(this._movingAnchorName&&t.height<0&&this._movingAnchorName.indexOf("bottom")>=0){const e=r.point({x:0,y:2*this.padding()});if(this._movingAnchorName=this._movingAnchorName.replace("bottom","top"),this._anchorDragOffset.x-=e.x,this._anchorDragOffset.y-=e.y,t.height+=2*this.padding(),!i)return void this.update()}if(this.boundBoxFunc()){const e=this.boundBoxFunc()(o,t);e?t=e:Util.warn("boundBoxFunc returned falsy. You should return new bound rect from it!")}const n=1e7,a=new Transform;a.translate(o.x,o.y),a.rotate(o.rotation),a.scale(o.width/n,o.height/n);const s=new Transform;s.translate(t.x,t.y),s.rotate(t.rotation),s.scale(t.width/n,t.height/n);const h=s.multiply(a.invert());this._nodes.forEach((t=>{var o;const i=t.getParent().getAbsoluteTransform(),r=t.getTransform().copy();r.translate(t.offsetX(),t.offsetY());const n=new Transform;n.multiply(i.copy().invert()).multiply(h).multiply(i).multiply(r);const a=n.decompose();t.setAttrs(a),this._fire("transform",{evt:e,target:t}),t._fire("transform",{evt:e,target:t}),null===(o=t.getLayer())||void 0===o||o.batchDraw()})),this.rotation(Util._getRotation(t.rotation)),this._resetTransformCache(),this.update(),this.getLayer().batchDraw()}forceUpdate(){this._resetTransformCache(),this.update()}_batchChangeChild(t,e){this.findOne(t).setAttrs(e)}update(){var t,e=this._getNodeRect();this.rotation(Util._getRotation(e.rotation));var o=e.width,i=e.height,r=this.enabledAnchors(),n=this.resizeEnabled(),a=this.padding(),s=this.anchorSize();this.find("._anchor").forEach((t=>{t.setAttrs({width:s,height:s,offsetX:s/2,offsetY:s/2,stroke:this.anchorStroke(),strokeWidth:this.anchorStrokeWidth(),fill:this.anchorFill(),cornerRadius:this.anchorCornerRadius()})})),this._batchChangeChild(".top-left",{x:0,y:0,offsetX:s/2+a,offsetY:s/2+a,visible:n&&r.indexOf("top-left")>=0}),this._batchChangeChild(".top-center",{x:o/2,y:0,offsetY:s/2+a,visible:n&&r.indexOf("top-center")>=0}),this._batchChangeChild(".top-right",{x:o,y:0,offsetX:s/2-a,offsetY:s/2+a,visible:n&&r.indexOf("top-right")>=0}),this._batchChangeChild(".middle-left",{x:0,y:i/2,offsetX:s/2+a,visible:n&&r.indexOf("middle-left")>=0}),this._batchChangeChild(".middle-right",{x:o,y:i/2,offsetX:s/2-a,visible:n&&r.indexOf("middle-right")>=0}),this._batchChangeChild(".bottom-left",{x:0,y:i,offsetX:s/2+a,offsetY:s/2-a,visible:n&&r.indexOf("bottom-left")>=0}),this._batchChangeChild(".bottom-center",{x:o/2,y:i,offsetY:s/2-a,visible:n&&r.indexOf("bottom-center")>=0}),this._batchChangeChild(".bottom-right",{x:o,y:i,offsetX:s/2-a,offsetY:s/2-a,visible:n&&r.indexOf("bottom-right")>=0}),this._batchChangeChild(".rotater",{x:o/2,y:-this.rotateAnchorOffset()*Util._sign(i)-a,visible:this.rotateEnabled()}),this._batchChangeChild(".back",{width:o,height:i,visible:this.borderEnabled(),stroke:this.borderStroke(),strokeWidth:this.borderStrokeWidth(),dash:this.borderDash(),x:0,y:0}),null===(t=this.getLayer())||void 0===t||t.batchDraw()}isTransforming(){return this._transforming}stopTransform(){if(this._transforming){this._removeEvents();var t=this.findOne("."+this._movingAnchorName);t&&t.stopDrag()}}destroy(){return this.getStage()&&this._cursorChange&&this.getStage().content&&(this.getStage().content.style.cursor=""),Group.prototype.destroy.call(this),this.detach(),this._removeEvents(),this}toObject(){return Node.prototype.toObject.call(this)}clone(t){return Node.prototype.clone.call(this,t)}getClientRect(){return this.nodes().length>0?super.getClientRect():{x:0,y:0,width:0,height:0}}}function validateAnchors(t){return t instanceof Array||Util.warn("enabledAnchors value should be an array"),t instanceof Array&&t.forEach((function(t){-1===ANCHORS_NAMES.indexOf(t)&&Util.warn("Unknown anchor name: "+t+". Available names are: "+ANCHORS_NAMES.join(", "))})),t||[]}Transformer.prototype.className="Transformer",_registerNode(Transformer),Factory.addGetterSetter(Transformer,"enabledAnchors",ANCHORS_NAMES,validateAnchors),Factory.addGetterSetter(Transformer,"flipEnabled",!0,getBooleanValidator()),Factory.addGetterSetter(Transformer,"resizeEnabled",!0),Factory.addGetterSetter(Transformer,"anchorSize",10,getNumberValidator()),Factory.addGetterSetter(Transformer,"rotateEnabled",!0),Factory.addGetterSetter(Transformer,"rotationSnaps",[]),Factory.addGetterSetter(Transformer,"rotateAnchorOffset",50,getNumberValidator()),Factory.addGetterSetter(Transformer,"rotationSnapTolerance",5,getNumberValidator()),Factory.addGetterSetter(Transformer,"borderEnabled",!0),Factory.addGetterSetter(Transformer,"anchorStroke","rgb(0, 161, 255)"),Factory.addGetterSetter(Transformer,"anchorStrokeWidth",1,getNumberValidator()),Factory.addGetterSetter(Transformer,"anchorFill","white"),Factory.addGetterSetter(Transformer,"anchorCornerRadius",0,getNumberValidator()),Factory.addGetterSetter(Transformer,"borderStroke","rgb(0, 161, 255)"),Factory.addGetterSetter(Transformer,"borderStrokeWidth",1,getNumberValidator()),Factory.addGetterSetter(Transformer,"borderDash"),Factory.addGetterSetter(Transformer,"keepRatio",!0),Factory.addGetterSetter(Transformer,"centeredScaling",!1),Factory.addGetterSetter(Transformer,"ignoreStroke",!1),Factory.addGetterSetter(Transformer,"padding",0,getNumberValidator()),Factory.addGetterSetter(Transformer,"node"),Factory.addGetterSetter(Transformer,"nodes"),Factory.addGetterSetter(Transformer,"boundBoxFunc"),Factory.addGetterSetter(Transformer,"anchorDragBoundFunc"),Factory.addGetterSetter(Transformer,"shouldOverdrawWholeArea",!1),Factory.addGetterSetter(Transformer,"useSingleNodeRotation",!0),Factory.backCompat(Transformer,{lineEnabled:"borderEnabled",rotateHandlerOffset:"rotateAnchorOffset",enabledHandlers:"enabledAnchors"});
