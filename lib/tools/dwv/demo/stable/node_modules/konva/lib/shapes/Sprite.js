import{Factory}from"../Factory.js";import{Shape}from"../Shape.js";import{Animation}from"../Animation.js";import{getNumberValidator}from"../Validators.js";import{_registerNode}from"../Global.js";export class Sprite extends Shape{constructor(t){super(t),this._updated=!0,this.anim=new Animation((()=>{var t=this._updated;return this._updated=!1,t})),this.on("animationChange.konva",(function(){this.frameIndex(0)})),this.on("frameIndexChange.konva",(function(){this._updated=!0})),this.on("frameRateChange.konva",(function(){this.anim.isRunning()&&(clearInterval(this.interval),this._setInterval())}))}_sceneFunc(t){var e=this.animation(),a=this.frameIndex(),i=4*a,r=this.animations()[e],n=this.frameOffsets(),s=r[i+0],o=r[i+1],h=r[i+2],m=r[i+3],d=this.image();if((this.hasFill()||this.hasStroke())&&(t.beginPath(),t.rect(0,0,h,m),t.closePath(),t.fillStrokeShape(this)),d)if(n){var f=n[e],p=2*a;t.drawImage(d,s,o,h,m,f[p+0],f[p+1],h,m)}else t.drawImage(d,s,o,h,m,0,0,h,m)}_hitFunc(t){var e=this.animation(),a=this.frameIndex(),i=4*a,r=this.animations()[e],n=this.frameOffsets(),s=r[i+2],o=r[i+3];if(t.beginPath(),n){var h=n[e],m=2*a;t.rect(h[m+0],h[m+1],s,o)}else t.rect(0,0,s,o);t.closePath(),t.fillShape(this)}_useBufferCanvas(){return super._useBufferCanvas(!0)}_setInterval(){var t=this;this.interval=setInterval((function(){t._updateIndex()}),1e3/this.frameRate())}start(){if(!this.isRunning()){var t=this.getLayer();this.anim.setLayers(t),this._setInterval(),this.anim.start()}}stop(){this.anim.stop(),clearInterval(this.interval)}isRunning(){return this.anim.isRunning()}_updateIndex(){var t=this.frameIndex(),e=this.animation();t<this.animations()[e].length/4-1?this.frameIndex(t+1):this.frameIndex(0)}}Sprite.prototype.className="Sprite",_registerNode(Sprite),Factory.addGetterSetter(Sprite,"animation"),Factory.addGetterSetter(Sprite,"animations"),Factory.addGetterSetter(Sprite,"frameOffsets"),Factory.addGetterSetter(Sprite,"image"),Factory.addGetterSetter(Sprite,"frameIndex",0,getNumberValidator()),Factory.addGetterSetter(Sprite,"frameRate",17,getNumberValidator()),Factory.backCompat(Sprite,{index:"frameIndex",getIndex:"getFrameIndex",setIndex:"setFrameIndex"});
