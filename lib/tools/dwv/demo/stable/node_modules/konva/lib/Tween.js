import{Util}from"./Util.js";import{Animation}from"./Animation.js";import{Node}from"./Node.js";import{Konva}from"./Global.js";var blacklist={node:1,duration:1,easing:1,onFinish:1,yoyo:1},PAUSED=1,PLAYING=2,REVERSING=3,idCounter=0,colorAttrs=["fill","stroke","shadowColor"];class TweenEngine{constructor(t,e,i,s,n,r,a){this.prop=t,this.propFunc=e,this.begin=s,this._pos=s,this.duration=r,this._change=0,this.prevPos=0,this.yoyo=a,this._time=0,this._position=0,this._startTime=0,this._finish=0,this.func=i,this._change=n-this.begin,this.pause()}fire(t){var e=this[t];e&&e()}setTime(t){t>this.duration?this.yoyo?(this._time=this.duration,this.reverse()):this.finish():t<0?this.yoyo?(this._time=0,this.play()):this.reset():(this._time=t,this.update())}getTime(){return this._time}setPosition(t){this.prevPos=this._pos,this.propFunc(t),this._pos=t}getPosition(t){return void 0===t&&(t=this._time),this.func(t,this.begin,this._change,this.duration)}play(){this.state=PLAYING,this._startTime=this.getTimer()-this._time,this.onEnterFrame(),this.fire("onPlay")}reverse(){this.state=REVERSING,this._time=this.duration-this._time,this._startTime=this.getTimer()-this._time,this.onEnterFrame(),this.fire("onReverse")}seek(t){this.pause(),this._time=t,this.update(),this.fire("onSeek")}reset(){this.pause(),this._time=0,this.update(),this.fire("onReset")}finish(){this.pause(),this._time=this.duration,this.update(),this.fire("onFinish")}update(){this.setPosition(this.getPosition(this._time)),this.fire("onUpdate")}onEnterFrame(){var t=this.getTimer()-this._startTime;this.state===PLAYING?this.setTime(t):this.state===REVERSING&&this.setTime(this.duration-t)}pause(){this.state=PAUSED,this.fire("onPause")}getTimer(){return(new Date).getTime()}}export class Tween{constructor(t){var e,i,s=this,n=t.node,r=n._id,a=t.easing||Easings.Linear,h=!!t.yoyo;e=void 0===t.duration?.3:0===t.duration?.001:t.duration,this.node=n,this._id=idCounter++;var o=n.getLayer()||(n instanceof Konva.Stage?n.getLayers():null);for(i in o||Util.error("Tween constructor have `node` that is not in a layer. Please add node into layer first."),this.anim=new Animation((function(){s.tween.onEnterFrame()}),o),this.tween=new TweenEngine(i,(function(t){s._tweenFunc(t)}),a,0,1,1e3*e,h),this._addListeners(),Tween.attrs[r]||(Tween.attrs[r]={}),Tween.attrs[r][this._id]||(Tween.attrs[r][this._id]={}),Tween.tweens[r]||(Tween.tweens[r]={}),t)void 0===blacklist[i]&&this._addAttr(i,t[i]);this.reset(),this.onFinish=t.onFinish,this.onReset=t.onReset,this.onUpdate=t.onUpdate}_addAttr(t,e){var i,s,n,r,a,h,o,u,d=this.node,l=d._id;if((n=Tween.tweens[l][t])&&delete Tween.attrs[l][n][t],i=d.getAttr(t),Util._isArray(e))if(s=[],a=Math.max(e.length,i.length),"points"===t&&e.length!==i.length&&(e.length>i.length?(o=i,i=Util._prepareArrayForTween(i,e,d.closed())):(h=e,e=Util._prepareArrayForTween(e,i,d.closed()))),0===t.indexOf("fill"))for(r=0;r<a;r++)if(r%2==0)s.push(e[r]-i[r]);else{var p=Util.colorToRGBA(i[r]);u=Util.colorToRGBA(e[r]),i[r]=p,s.push({r:u.r-p.r,g:u.g-p.g,b:u.b-p.b,a:u.a-p.a})}else for(r=0;r<a;r++)s.push(e[r]-i[r]);else-1!==colorAttrs.indexOf(t)?(i=Util.colorToRGBA(i),s={r:(u=Util.colorToRGBA(e)).r-i.r,g:u.g-i.g,b:u.b-i.b,a:u.a-i.a}):s=e-i;Tween.attrs[l][this._id][t]={start:i,diff:s,end:e,trueEnd:h,trueStart:o},Tween.tweens[l][t]=this._id}_tweenFunc(t){var e,i,s,n,r,a,h,o,u=this.node,d=Tween.attrs[u._id][this._id];for(e in d){if(s=(i=d[e]).start,n=i.diff,o=i.end,Util._isArray(s))if(r=[],h=Math.max(s.length,o.length),0===e.indexOf("fill"))for(a=0;a<h;a++)a%2==0?r.push((s[a]||0)+n[a]*t):r.push("rgba("+Math.round(s[a].r+n[a].r*t)+","+Math.round(s[a].g+n[a].g*t)+","+Math.round(s[a].b+n[a].b*t)+","+(s[a].a+n[a].a*t)+")");else for(a=0;a<h;a++)r.push((s[a]||0)+n[a]*t);else r=-1!==colorAttrs.indexOf(e)?"rgba("+Math.round(s.r+n.r*t)+","+Math.round(s.g+n.g*t)+","+Math.round(s.b+n.b*t)+","+(s.a+n.a*t)+")":s+n*t;u.setAttr(e,r)}}_addListeners(){this.tween.onPlay=()=>{this.anim.start()},this.tween.onReverse=()=>{this.anim.start()},this.tween.onPause=()=>{this.anim.stop()},this.tween.onFinish=()=>{var t=this.node,e=Tween.attrs[t._id][this._id];e.points&&e.points.trueEnd&&t.setAttr("points",e.points.trueEnd),this.onFinish&&this.onFinish.call(this)},this.tween.onReset=()=>{var t=this.node,e=Tween.attrs[t._id][this._id];e.points&&e.points.trueStart&&t.points(e.points.trueStart),this.onReset&&this.onReset()},this.tween.onUpdate=()=>{this.onUpdate&&this.onUpdate.call(this)}}play(){return this.tween.play(),this}reverse(){return this.tween.reverse(),this}reset(){return this.tween.reset(),this}seek(t){return this.tween.seek(1e3*t),this}pause(){return this.tween.pause(),this}finish(){return this.tween.finish(),this}destroy(){var t,e=this.node._id,i=this._id,s=Tween.tweens[e];for(t in this.pause(),s)delete Tween.tweens[e][t];delete Tween.attrs[e][i]}}Tween.attrs={},Tween.tweens={},Node.prototype.to=function(t){var e=t.onFinish;t.node=this,t.onFinish=function(){this.destroy(),e&&e()},new Tween(t).play()};export const Easings={BackEaseIn(t,e,i,s){var n=1.70158;return i*(t/=s)*t*((n+1)*t-n)+e},BackEaseOut(t,e,i,s){var n=1.70158;return i*((t=t/s-1)*t*((n+1)*t+n)+1)+e},BackEaseInOut(t,e,i,s){var n=1.70158;return(t/=s/2)<1?i/2*(t*t*((1+(n*=1.525))*t-n))+e:i/2*((t-=2)*t*((1+(n*=1.525))*t+n)+2)+e},ElasticEaseIn(t,e,i,s,n,r){var a=0;return 0===t?e:1==(t/=s)?e+i:(r||(r=.3*s),!n||n<Math.abs(i)?(n=i,a=r/4):a=r/(2*Math.PI)*Math.asin(i/n),-n*Math.pow(2,10*(t-=1))*Math.sin((t*s-a)*(2*Math.PI)/r)+e)},ElasticEaseOut(t,e,i,s,n,r){var a=0;return 0===t?e:1==(t/=s)?e+i:(r||(r=.3*s),!n||n<Math.abs(i)?(n=i,a=r/4):a=r/(2*Math.PI)*Math.asin(i/n),n*Math.pow(2,-10*t)*Math.sin((t*s-a)*(2*Math.PI)/r)+i+e)},ElasticEaseInOut(t,e,i,s,n,r){var a=0;return 0===t?e:2==(t/=s/2)?e+i:(r||(r=s*(.3*1.5)),!n||n<Math.abs(i)?(n=i,a=r/4):a=r/(2*Math.PI)*Math.asin(i/n),t<1?n*Math.pow(2,10*(t-=1))*Math.sin((t*s-a)*(2*Math.PI)/r)*-.5+e:n*Math.pow(2,-10*(t-=1))*Math.sin((t*s-a)*(2*Math.PI)/r)*.5+i+e)},BounceEaseOut:(t,e,i,s)=>(t/=s)<1/2.75?i*(7.5625*t*t)+e:t<2/2.75?i*(7.5625*(t-=1.5/2.75)*t+.75)+e:t<2.5/2.75?i*(7.5625*(t-=2.25/2.75)*t+.9375)+e:i*(7.5625*(t-=2.625/2.75)*t+.984375)+e,BounceEaseIn:(t,e,i,s)=>i-Easings.BounceEaseOut(s-t,0,i,s)+e,BounceEaseInOut:(t,e,i,s)=>t<s/2?.5*Easings.BounceEaseIn(2*t,0,i,s)+e:.5*Easings.BounceEaseOut(2*t-s,0,i,s)+.5*i+e,EaseIn:(t,e,i,s)=>i*(t/=s)*t+e,EaseOut:(t,e,i,s)=>-i*(t/=s)*(t-2)+e,EaseInOut:(t,e,i,s)=>(t/=s/2)<1?i/2*t*t+e:-i/2*(--t*(t-2)-1)+e,StrongEaseIn:(t,e,i,s)=>i*(t/=s)*t*t*t*t+e,StrongEaseOut:(t,e,i,s)=>i*((t=t/s-1)*t*t*t*t+1)+e,StrongEaseInOut:(t,e,i,s)=>(t/=s/2)<1?i/2*t*t*t*t*t+e:i/2*((t-=2)*t*t*t*t+2)+e,Linear:(t,e,i,s)=>i*t/s+e};
