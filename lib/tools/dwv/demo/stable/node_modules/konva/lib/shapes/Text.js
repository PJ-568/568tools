import{Util}from"../Util.js";import{Factory}from"../Factory.js";import{Shape}from"../Shape.js";import{getNumberValidator,getStringValidator,getNumberOrAutoValidator,getBooleanValidator}from"../Validators.js";import{_registerNode}from"../Global.js";export function stringToArray(t){return Array.from(t)}var dummyContext,AUTO="auto",CENTER="center",JUSTIFY="justify",CHANGE_KONVA="Change.konva",CONTEXT_2D="2d",DASH="-",LEFT="left",TEXT="text",TEXT_UPPER="Text",TOP="top",BOTTOM="bottom",MIDDLE="middle",NORMAL="normal",PX_SPACE="px ",SPACE=" ",RIGHT="right",WORD="word",CHAR="char",NONE="none",ELLIPSIS="â€¦",ATTR_CHANGE_LIST=["fontFamily","fontSize","fontStyle","fontVariant","padding","align","verticalAlign","lineHeight","text","width","height","wrap","ellipsis","letterSpacing"],attrChangeListLen=ATTR_CHANGE_LIST.length;function normalizeFontFamily(t){return t.split(",").map((t=>{const e=(t=t.trim()).indexOf(" ")>=0,i=t.indexOf('"')>=0||t.indexOf("'")>=0;return e&&!i&&(t=`"${t}"`),t})).join(", ")}function getDummyContext(){return dummyContext||(dummyContext=Util.createCanvasElement().getContext(CONTEXT_2D))}function _fillFunc(t){t.fillText(this._partialText,this._partialTextX,this._partialTextY)}function _strokeFunc(t){t.strokeText(this._partialText,this._partialTextX,this._partialTextY)}function checkDefaultFill(t){return(t=t||{}).fillLinearGradientColorStops||t.fillRadialGradientColorStops||t.fillPatternImage||(t.fill=t.fill||"black"),t}export class Text extends Shape{constructor(t){super(checkDefaultFill(t)),this._partialTextX=0,this._partialTextY=0;for(var e=0;e<attrChangeListLen;e++)this.on(ATTR_CHANGE_LIST[e]+CHANGE_KONVA,this._setTextData);this._setTextData()}_sceneFunc(t){var e=this.textArr,i=e.length;if(this.text()){var r,a=this.padding(),h=this.fontSize(),s=this.lineHeight()*h,n=this.verticalAlign(),l=0,o=this.align(),d=this.getWidth(),g=this.letterSpacing(),x=this.fill(),T=this.textDecoration(),f=-1!==T.indexOf("underline"),p=-1!==T.indexOf("line-through"),S=0,u=(S=s/2,0),_=0;for(t.setAttr("font",this._getContextFont()),t.setAttr("textBaseline",MIDDLE),t.setAttr("textAlign",LEFT),n===MIDDLE?l=(this.getHeight()-i*s-2*a)/2:n===BOTTOM&&(l=this.getHeight()-i*s-2*a),t.translate(a,l+a),r=0;r<i;r++){u=0,_=0;var c,A,m,F=e[r],y=F.text,E=F.width,v=F.lastInParagraph;if(t.save(),o===RIGHT?u+=d-E-2*a:o===CENTER&&(u+=(d-E-2*a)/2),f){t.save(),t.beginPath(),t.moveTo(u,S+_+Math.round(h/2)),A=0===(c=y.split(" ").length-1),m=o!==JUSTIFY||v?E:d-2*a,t.lineTo(u+Math.round(m),S+_+Math.round(h/2)),t.lineWidth=h/15;const e=this._getLinearGradient();t.strokeStyle=e||x,t.stroke(),t.restore()}if(p){t.save(),t.beginPath(),t.moveTo(u,S+_),A=0===(c=y.split(" ").length-1),m=o===JUSTIFY&&v&&!A?d-2*a:E,t.lineTo(u+Math.round(m),S+_),t.lineWidth=h/15;const e=this._getLinearGradient();t.strokeStyle=e||x,t.stroke(),t.restore()}if(0!==g||o===JUSTIFY){c=y.split(" ").length-1;for(var L=stringToArray(y),C=0;C<L.length;C++){var O=L[C];" "!==O||v||o!==JUSTIFY||(u+=(d-2*a-E)/c),this._partialTextX=u,this._partialTextY=S+_,this._partialText=O,t.fillStrokeShape(this),u+=this.measureSize(O).width+g}}else this._partialTextX=u,this._partialTextY=S+_,this._partialText=y,t.fillStrokeShape(this);t.restore(),i>1&&(S+=s)}}}_hitFunc(t){var e=this.getWidth(),i=this.getHeight();t.beginPath(),t.rect(0,0,e,i),t.closePath(),t.fillStrokeShape(this)}setText(t){var e=Util._isString(t)?t:null==t?"":t+"";return this._setAttr(TEXT,e),this}getWidth(){return this.attrs.width===AUTO||void 0===this.attrs.width?this.getTextWidth()+2*this.padding():this.attrs.width}getHeight(){return this.attrs.height===AUTO||void 0===this.attrs.height?this.fontSize()*this.textArr.length*this.lineHeight()+2*this.padding():this.attrs.height}getTextWidth(){return this.textWidth}getTextHeight(){return Util.warn("text.getTextHeight() method is deprecated. Use text.height() - for full height and text.fontSize() - for one line height."),this.textHeight}measureSize(t){var e,i=getDummyContext(),r=this.fontSize();return i.save(),i.font=this._getContextFont(),e=i.measureText(t),i.restore(),{width:e.width,height:r}}_getContextFont(){return this.fontStyle()+SPACE+this.fontVariant()+SPACE+(this.fontSize()+PX_SPACE)+normalizeFontFamily(this.fontFamily())}_addTextLine(t){this.align()===JUSTIFY&&(t=t.trim());var e=this._getTextWidth(t);return this.textArr.push({text:t,width:e,lastInParagraph:!1})}_getTextWidth(t){var e=this.letterSpacing(),i=t.length;return getDummyContext().measureText(t).width+(i?e*(i-1):0)}_setTextData(){var t=this.text().split("\n"),e=+this.fontSize(),i=0,r=this.lineHeight()*e,a=this.attrs.width,h=this.attrs.height,s=a!==AUTO&&void 0!==a,n=h!==AUTO&&void 0!==h,l=this.padding(),o=a-2*l,d=h-2*l,g=0,x=this.wrap(),T=x!==CHAR&&x!==NONE,f=this.ellipsis();this.textArr=[],getDummyContext().font=this._getContextFont();for(var p=f?this._getTextWidth(ELLIPSIS):0,S=0,u=t.length;S<u;++S){var _=t[S],c=this._getTextWidth(_);if(s&&c>o)for(;_.length>0;){for(var A=0,m=_.length,F="",y=0;A<m;){var E=A+m>>>1,v=_.slice(0,E+1),L=this._getTextWidth(v)+p;L<=o?(A=E+1,F=v,y=L):m=E}if(!F)break;if(T){var C,O=_[F.length];(C=(O===SPACE||O===DASH)&&y<=o?F.length:Math.max(F.lastIndexOf(SPACE),F.lastIndexOf(DASH))+1)>0&&(A=C,F=F.slice(0,A),y=this._getTextWidth(F))}if(F=F.trimRight(),this._addTextLine(F),i=Math.max(i,y),g+=r,this._shouldHandleEllipsis(g)){this._tryToAddEllipsisToLastLine();break}if((_=(_=_.slice(A)).trimLeft()).length>0&&(c=this._getTextWidth(_))<=o){this._addTextLine(_),g+=r,i=Math.max(i,c);break}}else this._addTextLine(_),g+=r,i=Math.max(i,c),this._shouldHandleEllipsis(g)&&S<u-1&&this._tryToAddEllipsisToLastLine();if(this.textArr[this.textArr.length-1]&&(this.textArr[this.textArr.length-1].lastInParagraph=!0),n&&g+r>d)break}this.textHeight=e,this.textWidth=i}_shouldHandleEllipsis(t){var e=+this.fontSize(),i=this.lineHeight()*e,r=this.attrs.height,a=r!==AUTO&&void 0!==r,h=r-2*this.padding();return!(this.wrap()!==NONE)||a&&t+i>h}_tryToAddEllipsisToLastLine(){var t=this.attrs.width,e=t!==AUTO&&void 0!==t,i=t-2*this.padding(),r=this.ellipsis(),a=this.textArr[this.textArr.length-1];if(a&&r){if(e)this._getTextWidth(a.text+ELLIPSIS)<i||(a.text=a.text.slice(0,a.text.length-3));this.textArr.splice(this.textArr.length-1,1),this._addTextLine(a.text+ELLIPSIS)}}getStrokeScaleEnabled(){return!0}}Text.prototype._fillFunc=_fillFunc,Text.prototype._strokeFunc=_strokeFunc,Text.prototype.className=TEXT_UPPER,Text.prototype._attrsAffectingSize=["text","fontSize","padding","wrap","lineHeight","letterSpacing"],_registerNode(Text),Factory.overWriteSetter(Text,"width",getNumberOrAutoValidator()),Factory.overWriteSetter(Text,"height",getNumberOrAutoValidator()),Factory.addGetterSetter(Text,"fontFamily","Arial"),Factory.addGetterSetter(Text,"fontSize",12,getNumberValidator()),Factory.addGetterSetter(Text,"fontStyle",NORMAL),Factory.addGetterSetter(Text,"fontVariant",NORMAL),Factory.addGetterSetter(Text,"padding",0,getNumberValidator()),Factory.addGetterSetter(Text,"align",LEFT),Factory.addGetterSetter(Text,"verticalAlign",TOP),Factory.addGetterSetter(Text,"lineHeight",1,getNumberValidator()),Factory.addGetterSetter(Text,"wrap",WORD),Factory.addGetterSetter(Text,"ellipsis",!1,getBooleanValidator()),Factory.addGetterSetter(Text,"letterSpacing",0,getNumberValidator()),Factory.addGetterSetter(Text,"text","",getStringValidator()),Factory.addGetterSetter(Text,"textDecoration","");
