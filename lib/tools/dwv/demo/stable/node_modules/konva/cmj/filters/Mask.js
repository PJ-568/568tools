"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Mask=void 0;const Factory_1=require("../Factory"),Node_1=require("../Node"),Validators_1=require("../Validators");function pixelAt(t,r,a){var e=4*(a*t.width+r),o=[];return o.push(t.data[e++],t.data[e++],t.data[e++],t.data[e++]),o}function rgbDistance(t,r){return Math.sqrt(Math.pow(t[0]-r[0],2)+Math.pow(t[1]-r[1],2)+Math.pow(t[2]-r[2],2))}function rgbMean(t){for(var r=[0,0,0],a=0;a<t.length;a++)r[0]+=t[a][0],r[1]+=t[a][1],r[2]+=t[a][2];return r[0]/=t.length,r[1]/=t.length,r[2]/=t.length,r}function backgroundMask(t,r){var a=pixelAt(t,0,0),e=pixelAt(t,t.width-1,0),o=pixelAt(t,0,t.height-1),i=pixelAt(t,t.width-1,t.height-1),h=r||10;if(rgbDistance(a,e)<h&&rgbDistance(e,i)<h&&rgbDistance(i,o)<h&&rgbDistance(o,a)<h){for(var n=rgbMean([e,a,i,o]),d=[],s=0;s<t.width*t.height;s++){var f=rgbDistance(n,[t.data[4*s],t.data[4*s+1],t.data[4*s+2]]);d[s]=f<h?0:255}return d}}function applyMask(t,r){for(var a=0;a<t.width*t.height;a++)t.data[4*a+3]=r[a]}function erodeMask(t,r,a){for(var e=[1,1,1,1,0,1,1,1,1],o=Math.round(Math.sqrt(e.length)),i=Math.floor(o/2),h=[],n=0;n<a;n++)for(var d=0;d<r;d++){for(var s=n*r+d,f=0,u=0;u<o;u++)for(var M=0;M<o;M++){var l=n+u-i,c=d+M-i;if(l>=0&&l<a&&c>=0&&c<r){var g=e[u*o+M];f+=t[l*r+c]*g}}h[s]=2040===f?255:0}return h}function dilateMask(t,r,a){for(var e=[1,1,1,1,1,1,1,1,1],o=Math.round(Math.sqrt(e.length)),i=Math.floor(o/2),h=[],n=0;n<a;n++)for(var d=0;d<r;d++){for(var s=n*r+d,f=0,u=0;u<o;u++)for(var M=0;M<o;M++){var l=n+u-i,c=d+M-i;if(l>=0&&l<a&&c>=0&&c<r){var g=e[u*o+M];f+=t[l*r+c]*g}}h[s]=f>=1020?255:0}return h}function smoothEdgeMask(t,r,a){for(var e=[1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9],o=Math.round(Math.sqrt(e.length)),i=Math.floor(o/2),h=[],n=0;n<a;n++)for(var d=0;d<r;d++){for(var s=n*r+d,f=0,u=0;u<o;u++)for(var M=0;M<o;M++){var l=n+u-i,c=d+M-i;if(l>=0&&l<a&&c>=0&&c<r){var g=e[u*o+M];f+=t[l*r+c]*g}}h[s]=f}return h}const Mask=function(t){var r=backgroundMask(t,this.threshold());return r&&applyMask(t,r=smoothEdgeMask(r=dilateMask(r=erodeMask(r,t.width,t.height),t.width,t.height),t.width,t.height)),t};exports.Mask=Mask,Factory_1.Factory.addGetterSetter(Node_1.Node,"threshold",0,(0,Validators_1.getNumberValidator)(),Factory_1.Factory.afterSetFilter);
