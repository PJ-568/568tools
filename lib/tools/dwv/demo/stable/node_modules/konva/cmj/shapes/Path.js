"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Path=void 0;const Factory_1=require("../Factory"),Shape_1=require("../Shape"),Global_1=require("../Global");class Path extends Shape_1.Shape{constructor(t){super(t),this.dataArray=[],this.pathLength=0,this.dataArray=Path.parsePathData(this.data()),this.pathLength=0;for(var a=0;a<this.dataArray.length;++a)this.pathLength+=this.dataArray[a].pathLength;this.on("dataChange.konva",(function(){this.dataArray=Path.parsePathData(this.data()),this.pathLength=0;for(var t=0;t<this.dataArray.length;++t)this.pathLength+=this.dataArray[t].pathLength}))}_sceneFunc(t){var a=this.dataArray;t.beginPath();for(var e=!1,s=0;s<a.length;s++){var i=a[s].command,r=a[s].points;switch(i){case"L":t.lineTo(r[0],r[1]);break;case"M":t.moveTo(r[0],r[1]);break;case"C":t.bezierCurveTo(r[0],r[1],r[2],r[3],r[4],r[5]);break;case"Q":t.quadraticCurveTo(r[0],r[1],r[2],r[3]);break;case"A":var h=r[0],n=r[1],o=r[2],c=r[3],p=r[4],f=r[5],u=r[6],l=r[7],g=o>c?o:c,d=o>c?1:o/c,P=o>c?c/o:1;t.translate(h,n),t.rotate(u),t.scale(d,P),t.arc(0,0,g,p,p+f,1-l),t.scale(1/d,1/P),t.rotate(-u),t.translate(-h,-n);break;case"z":e=!0,t.closePath()}}e||this.hasFill()?t.fillStrokeShape(this):t.strokeShape(this)}getSelfRect(){var t=[];this.dataArray.forEach((function(a){if("A"===a.command){var e=a.points[4],s=a.points[5],i=a.points[4]+s,r=Math.PI/180;if(Math.abs(e-i)<r&&(r=Math.abs(e-i)),s<0)for(let s=e-r;s>i;s-=r){const e=Path.getPointOnEllipticalArc(a.points[0],a.points[1],a.points[2],a.points[3],s,0);t.push(e.x,e.y)}else for(let s=e+r;s<i;s+=r){const e=Path.getPointOnEllipticalArc(a.points[0],a.points[1],a.points[2],a.points[3],s,0);t.push(e.x,e.y)}}else if("C"===a.command)for(let e=0;e<=1;e+=.01){const s=Path.getPointOnCubicBezier(e,a.start.x,a.start.y,a.points[0],a.points[1],a.points[2],a.points[3],a.points[4],a.points[5]);t.push(s.x,s.y)}else t=t.concat(a.points)}));for(var a,e,s=t[0],i=t[0],r=t[1],h=t[1],n=0;n<t.length/2;n++)a=t[2*n],e=t[2*n+1],isNaN(a)||(s=Math.min(s,a),i=Math.max(i,a)),isNaN(e)||(r=Math.min(r,e),h=Math.max(h,e));return{x:s,y:r,width:i-s,height:h-r}}getLength(){return this.pathLength}getPointAtLength(t){var a,e=0,s=this.dataArray.length;if(!s)return null;for(;e<s&&t>this.dataArray[e].pathLength;)t-=this.dataArray[e].pathLength,++e;if(e===s)return{x:(a=this.dataArray[e-1].points.slice(-2))[0],y:a[1]};if(t<.01)return{x:(a=this.dataArray[e].points.slice(0,2))[0],y:a[1]};var i=this.dataArray[e],r=i.points;switch(i.command){case"L":return Path.getPointOnLine(t,i.start.x,i.start.y,r[0],r[1]);case"C":return Path.getPointOnCubicBezier(t/i.pathLength,i.start.x,i.start.y,r[0],r[1],r[2],r[3],r[4],r[5]);case"Q":return Path.getPointOnQuadraticBezier(t/i.pathLength,i.start.x,i.start.y,r[0],r[1],r[2],r[3]);case"A":var h=r[0],n=r[1],o=r[2],c=r[3],p=r[4],f=r[5],u=r[6];return p+=f*t/i.pathLength,Path.getPointOnEllipticalArc(h,n,o,c,p,u)}return null}static getLineLength(t,a,e,s){return Math.sqrt((e-t)*(e-t)+(s-a)*(s-a))}static getPointOnLine(t,a,e,s,i,r,h){void 0===r&&(r=a),void 0===h&&(h=e);var n=(i-e)/(s-a+1e-8),o=Math.sqrt(t*t/(1+n*n));s<a&&(o*=-1);var c,p=n*o;if(s===a)c={x:r,y:h+p};else if((h-e)/(r-a+1e-8)===n)c={x:r+o,y:h+p};else{var f,u,l=this.getLineLength(a,e,s,i),g=(r-a)*(s-a)+(h-e)*(i-e);f=a+(g/=l*l)*(s-a),u=e+g*(i-e);var d=this.getLineLength(r,h,f,u),P=Math.sqrt(t*t-d*d);o=Math.sqrt(P*P/(1+n*n)),s<a&&(o*=-1),c={x:f+o,y:u+(p=n*o)}}return c}static getPointOnCubicBezier(t,a,e,s,i,r,h,n,o){function c(t){return t*t*t}function p(t){return 3*t*t*(1-t)}function f(t){return 3*t*(1-t)*(1-t)}function u(t){return(1-t)*(1-t)*(1-t)}return{x:n*c(t)+r*p(t)+s*f(t)+a*u(t),y:o*c(t)+h*p(t)+i*f(t)+e*u(t)}}static getPointOnQuadraticBezier(t,a,e,s,i,r,h){function n(t){return t*t}function o(t){return 2*t*(1-t)}function c(t){return(1-t)*(1-t)}return{x:r*n(t)+s*o(t)+a*c(t),y:h*n(t)+i*o(t)+e*c(t)}}static getPointOnEllipticalArc(t,a,e,s,i,r){var h=Math.cos(r),n=Math.sin(r),o=e*Math.cos(i),c=s*Math.sin(i);return{x:t+(o*h-c*n),y:a+(o*n+c*h)}}static parsePathData(t){if(!t)return[];var a=t,e=["m","M","l","L","v","V","h","H","z","Z","c","C","q","Q","t","T","s","S","a","A"];a=a.replace(new RegExp(" ","g"),",");for(var s=0;s<e.length;s++)a=a.replace(new RegExp(e[s],"g"),"|"+e[s]);var i,r=a.split("|"),h=[],n=[],o=0,c=0,p=/([-+]?((\d+\.\d+)|((\d+)|(\.\d+)))(?:e[-+]?\d+)?)/gi;for(s=1;s<r.length;s++){var f=r[s],u=f.charAt(0);for(f=f.slice(1),n.length=0;i=p.exec(f);)n.push(i[0]);for(var l=[],g=0,d=n.length;g<d;g++)if("00"!==n[g]){var P=parseFloat(n[g]);isNaN(P)?l.push(0):l.push(P)}else l.push(0,0);for(;l.length>0&&!isNaN(l[0]);){var L,y,v,M,b,x,m,A,k,C,O=null,z=[],q=o,E=c;switch(u){case"l":o+=l.shift(),c+=l.shift(),O="L",z.push(o,c);break;case"L":o=l.shift(),c=l.shift(),z.push(o,c);break;case"m":var Q=l.shift(),N=l.shift();if(o+=Q,c+=N,O="M",h.length>2&&"z"===h[h.length-1].command)for(var S=h.length-2;S>=0;S--)if("M"===h[S].command){o=h[S].points[0]+Q,c=h[S].points[1]+N;break}z.push(o,c),u="l";break;case"M":o=l.shift(),c=l.shift(),O="M",z.push(o,c),u="L";break;case"h":o+=l.shift(),O="L",z.push(o,c);break;case"H":o=l.shift(),O="L",z.push(o,c);break;case"v":c+=l.shift(),O="L",z.push(o,c);break;case"V":c=l.shift(),O="L",z.push(o,c);break;case"C":z.push(l.shift(),l.shift(),l.shift(),l.shift()),o=l.shift(),c=l.shift(),z.push(o,c);break;case"c":z.push(o+l.shift(),c+l.shift(),o+l.shift(),c+l.shift()),o+=l.shift(),c+=l.shift(),O="C",z.push(o,c);break;case"S":y=o,v=c,"C"===(L=h[h.length-1]).command&&(y=o+(o-L.points[2]),v=c+(c-L.points[3])),z.push(y,v,l.shift(),l.shift()),o=l.shift(),c=l.shift(),O="C",z.push(o,c);break;case"s":y=o,v=c,"C"===(L=h[h.length-1]).command&&(y=o+(o-L.points[2]),v=c+(c-L.points[3])),z.push(y,v,o+l.shift(),c+l.shift()),o+=l.shift(),c+=l.shift(),O="C",z.push(o,c);break;case"Q":z.push(l.shift(),l.shift()),o=l.shift(),c=l.shift(),z.push(o,c);break;case"q":z.push(o+l.shift(),c+l.shift()),o+=l.shift(),c+=l.shift(),O="Q",z.push(o,c);break;case"T":y=o,v=c,"Q"===(L=h[h.length-1]).command&&(y=o+(o-L.points[0]),v=c+(c-L.points[1])),o=l.shift(),c=l.shift(),O="Q",z.push(y,v,o,c);break;case"t":y=o,v=c,"Q"===(L=h[h.length-1]).command&&(y=o+(o-L.points[0]),v=c+(c-L.points[1])),o+=l.shift(),c+=l.shift(),O="Q",z.push(y,v,o,c);break;case"A":M=l.shift(),b=l.shift(),x=l.shift(),m=l.shift(),A=l.shift(),k=o,C=c,o=l.shift(),c=l.shift(),O="A",z=this.convertEndpointToCenterParameterization(k,C,o,c,m,A,M,b,x);break;case"a":M=l.shift(),b=l.shift(),x=l.shift(),m=l.shift(),A=l.shift(),k=o,C=c,o+=l.shift(),c+=l.shift(),O="A",z=this.convertEndpointToCenterParameterization(k,C,o,c,m,A,M,b,x)}h.push({command:O||u,points:z,start:{x:q,y:E},pathLength:this.calcLength(q,E,O||u,z)})}"z"!==u&&"Z"!==u||h.push({command:"z",points:[],start:void 0,pathLength:0})}return h}static calcLength(t,a,e,s){var i,r,h,n,o=Path;switch(e){case"L":return o.getLineLength(t,a,s[0],s[1]);case"C":for(i=0,r=o.getPointOnCubicBezier(0,t,a,s[0],s[1],s[2],s[3],s[4],s[5]),n=.01;n<=1;n+=.01)h=o.getPointOnCubicBezier(n,t,a,s[0],s[1],s[2],s[3],s[4],s[5]),i+=o.getLineLength(r.x,r.y,h.x,h.y),r=h;return i;case"Q":for(i=0,r=o.getPointOnQuadraticBezier(0,t,a,s[0],s[1],s[2],s[3]),n=.01;n<=1;n+=.01)h=o.getPointOnQuadraticBezier(n,t,a,s[0],s[1],s[2],s[3]),i+=o.getLineLength(r.x,r.y,h.x,h.y),r=h;return i;case"A":i=0;var c=s[4],p=s[5],f=s[4]+p,u=Math.PI/180;if(Math.abs(c-f)<u&&(u=Math.abs(c-f)),r=o.getPointOnEllipticalArc(s[0],s[1],s[2],s[3],c,0),p<0)for(n=c-u;n>f;n-=u)h=o.getPointOnEllipticalArc(s[0],s[1],s[2],s[3],n,0),i+=o.getLineLength(r.x,r.y,h.x,h.y),r=h;else for(n=c+u;n<f;n+=u)h=o.getPointOnEllipticalArc(s[0],s[1],s[2],s[3],n,0),i+=o.getLineLength(r.x,r.y,h.x,h.y),r=h;return h=o.getPointOnEllipticalArc(s[0],s[1],s[2],s[3],f,0),i+=o.getLineLength(r.x,r.y,h.x,h.y)}return 0}static convertEndpointToCenterParameterization(t,a,e,s,i,r,h,n,o){var c=o*(Math.PI/180),p=Math.cos(c)*(t-e)/2+Math.sin(c)*(a-s)/2,f=-1*Math.sin(c)*(t-e)/2+Math.cos(c)*(a-s)/2,u=p*p/(h*h)+f*f/(n*n);u>1&&(h*=Math.sqrt(u),n*=Math.sqrt(u));var l=Math.sqrt((h*h*(n*n)-h*h*(f*f)-n*n*(p*p))/(h*h*(f*f)+n*n*(p*p)));i===r&&(l*=-1),isNaN(l)&&(l=0);var g=l*h*f/n,d=l*-n*p/h,P=(t+e)/2+Math.cos(c)*g-Math.sin(c)*d,L=(a+s)/2+Math.sin(c)*g+Math.cos(c)*d,y=function(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])},v=function(t,a){return(t[0]*a[0]+t[1]*a[1])/(y(t)*y(a))},M=function(t,a){return(t[0]*a[1]<t[1]*a[0]?-1:1)*Math.acos(v(t,a))},b=M([1,0],[(p-g)/h,(f-d)/n]),x=[(p-g)/h,(f-d)/n],m=[(-1*p-g)/h,(-1*f-d)/n],A=M(x,m);return v(x,m)<=-1&&(A=Math.PI),v(x,m)>=1&&(A=0),0===r&&A>0&&(A-=2*Math.PI),1===r&&A<0&&(A+=2*Math.PI),[P,L,h,n,b,A,c,r]}}exports.Path=Path,Path.prototype.className="Path",Path.prototype._attrsAffectingSize=["data"],(0,Global_1._registerNode)(Path),Factory_1.Factory.addGetterSetter(Path,"data");
