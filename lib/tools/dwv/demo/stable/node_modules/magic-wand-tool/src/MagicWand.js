var MagicWand=function(){var t={};return t.floodFill=function(t,r,i,n,a,h){return h?function(t,r,i,n,a){var h,f,o,e,s,u,d,l,y,x,m=t.data,g=t.width,p=t.height,w=t.bytes,b=-1,M=g+1,c=-1,v=p+1,X=i*g+r,Y=new Uint8Array(g*p),A=new Uint8Array(a||g*p);if(1===A[X])return null;var U=[m[X*=w],m[X+1],m[X+2],m[X+3]],q=[{y:i,left:r-1,right:r+1,dir:1}];do{for(x=!1,f=(e=q.shift()).left+1;f<e.right;f++)if(X=((d=e.y*g)+f)*w,1!==A[d+f]&&(x=!0,Y[d+f]=1,A[d+f]=1,!((h=m[X]-U[0])>n||h<-n||(h=m[X+1]-U[1])>n||h<-n||(h=m[X+2]-U[2])>n||h<-n))){for(u=f-1;u>-1&&(X=(l=d+u)*w,1!==A[l])&&(Y[l]=1,A[l]=1,u--,!((h=m[X]-U[0])>n||h<-n))&&!((h=m[X+1]-U[1])>n||h<-n)&&!((h=m[X+2]-U[2])>n||h<-n););for(s=f+1;s<g&&(X=(y=d+s)*w,1!==A[y])&&(Y[y]=1,A[y]=1,s++,!((h=m[X]-U[0])>n||h<-n))&&!((h=m[X+1]-U[1])>n||h<-n)&&!((h=m[X+2]-U[2])>n||h<-n););u<M&&(M=u+1),s>b&&(b=s-1),(o=e.y-e.dir)>=0&&o<p&&(u<e.left&&q.push({y:o,left:u,right:e.left,dir:-e.dir}),e.right<s&&q.push({y:o,left:e.right,right:s,dir:-e.dir})),(o=e.y+e.dir)>=0&&o<p&&u<s&&q.push({y:o,left:u,right:s,dir:e.dir})}x&&(e.y<v&&(v=e.y),e.y>c&&(c=e.y))}while(q.length>0);return{data:Y,width:t.width,height:t.height,bounds:{minX:M,minY:v,maxX:b,maxY:c}}}(t,r,i,n,a):function(t,r,i,n,a){var h,f,o,e,s,u,d,l,y,x,m=t.data,g=t.width,p=t.height,w=t.bytes,b=-1,M=g+1,c=-1,v=p+1,X=i*g+r,Y=new Uint8Array(g*p),A=new Uint8Array(a||g*p);if(1===A[X])return null;var U=[m[X*=w],m[X+1],m[X+2],m[X+3]],q=[{y:i,left:r-1,right:r+1,dir:1}];do{for(x=!1,f=(e=q.shift()).left+1;f<e.right;f++)if(X=((d=e.y*g)+f)*w,1!==A[d+f]&&!((h=m[X]-U[0])>n||h<-n||(h=m[X+1]-U[1])>n||h<-n||(h=m[X+2]-U[2])>n||h<-n)){for(x=!0,Y[d+f]=1,A[d+f]=1,u=f-1;u>-1&&(X=(l=d+u)*w,1!==A[l])&&!((h=m[X]-U[0])>n||h<-n)&&!((h=m[X+1]-U[1])>n||h<-n)&&!((h=m[X+2]-U[2])>n||h<-n);)Y[l]=1,A[l]=1,u--;for(s=f+1;s<g&&(X=(y=d+s)*w,1!==A[y])&&!((h=m[X]-U[0])>n||h<-n)&&!((h=m[X+1]-U[1])>n||h<-n)&&!((h=m[X+2]-U[2])>n||h<-n);)Y[y]=1,A[y]=1,s++;u<M&&(M=u+1),s>b&&(b=s-1),(o=e.y-e.dir)>=0&&o<p&&(u<e.left&&q.push({y:o,left:u,right:e.left,dir:-e.dir}),e.right<s&&q.push({y:o,left:e.right,right:s,dir:-e.dir})),(o=e.y+e.dir)>=0&&o<p&&u<s&&q.push({y:o,left:u,right:s,dir:e.dir})}x&&(e.y<v&&(v=e.y),e.y>c&&(c=e.y))}while(q.length>0);return{data:Y,width:t.width,height:t.height,bounds:{minX:M,minY:v,maxX:b,maxY:c}}}(t,r,i,n,a)},t.gaussBlur=function(t,r){var i,n,a,h,f,o,e,s=2*r+1,u=r*r,d=new Float32Array(s),l=0,y=t.width,x=t.height,m=t.data,g=t.bounds.minX,p=t.bounds.maxX,w=t.bounds.minY,b=t.bounds.maxY;for(i=0;i<r;i++){var M=(r-i)*(r-i),c=Math.exp(-M/(2*u))/(2*Math.PI*u);d[r+i]=d[r-i]=c,l+=2*c}for(i=0;i<s;i++)d[i]/=l;var v=new Uint8Array(y*x),X=r+y,Y=r+x;for(f=w;f<b+1;f++)for(h=g;h<p+1;h++){for(o=0,e=X-h<s?X-h:s,a=(n=f*y+h)-r,i=r-h>0?r-h:0;i<e;i++)o+=m[a+i]*d[i];for(e=Y-f<s?Y-f:s,a=n-r*y,i=r-f>0?r-f:0;i<e;i++)o+=m[a+i*y]*d[i];v[n]=o>.5?1:0}return{data:v,width:y,height:x,bounds:{minX:g,minY:w,maxX:p,maxY:b}}},t.gaussBlurOnlyBorder=function(t,r,i){var n,a,h,f,o,e,s,u,d,l,y=function(t,r,i){var n,a,h,f,o,e,s,u=t.width,d=t.height,l=t.data,y=new Uint8Array(l),x=t.bounds.minX,m=t.bounds.maxX,g=t.bounds.minY,p=t.bounds.maxY,w=u*d,b=new Uint8Array(w),M=[],c=Math.max(x,1),v=Math.min(m,u-2),X=Math.max(g,1),Y=Math.min(p,d-2);if(i&&i.length>0)for(o=0;o<w;o++)1===i[o]&&(y[o]=1);for(f=X;f<Y+1;f++)for(n=c;n<v+1;n++)0!==l[o=f*u+n]&&(e=o+u,s=o-u,0!==y[o+1]&&0!==y[o-1]&&0!==y[e]&&0!==y[e+1]&&0!==y[e-1]&&0!==y[s]&&0!==y[s+1]&&0!==y[s-1]||M.push(o));if(0==x)for(f=g;f<p+1;f++)1===l[f*u]&&M.push(f*u);if(m==u-1)for(f=g;f<p+1;f++)1===l[f*u+m]&&M.push(f*u+m);if(0==g)for(n=x;n<m+1;n++)1===l[n]&&M.push(n);if(p==d-1)for(n=x;n<m+1;n++)1===l[p*u+n]&&M.push(p*u+n);var A,U=[],q=r+u,B=r+d,k=2*r+1;for(w=M.length,h=0;h<w;h++){for(b[o=M[h]]=1,U.push(o),f=(o-(n=o%u))/u,A=q-n<k?q-n:k,e=o-r,a=r-n>0?r-n:0;a<A;a++)0===b[s=e+a]&&(b[s]=1,U.push(s));for(A=B-f<k?B-f:k,e=o-r*u,a=r-f>0?r-f:0;a<A;a++)0===b[s=e+a*u]&&(b[s]=1,U.push(s))}return U}(t,r,i),x=2*r+1,m=2*r*r,g=new Float32Array(x),p=0,w=t.width,b=t.height,M=t.data,c=t.bounds.minX,v=t.bounds.maxX,X=t.bounds.minY,Y=t.bounds.maxY,A=y.length;for(h=0;h<r;h++)a=(r-h)*(r-h),n=Math.exp(-a/m)/Math.PI,g[r+h]=g[r-h]=n,p+=2*n;for(h=0;h<x;h++)g[h]/=p;var U=new Uint8Array(M),q=r+w,B=r+b;for(h=0;h<A;h++){for(d=0,u=((o=y[h])-(s=o%w))/w,l=q-s<x?q-s:x,e=o-r,f=r-s>0?r-s:0;f<l;f++)d+=M[e+f]*g[f];if(d>.5)U[o]=1,s<c&&(c=s),s>v&&(v=s),u<X&&(X=u),u>Y&&(Y=u);else{for(l=B-u<x?B-u:x,e=o-r*w,f=r-u>0?r-u:0;f<l;f++)d+=M[e+f*w]*g[f];d>.5?(U[o]=1,s<c&&(c=s),s>v&&(v=s),u<X&&(X=u),u>Y&&(Y=u)):U[o]=0}}return{data:U,width:w,height:b,bounds:{minX:c,minY:X,maxX:v,maxY:Y}}},t.createBorderMask=function(t){var r,i,n,a,h,f=t.width,o=t.height,e=t.data,s=t.bounds.minX,u=t.bounds.maxX,d=t.bounds.minY,l=t.bounds.maxY,y=u-s+1,x=l-d+1,m=new Uint8Array(y*x),g=Math.max(s,1),p=Math.min(u,f-2),w=Math.max(d,1),b=Math.min(l,o-2);for(i=w;i<b+1;i++)for(r=g;r<p+1;r++)0!==e[n=i*f+r]&&(a=n+f,h=n-f,0!==e[n+1]&&0!==e[n-1]&&0!==e[a]&&0!==e[a+1]&&0!==e[a-1]&&0!==e[h]&&0!==e[h+1]&&0!==e[h-1]||(m[(i-d)*y+(r-s)]=1));if(0==s)for(i=d;i<l+1;i++)1===e[i*f]&&(m[(i-d)*y]=1);if(u==f-1)for(i=d;i<l+1;i++)1===e[i*f+u]&&(m[(i-d)*y+(u-s)]=1);if(0==d)for(r=s;r<u+1;r++)1===e[r]&&(m[r-s]=1);if(l==o-1)for(r=s;r<u+1;r++)1===e[l*f+r]&&(m[(l-d)*y+(r-s)]=1);return{data:m,width:y,height:x,offset:{x:s,y:d}}},t.getBorderIndices=function(t){var r,i,n,a,h,f=t.width,o=t.height,e=t.data,s=[],u=f-1,d=o-1;for(i=1;i<d;i++)for(r=1;r<u;r++)0!==e[n=i*f+r]&&(a=n+f,h=n-f,0!==e[n+1]&&0!==e[n-1]&&0!==e[a]&&0!==e[a+1]&&0!==e[a-1]&&0!==e[h]&&0!==e[h+1]&&0!==e[h-1]||s.push(n));for(i=0;i<o;i++)1===e[i*f]&&s.push(i*f);for(r=0;r<f;r++)1===e[r]&&s.push(r);for(n=f-1,i=0;i<o;i++)1===e[i*f+n]&&s.push(i*f+n);for(n=(o-1)*f,r=0;r<f;r++)1===e[n+r]&&s.push(n+r);return s},t.traceContours=function(t){var r,i,n,a,h,f,o,e,s,u,d,l,y,x,m,g=function(t){var r,i,n=t.width,a=t.data,h=t.bounds.minX,f=t.bounds.maxX,o=t.bounds.minY,e=t.bounds.maxY,s=f-h+3,u=e-o+3,d=new Uint8Array(s*u);for(i=o;i<e+1;i++)for(r=h;r<f+1;r++)1===a[i*n+r]&&(d[(i-o+1)*s+(r-h+1)]=1);return{data:d,width:s,height:u,offset:{x:h-1,y:o-1}}}(t),p=[],w=0,b=g.width,M=2*b,c=g.height,v=g.data,X=g.offset.x,Y=g.offset.y,A=new Uint8Array(v),U=[[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1]];for(a=1;a<c-1;a++)for(n=1;n<b-1;n++)if(1===v[h=a*b+n])for(r=-b;r<M;r+=M)if(0===v[h+r]&&0===A[h+r]){for(w++,o=[],s=(e=r===b)?2:6,l=y=u={x:n,y:a},d=null;;){for(A[l.y*b+l.x]=w,i=0;i<8;i++){if(m=U[s=(s+1)%8],1===v[f=(x={x:l.x+m[0],y:l.y+m[1]}).y*b+x.x]){A[f]=w;break}A[f]=-1,x=null}if(null===x)break;if(l=x,d){if(y.x===u.x&&y.y===u.y&&l.x===d.x&&l.y===d.y)break}else d=x;o.push({x:y.x+X,y:y.y+Y}),y=l,s=(s+4)%8}null!=x&&(o.push({x:u.x+X,y:u.y+Y}),p.push({inner:e,label:w,points:o}))}return p},t.simplifyContours=function(t,r,i){var n,a,h,f,o,e,s,u,d,l,y,x,m,g,p,w,b,M,c,v,X,Y=t.length,A=[];for(a=0;a<Y;a++)if(o=(f=t[a]).points,(e=f.points.length)<i){for(s=[],h=0;h<e;h++)s.push({x:o[h].x,y:o[h].y});A.push({inner:f.inner,label:f.label,points:s,initialCount:e})}else{u=[0,e-1],d=[{first:0,last:e-1}];do{if(!((l=d.shift()).last<=l.first+1)){for(y=-1,x=l.first,n=l.first+1;n<l.last;n++)c=o[n],v=o[l.first],X=o[l.last],b=c.x-v.x,M=c.y-v.y,g=Math.sqrt(b*b+M*M),b=c.x-X.x,M=c.y-X.y,p=Math.sqrt(b*b+M*M),b=v.x-X.x,M=v.y-X.y,w=Math.sqrt(b*b+M*M),(m=g>=Math.sqrt(p*p+w*w)?p:p>=Math.sqrt(g*g+w*w)?g:Math.abs((M*c.x-b*c.y+v.x*X.y-X.x*v.y)/w))>y&&(x=n,y=m);y>r&&(u.push(x),d.push({first:l.first,last:x}),d.push({first:x,last:l.last}))}}while(d.length>0);for(s=[],e=u.length,u.sort((function(t,r){return t-r})),h=0;h<e;h++)s.push({x:o[u[h]].x,y:o[u[h]].y});A.push({inner:f.inner,label:f.label,points:s,initialCount:f.points.length})}return A},t}();"undefined"!=typeof module&&null!==module&&(module.exports=MagicWand),"undefined"!=typeof window&&null!==window&&(window.MagicWand=MagicWand);
