"use strict";var JpxImage=function(){var e={LL:0,LH:1,HL:1,HH:2};function t(){this.failOnCorruptedImage=!0}function r(e,t){e.x0=Math.ceil(t.XOsiz/e.XRsiz),e.x1=Math.ceil(t.Xsiz/e.XRsiz),e.y0=Math.ceil(t.YOsiz/e.YRsiz),e.y1=Math.ceil(t.Ysiz/e.YRsiz),e.width=e.x1-e.x0,e.height=e.y1-e.y0}function i(e,t){for(var r,i=e.SIZ,n=[],a=Math.ceil((i.Xsiz-i.XTOsiz)/i.XTsiz),s=Math.ceil((i.Ysiz-i.YTOsiz)/i.YTsiz),o=0;o<s;o++)for(var c=0;c<a;c++)(r={}).tx0=Math.max(i.XTOsiz+c*i.XTsiz,i.XOsiz),r.ty0=Math.max(i.YTOsiz+o*i.YTsiz,i.YOsiz),r.tx1=Math.min(i.XTOsiz+(c+1)*i.XTsiz,i.Xsiz),r.ty1=Math.min(i.YTOsiz+(o+1)*i.YTsiz,i.Ysiz),r.width=r.tx1-r.tx0,r.height=r.ty1-r.ty0,r.components=[],n.push(r);e.tiles=n;for(var h=0,l=i.Csiz;h<l;h++)for(var u=t[h],d=0,f=n.length;d<f;d++){var v={};r=n[d],v.tcx0=Math.ceil(r.tx0/u.XRsiz),v.tcy0=Math.ceil(r.ty0/u.YRsiz),v.tcx1=Math.ceil(r.tx1/u.XRsiz),v.tcy1=Math.ceil(r.ty1/u.YRsiz),v.width=v.tcx1-v.tcx0,v.height=v.tcy1-v.tcy0,r.components[h]=v}}function n(e,t,r){var i=t.codingStyleParameters,n={};return i.entropyCoderWithCustomPrecincts?(n.PPx=i.precinctsSizes[r].PPx,n.PPy=i.precinctsSizes[r].PPy):(n.PPx=15,n.PPy=15),n.xcb_=r>0?Math.min(i.xcb,n.PPx-1):Math.min(i.xcb,n.PPx),n.ycb_=r>0?Math.min(i.ycb,n.PPy-1):Math.min(i.ycb,n.PPy),n}function a(e,t,r){var i=1<<r.PPx,n=1<<r.PPy,a=0===t.resLevel,s=1<<r.PPx+(a?0:-1),o=1<<r.PPy+(a?0:-1),c=t.trx1>t.trx0?Math.ceil(t.trx1/i)-Math.floor(t.trx0/i):0,h=t.try1>t.try0?Math.ceil(t.try1/n)-Math.floor(t.try0/n):0,l=c*h;t.precinctParameters={precinctWidth:i,precinctHeight:n,numprecinctswide:c,numprecinctshigh:h,numprecincts:l,precinctWidthInSubband:s,precinctHeightInSubband:o}}function s(e,t,r){var i,n,a,s,o=r.xcb_,c=r.ycb_,h=1<<o,l=1<<c,u=t.tbx0>>o,d=t.tby0>>c,f=t.tbx1+h-1>>o,v=t.tby1+l-1>>c,m=t.resolution.precinctParameters,p=[],b=[];for(n=d;n<v;n++)for(i=u;i<f;i++){if((a={cbx:i,cby:n,tbx0:h*i,tby0:l*n,tbx1:h*(i+1),tby1:l*(n+1)}).tbx0_=Math.max(t.tbx0,a.tbx0),a.tby0_=Math.max(t.tby0,a.tby0),a.tbx1_=Math.min(t.tbx1,a.tbx1),a.tby1_=Math.min(t.tby1,a.tby1),s=Math.floor((a.tbx0_-t.tbx0)/m.precinctWidthInSubband)+Math.floor((a.tby0_-t.tby0)/m.precinctHeightInSubband)*m.numprecinctswide,a.precinctNumber=s,a.subbandType=t.type,a.Lblock=3,!(a.tbx1_<=a.tbx0_||a.tby1_<=a.tby0_)){p.push(a);var g=b[s];void 0!==g?(i<g.cbxMin?g.cbxMin=i:i>g.cbxMax&&(g.cbxMax=i),n<g.cbyMin?g.cbxMin=n:n>g.cbyMax&&(g.cbyMax=n)):b[s]=g={cbxMin:i,cbyMin:n,cbxMax:i,cbyMax:n},a.precinct=g}}t.codeblockParameters={codeblockWidth:o,codeblockHeight:c,numcodeblockwide:f-u+1,numcodeblockhigh:v-d+1},t.codeblocks=p,t.precincts=b}function o(e,t,r){for(var i=[],n=e.subbands,a=0,s=n.length;a<s;a++)for(var o=n[a].codeblocks,c=0,h=o.length;c<h;c++){var l=o[c];l.precinctNumber===t&&i.push(l)}return{layerNumber:r,codeblocks:i}}function c(e){for(var t=e.SIZ,r=e.currentTile.index,i=e.tiles[r],n=i.codingStyleDefaultParameters.layersCount,a=t.Csiz,s=0,c=0;c<a;c++)s=Math.max(s,i.components[c].codingStyleParameters.decompositionLevelsCount);var h=0,l=0,u=0,d=0;this.nextPacket=function(){for(;h<n;h++){for(;l<=s;l++){for(;u<a;u++){var e=i.components[u];if(!(l>e.codingStyleParameters.decompositionLevelsCount)){for(var t=e.resolutions[l],r=t.precinctParameters.numprecincts;d<r;){var c=o(t,d,h);return d++,c}d=0}}u=0}l=0}}}function h(e){for(var t=e.SIZ,r=e.currentTile.index,i=e.tiles[r],n=i.codingStyleDefaultParameters.layersCount,a=t.Csiz,s=0,c=0;c<a;c++)s=Math.max(s,i.components[c].codingStyleParameters.decompositionLevelsCount);var h=0,l=0,u=0,d=0;this.nextPacket=function(){for(;h<=s;h++){for(;l<n;l++){for(;u<a;u++){var e=i.components[u];if(!(h>e.codingStyleParameters.decompositionLevelsCount)){for(var t=e.resolutions[h],r=t.precinctParameters.numprecincts;d<r;){var c=o(t,d,l);return d++,c}d=0}}u=0}l=0}}}function l(e){var t,r,i,n,a=e.SIZ,s=e.currentTile.index,c=e.tiles[s],h=c.codingStyleDefaultParameters.layersCount,l=a.Csiz,u=0;for(i=0;i<l;i++){var d=c.components[i];u=Math.max(u,d.codingStyleParameters.decompositionLevelsCount)}var f=new Int32Array(u+1);for(r=0;r<=u;++r){var v=0;for(i=0;i<l;++i){var m=c.components[i].resolutions;r<m.length&&(v=Math.max(v,m[r].precinctParameters.numprecincts))}f[r]=v}t=0,r=0,i=0,n=0,this.nextPacket=function(){for(;r<=u;r++){for(;n<f[r];n++){for(;i<l;i++){var e=c.components[i];if(!(r>e.codingStyleParameters.decompositionLevelsCount)){var a=e.resolutions[r],s=a.precinctParameters.numprecincts;if(!(n>=s)){for(;t<h;){var d=o(a,n,t);return t++,d}t=0}}}i=0}n=0}}}function u(e){var t=e.SIZ,r=e.currentTile.index,i=e.tiles[r],n=i.codingStyleDefaultParameters.layersCount,a=t.Csiz,s=v(i),c=s,h=0,l=0,u=0,d=0,m=0;this.nextPacket=function(){for(;m<c.maxNumHigh;m++){for(;d<c.maxNumWide;d++){for(;u<a;u++){for(var e=i.components[u],t=e.codingStyleParameters.decompositionLevelsCount;l<=t;l++){var r=e.resolutions[l],v=s.components[u].resolutions[l],p=f(d,m,v,c,r);if(null!==p){for(;h<n;){var b=o(r,p,h);return h++,b}h=0}}l=0}u=0}d=0}}}function d(e){var t=e.SIZ,r=e.currentTile.index,i=e.tiles[r],n=i.codingStyleDefaultParameters.layersCount,a=t.Csiz,s=v(i),c=0,h=0,l=0,u=0,d=0;this.nextPacket=function(){for(;l<a;++l){for(var e=i.components[l],t=s.components[l],r=e.codingStyleParameters.decompositionLevelsCount;d<t.maxNumHigh;d++){for(;u<t.maxNumWide;u++){for(;h<=r;h++){var v=e.resolutions[h],m=t.resolutions[h],p=f(u,d,m,t,v);if(null!==p){for(;c<n;){var b=o(v,p,c);return c++,b}c=0}}h=0}u=0}d=0}}}function f(e,t,r,i,n){var a=e*i.minWidth,s=t*i.minHeight;if(a%r.width!=0||s%r.height!=0)return null;var o=s/r.width*n.precinctParameters.numprecinctswide;return a/r.height+o}function v(e){for(var t=e.components.length,r=Number.MAX_VALUE,i=Number.MAX_VALUE,n=0,a=0,s=new Array(t),o=0;o<t;o++){for(var c=e.components[o],h=c.codingStyleParameters.decompositionLevelsCount,l=new Array(h+1),u=Number.MAX_VALUE,d=Number.MAX_VALUE,f=0,v=0,m=1,p=h;p>=0;--p){var b=c.resolutions[p],g=m*b.precinctParameters.precinctWidth,y=m*b.precinctParameters.precinctHeight;u=Math.min(u,g),d=Math.min(d,y),f=Math.max(f,b.precinctParameters.numprecinctswide),v=Math.max(v,b.precinctParameters.numprecinctshigh),l[p]={width:g,height:y},m<<=1}r=Math.min(r,u),i=Math.min(i,d),n=Math.max(n,f),a=Math.max(a,v),s[o]={resolutions:l,minWidth:u,minHeight:d,maxNumWide:f,maxNumHigh:v}}return{components:s,minWidth:r,minHeight:i,maxNumWide:n,maxNumHigh:a}}function m(e){for(var t=e.SIZ,r=e.currentTile.index,i=e.tiles[r],o=t.Csiz,f=0;f<o;f++){for(var v=i.components[f],m=v.codingStyleParameters.decompositionLevelsCount,p=[],b=[],g=0;g<=m;g++){var y,x=n(0,v,g),P={},C=1<<m-g;if(P.trx0=Math.ceil(v.tcx0/C),P.try0=Math.ceil(v.tcy0/C),P.trx1=Math.ceil(v.tcx1/C),P.try1=Math.ceil(v.tcy1/C),P.resLevel=g,a(0,P,x),p.push(P),0===g)(y={}).type="LL",y.tbx0=Math.ceil(v.tcx0/C),y.tby0=Math.ceil(v.tcy0/C),y.tbx1=Math.ceil(v.tcx1/C),y.tby1=Math.ceil(v.tcy1/C),y.resolution=P,s(0,y,x),b.push(y),P.subbands=[y];else{var M=1<<m-g+1,w=[];(y={}).type="HL",y.tbx0=Math.ceil(v.tcx0/M-.5),y.tby0=Math.ceil(v.tcy0/M),y.tbx1=Math.ceil(v.tcx1/M-.5),y.tby1=Math.ceil(v.tcy1/M),y.resolution=P,s(0,y,x),b.push(y),w.push(y),(y={}).type="LH",y.tbx0=Math.ceil(v.tcx0/M),y.tby0=Math.ceil(v.tcy0/M-.5),y.tbx1=Math.ceil(v.tcx1/M),y.tby1=Math.ceil(v.tcy1/M-.5),y.resolution=P,s(0,y,x),b.push(y),w.push(y),(y={}).type="HH",y.tbx0=Math.ceil(v.tcx0/M-.5),y.tby0=Math.ceil(v.tcy0/M-.5),y.tbx1=Math.ceil(v.tcx1/M-.5),y.tby1=Math.ceil(v.tcy1/M-.5),y.resolution=P,s(0,y,x),b.push(y),w.push(y),P.subbands=w}}v.resolutions=p,v.subbands=b}var S=i.codingStyleDefaultParameters.progressionOrder;switch(S){case 0:i.packetsIterator=new c(e);break;case 1:i.packetsIterator=new h(e);break;case 2:i.packetsIterator=new l(e);break;case 3:i.packetsIterator=new u(e);break;case 4:i.packetsIterator=new d(e);break;default:throw new Error("JPX Error: Unsupported progression order "+S)}}function p(e,t,r,i){var n,a=0,s=0,o=!1;function c(e){for(;s<e;){var i=t[r+a];a++,o?(n=n<<7|i,s+=7,o=!1):(n=n<<8|i,s+=8),255===i&&(o=!0)}return n>>>(s-=e)&(1<<e)-1}function h(e){return 255===t[r+a-1]&&t[r+a]===e?(l(1),!0):255===t[r+a]&&t[r+a+1]===e&&(l(2),!0)}function l(e){a+=e}function u(){s=0,o&&(a++,o=!1)}function d(){if(0===c(1))return 1;if(0===c(1))return 2;var e=c(2);return e<3?e+3:(e=c(5))<31?e+6:(e=c(7))+37}for(var f=e.currentTile.index,v=e.tiles[f],m=e.COD.sopMarkerUsed,p=e.COD.ephMarkerUsed,b=v.packetsIterator;a<i;){u(),m&&h(145)&&l(4);var g=b.nextPacket();if(void 0===g)return;if(c(1)){for(var y,C=g.layerNumber,M=[],w=0,S=g.codeblocks.length;w<S;w++){var k=(y=g.codeblocks[w]).precinct,z=y.cbx-k.cbxMin,T=y.cby-k.cbyMin,U=!1,L=!1;if(void 0!==y.included)U=!!c(1);else{var I,O;if(void 0!==(k=y.precinct).inclusionTree)I=k.inclusionTree;else{var X=k.cbxMax-k.cbxMin+1,A=k.cbyMax-k.cbyMin+1;I=new P(X,A,C),O=new x(X,A),k.inclusionTree=I,k.zeroBitPlanesTree=O;for(var D=0;D<C;D++)if(0!==c(1))throw new Error("JPX Error: Invalid tag tree")}if(I.reset(z,T,C))for(;;){if(!c(1)){I.incrementValue(C);break}if(!I.nextLevel()){y.included=!0,U=L=!0;break}}}if(U){if(L){for((O=k.zeroBitPlanesTree).reset(z,T);;)if(c(1)){if(!O.nextLevel())break}else O.incrementValue();y.zeroBitPlanes=O.value}for(var E=d();c(1);)y.Lblock++;var H=log2(E),B=c((E<1<<H?H-1:H)+y.Lblock);M.push({codeblock:y,codingpasses:E,dataLength:B})}}for(u(),p&&h(146);M.length>0;){var _=M.shift();void 0===(y=_.codeblock).data&&(y.data=[]),y.data.push({data:t,start:r+a,end:r+a+_.dataLength,codingpasses:_.codingpasses}),a+=_.dataLength}}}return a}function b(e,t,r,i,n,a,s,o){for(var c=i.tbx0,h=i.tby0,l=i.tbx1-i.tbx0,u=i.codeblocks,d="H"===i.type.charAt(0)?1:0,f="H"===i.type.charAt(1)?t:0,v=0,m=u.length;v<m;++v){var p=u[v],b=p.tbx1_-p.tbx0_,g=p.tby1_-p.tby0_;if(0!==b&&0!==g&&void 0!==p.data){var y,x;y=new C(b,g,p.subbandType,p.zeroBitPlanes,a),x=2;var P,M,w,S=p.data,k=0,z=0;for(P=0,M=S.length;P<M;P++)k+=(w=S[P]).end-w.start,z+=w.codingpasses;var T=new Int16Array(k),U=0;for(P=0,M=S.length;P<M;P++){var L=(w=S[P]).data.subarray(w.start,w.end);T.set(L,U),U+=L.length}var I=new ArithmeticDecoder(T,0,k);for(y.setDecoder(I),P=0;P<z;P++){switch(x){case 0:y.runSignificancePropogationPass();break;case 1:y.runMagnitudeRefinementPass();break;case 2:y.runCleanupPass(),o&&y.checkSegmentationSymbol()}x=(x+1)%3}var O,X,A,D=p.tbx0_-c+(p.tby0_-h)*l,E=y.coefficentsSign,H=y.coefficentsMagnitude,B=y.bitsDecoded,_=s?0:.5;U=0;var Y="LL"!==i.type;for(P=0;P<g;P++){var N=2*(D/l|0)*(t-l)+d+f;for(O=0;O<b;O++){if(0!==(X=H[U])){X=(X+_)*n,0!==E[U]&&(X=-X),A=B[U];var Q=Y?N+(D<<1):D;e[Q]=s&&A>=a?X:X*(1<<a-A)}D++,U++}D+=l-b}}}}function g(t,r,i){for(var n=r.components[i],a=n.codingStyleParameters,s=n.quantizationParameters,o=a.decompositionLevelsCount,c=s.SPqcds,h=s.scalarExpounded,l=s.guardBits,u=a.segmentationSymbolUsed,d=t.components[i].precision,f=a.reversibleTransformation,v=f?new S:new w,m=[],p=0,g=0;g<=o;g++){for(var y=n.resolutions[g],x=y.trx1-y.trx0,P=y.try1-y.try0,C=new Float32Array(x*P),M=0,k=y.subbands.length;M<k;M++){var z,T;h?(z=c[p].mu,T=c[p].epsilon,p++):(z=c[0].mu,T=c[0].epsilon+(g>0?1-g:0));var U=y.subbands[M],L=e[U.type];b(C,x,0,U,f?1:Math.pow(2,d+L-T)*(1+z/2048),l+T-1,f,u)}m.push({width:x,height:P,items:C})}var I=v.calculate(m,n.tcx0,n.tcy0);return{left:n.tcx0,top:n.tcy0,width:I.width,height:I.height,items:I.items}}function y(e,t){for(var r=e.SIZ.Csiz,i=e.tiles[t],n=0;n<r;n++){var a=i.components[n],s=void 0!==e.currentTile.QCC[n]?e.currentTile.QCC[n]:e.currentTile.QCD;a.quantizationParameters=s;var o=void 0!==e.currentTile.COC[n]?e.currentTile.COC[n]:e.currentTile.COD;a.codingStyleParameters=o}i.codingStyleDefaultParameters=e.currentTile.COD}t.prototype={parse:function(e){if(65359!==readUint16(e,0))for(var t=0,r=e.length;t<r;){var i=8,n=readUint32(e,t),a=readUint32(e,t+4);if(t+=i,1===n&&(n=4294967296*readUint32(e,t)+readUint32(e,t+4),t+=8,i+=8),0===n&&(n=r-t+i),n<i)throw new Error("JPX Error: Invalid box field size");var s=n-i,o=!0;switch(a){case 1785737832:o=!1;break;case 1668246642:var c=e[t];e[t+1],e[t+2];if(1===c){var h=readUint32(e,t+3);switch(h){case 16:case 17:case 18:break;default:warn("Unknown colorspace "+h)}}else 2===c&&info("ICC profile not supported");break;case 1785737827:this.parseCodestream(e,t,t+s);break;case 1783636e3:218793738!==readUint32(e,t)&&warn("Invalid JP2 signature");break;case 1783634458:case 1718909296:case 1920099697:case 1919251232:case 1768449138:break;default:var l=String.fromCharCode(a>>24&255,a>>16&255,a>>8&255,255&a);warn("Unsupported header type "+a+" ("+l+")")}o&&(t+=s)}else this.parseCodestream(e,0,e.length)},parseImageProperties:function(e){for(var t=e.getByte();t>=0;){if(65361===(t<<8|(t=e.getByte()))){e.skip(4);var r=e.getInt32()>>>0,i=e.getInt32()>>>0,n=e.getInt32()>>>0,a=e.getInt32()>>>0;e.skip(16);var s=e.getUint16();return this.width=r-n,this.height=i-a,this.componentsCount=s,void(this.bitsPerComponent=8)}}throw new Error("JPX Error: No size marker found in JPX stream")},parseCodestream:function(e,t,n){var a={};try{for(var s=!1,o=t;o+1<n;){var c=readUint16(e,o);o+=2;var h,l,u,d,f,v,b=0;switch(c){case 65359:a.mainHeader=!0;break;case 65497:break;case 65361:b=readUint16(e,o);var x={};x.Xsiz=readUint32(e,o+4),x.Ysiz=readUint32(e,o+8),x.XOsiz=readUint32(e,o+12),x.YOsiz=readUint32(e,o+16),x.XTsiz=readUint32(e,o+20),x.YTsiz=readUint32(e,o+24),x.XTOsiz=readUint32(e,o+28),x.YTOsiz=readUint32(e,o+32);var P=readUint16(e,o+36);x.Csiz=P;var C=[];h=o+38;for(var M=0;M<P;M++){var w={precision:1+(127&e[h]),isSigned:!!(128&e[h]),XRsiz:e[h+1],YRsiz:e[h+1]};r(w,x),C.push(w)}a.SIZ=x,a.components=C,i(a,C),a.QCC=[],a.COC=[];break;case 65372:b=readUint16(e,o);var S={};switch(h=o+2,31&(l=e[h++])){case 0:d=8,f=!0;break;case 1:d=16,f=!1;break;case 2:d=16,f=!0;break;default:throw new Error("JPX Error: Invalid SQcd value "+l)}for(S.noQuantization=8===d,S.scalarExpounded=f,S.guardBits=l>>5,u=[];h<b+o;){var k={};8===d?(k.epsilon=e[h++]>>3,k.mu=0):(k.epsilon=e[h]>>3,k.mu=(7&e[h])<<8|e[h+1],h+=2),u.push(k)}S.SPqcds=u,a.mainHeader?a.QCD=S:(a.currentTile.QCD=S,a.currentTile.QCC=[]);break;case 65373:b=readUint16(e,o);var z,T={};switch(h=o+2,a.SIZ.Csiz<257?z=e[h++]:(z=readUint16(e,h),h+=2),31&(l=e[h++])){case 0:d=8,f=!0;break;case 1:d=16,f=!1;break;case 2:d=16,f=!0;break;default:throw new Error("JPX Error: Invalid SQcd value "+l)}for(T.noQuantization=8===d,T.scalarExpounded=f,T.guardBits=l>>5,u=[];h<b+o;)k={},8===d?(k.epsilon=e[h++]>>3,k.mu=0):(k.epsilon=e[h]>>3,k.mu=(7&e[h])<<8|e[h+1],h+=2),u.push(k);T.SPqcds=u,a.mainHeader?a.QCC[z]=T:a.currentTile.QCC[z]=T;break;case 65362:b=readUint16(e,o);var U={};h=o+2;var L=e[h++];U.entropyCoderWithCustomPrecincts=!!(1&L),U.sopMarkerUsed=!!(2&L),U.ephMarkerUsed=!!(4&L),U.progressionOrder=e[h++],U.layersCount=readUint16(e,h),h+=2,U.multipleComponentTransform=e[h++],U.decompositionLevelsCount=e[h++],U.xcb=2+(15&e[h++]),U.ycb=2+(15&e[h++]);var I=e[h++];if(U.selectiveArithmeticCodingBypass=!!(1&I),U.resetContextProbabilities=!!(2&I),U.terminationOnEachCodingPass=!!(4&I),U.verticalyStripe=!!(8&I),U.predictableTermination=!!(16&I),U.segmentationSymbolUsed=!!(32&I),U.reversibleTransformation=e[h++],U.entropyCoderWithCustomPrecincts){for(var O=[];h<b+o;){var X=e[h++];O.push({PPx:15&X,PPy:X>>4})}U.precinctsSizes=O}var A=[];if(U.selectiveArithmeticCodingBypass&&A.push("selectiveArithmeticCodingBypass"),U.resetContextProbabilities&&A.push("resetContextProbabilities"),U.terminationOnEachCodingPass&&A.push("terminationOnEachCodingPass"),U.verticalyStripe&&A.push("verticalyStripe"),U.predictableTermination&&A.push("predictableTermination"),A.length>0)throw s=!0,new Error("JPX Error: Unsupported COD options ("+A.join(", ")+")");a.mainHeader?a.COD=U:(a.currentTile.COD=U,a.currentTile.COC=[]);break;case 65424:b=readUint16(e,o),(v={}).index=readUint16(e,o+2),v.length=readUint32(e,o+4),v.dataEnd=v.length+o-2,v.partIndex=e[o+8],v.partsCount=e[o+9],a.mainHeader=!1,0===v.partIndex&&(v.COD=a.COD,v.COC=a.COC.slice(0),v.QCD=a.QCD,v.QCC=a.QCC.slice(0)),a.currentTile=v;break;case 65427:0===(v=a.currentTile).partIndex&&(y(a,v.index),m(a)),p(a,e,o,b=v.dataEnd-o);break;case 65365:case 65367:case 65368:case 65380:case 65363:b=readUint16(e,o);break;default:throw new Error("JPX Error: Unknown codestream code: "+c.toString(16))}o+=b}}catch(e){if(s||this.failOnCorruptedImage)throw e;warn("Trying to recover from "+e.message)}this.tiles=function(e){for(var t=e.SIZ,r=e.components,i=t.Csiz,n=[],a=0,s=e.tiles.length;a<s;a++){var o,c=e.tiles[a],h=[];for(o=0;o<i;o++)h[o]=g(e,c,o);var l,u,d,f,v,m,p,b,y,x,P,C,M,w,S,k=h[0],z=new Int16Array(k.items.length*i),T={left:k.left,top:k.top,width:k.width,height:k.height,items:z},U=0;if(c.codingStyleDefaultParameters.multipleComponentTransform){var L=4===i,I=h[0].items,O=h[1].items,X=h[2].items,A=L?h[3].items:null;u=.5+(128<<(l=r[0].precision-8)),f=-(v=.5*(d=255*(1<<l)));var D=c.components[0],E=i-3;if(p=I.length,D.codingStyleParameters.reversibleTransformation)for(m=0;m<p;m++,U+=E)b=I[m]+u,y=O[m],P=(C=b-((x=X[m])+y>>2))+x,M=C+y,z[U++]=P<=0?0:P>=d?255:P>>l,z[U++]=C<=0?0:C>=d?255:C>>l,z[U++]=M<=0?0:M>=d?255:M>>l;else for(m=0;m<p;m++,U+=E)b=I[m]+u,y=O[m],P=b+1.402*(x=X[m]),C=b-.34413*y-.71414*x,M=b+1.772*y,z[U++]=P<=0?0:P>=d?255:P>>l,z[U++]=C<=0?0:C>=d?255:C>>l,z[U++]=M<=0?0:M>=d?255:M>>l;if(L)for(m=0,U=3;m<p;m++,U+=4)w=A[m],z[U]=w<=f?0:w>=v?255:w+u>>l}else for(o=0;o<i;o++)if(8===r[o].precision){var H=h[o].items;for(u=.5+(128<<(l=r[o].precision-8)),f=-(d=127.5*(1<<l)),U=o,m=0,p=H.length;m<p;m++)S=H[m],z[U]=S<=f?0:S>=d?255:S+u>>l,U+=i}else{var B=r[o].isSigned;H=h[o].items;for(B?(l=0,u=0):u=.5+(128<<(l=r[o].precision-8)),U=o,m=0,p=H.length;m<p;m++)S=H[m],z[U]=S+u,U+=i}n.push(T)}return n}(a),this.width=a.SIZ.Xsiz-a.SIZ.XOsiz,this.height=a.SIZ.Ysiz-a.SIZ.YOsiz,this.componentsCount=a.SIZ.Csiz}};var x=function(){function e(e,t){var r=log2(Math.max(e,t))+1;this.levels=[];for(var i=0;i<r;i++){var n={width:e,height:t,items:[]};this.levels.push(n),e=Math.ceil(e/2),t=Math.ceil(t/2)}}return e.prototype={reset:function(e,t){for(var r,i=0,n=0;i<this.levels.length;){var a=e+t*(r=this.levels[i]).width;if(void 0!==r.items[a]){n=r.items[a];break}r.index=a,e>>=1,t>>=1,i++}i--,(r=this.levels[i]).items[r.index]=n,this.currentLevel=i,delete this.value},incrementValue:function(){var e=this.levels[this.currentLevel];e.items[e.index]++},nextLevel:function(){var e=this.currentLevel,t=this.levels[e],r=t.items[t.index];return--e<0?(this.value=r,!1):(this.currentLevel=e,(t=this.levels[e]).items[t.index]=r,!0)}},e}(),P=function(){function e(e,t,r){var i=log2(Math.max(e,t))+1;this.levels=[];for(var n=0;n<i;n++){for(var a=new Int16Array(e*t),s=0,o=a.length;s<o;s++)a[s]=r;var c={width:e,height:t,items:a};this.levels.push(c),e=Math.ceil(e/2),t=Math.ceil(t/2)}}return e.prototype={reset:function(e,t,r){for(var i=0;i<this.levels.length;){var n=this.levels[i],a=e+t*n.width;n.index=a;var s=n.items[a];if(255===s)break;if(s>r)return this.currentLevel=i,this.propagateValues(),!1;e>>=1,t>>=1,i++}return this.currentLevel=i-1,!0},incrementValue:function(e){var t=this.levels[this.currentLevel];t.items[t.index]=e+1,this.propagateValues()},propagateValues:function(){for(var e=this.currentLevel,t=this.levels[e],r=t.items[t.index];--e>=0;)(t=this.levels[e]).items[t.index]=r},nextLevel:function(){var e=this.currentLevel,t=this.levels[e],r=t.items[t.index];return t.items[t.index]=255,!(--e<0)&&(this.currentLevel=e,(t=this.levels[e]).items[t.index]=r,!0)}},e}(),C=function(){var e=17,t=new Uint8Array([0,5,8,0,3,7,8,0,4,7,8,0,0,0,0,0,1,6,8,0,3,7,8,0,4,7,8,0,0,0,0,0,2,6,8,0,3,7,8,0,4,7,8,0,0,0,0,0,2,6,8,0,3,7,8,0,4,7,8,0,0,0,0,0,2,6,8,0,3,7,8,0,4,7,8]),r=new Uint8Array([0,3,4,0,5,7,7,0,8,8,8,0,0,0,0,0,1,3,4,0,6,7,7,0,8,8,8,0,0,0,0,0,2,3,4,0,6,7,7,0,8,8,8,0,0,0,0,0,2,3,4,0,6,7,7,0,8,8,8,0,0,0,0,0,2,3,4,0,6,7,7,0,8,8,8]),i=new Uint8Array([0,1,2,0,1,2,2,0,2,2,2,0,0,0,0,0,3,4,5,0,4,5,5,0,5,5,5,0,0,0,0,0,6,7,7,0,7,7,7,0,7,7,7,0,0,0,0,0,8,8,8,0,8,8,8,0,8,8,8,0,0,0,0,0,8,8,8,0,8,8,8,0,8,8,8]);function n(e,n,a,s,o){this.width=e,this.height=n,this.contextLabelTable="HH"===a?i:"HL"===a?r:t;var c=e*n;this.neighborsSignificance=new Uint8Array(c),this.coefficentsSign=new Uint8Array(c),this.coefficentsMagnitude=o>14?new Uint32Array(c):o>6?new Uint16Array(c):new Uint8Array(c),this.processingFlags=new Uint8Array(c);var h=new Uint8Array(c);if(0!==s)for(var l=0;l<c;l++)h[l]=s;this.bitsDecoded=h,this.reset()}return n.prototype={setDecoder:function(e){this.decoder=e},reset:function(){this.contexts=new Int8Array(19),this.contexts[0]=8,this.contexts[17]=92,this.contexts[18]=6},setNeighborsSignificance:function(e,t,r){var i,n=this.neighborsSignificance,a=this.width,s=this.height,o=t>0,c=t+1<a;e>0&&(i=r-a,o&&(n[i-1]+=16),c&&(n[i+1]+=16),n[i]+=4),e+1<s&&(i=r+a,o&&(n[i-1]+=16),c&&(n[i+1]+=16),n[i]+=4),o&&(n[r-1]+=1),c&&(n[r+1]+=1),n[r]|=128},runSignificancePropogationPass:function(){for(var e=this.decoder,t=this.width,r=this.height,i=this.coefficentsMagnitude,n=this.coefficentsSign,a=this.neighborsSignificance,s=this.processingFlags,o=this.contexts,c=this.contextLabelTable,h=this.bitsDecoded,l=0;l<r;l+=4)for(var u=0;u<t;u++)for(var d=l*t+u,f=0;f<4;f++,d+=t){var v=l+f;if(v>=r)break;if(s[d]&=-2,!i[d]&&a[d]){var m=c[a[d]];if(e.readBit(o,m)){var p=this.decodeSignBit(v,u,d);n[d]=p,i[d]=1,this.setNeighborsSignificance(v,u,d),s[d]|=2}h[d]++,s[d]|=1}}},decodeSignBit:function(e,t,r){var i,n,a,s,o,c,h=this.width,l=this.height,u=this.coefficentsMagnitude,d=this.coefficentsSign;s=t>0&&0!==u[r-1],t+1<h&&0!==u[r+1]?(a=d[r+1],i=s?1-a-(n=d[r-1]):1-a-a):i=s?1-(n=d[r-1])-n:0;var f=3*i;return s=e>0&&0!==u[r-h],e+1<l&&0!==u[r+h]?(a=d[r+h],i=s?1-a-(n=d[r-h])+f:1-a-a+f):i=s?1-(n=d[r-h])-n+f:f,i>=0?(o=9+i,c=this.decoder.readBit(this.contexts,o)):(o=9-i,c=1^this.decoder.readBit(this.contexts,o)),c},runMagnitudeRefinementPass:function(){for(var e,t=this.decoder,r=this.width,i=this.height,n=this.coefficentsMagnitude,a=this.neighborsSignificance,s=this.contexts,o=this.bitsDecoded,c=this.processingFlags,h=r*i,l=4*r,u=0;u<h;u=e){e=Math.min(h,u+l);for(var d=0;d<r;d++)for(var f=u+d;f<e;f+=r)if(n[f]&&0==(1&c[f])){var v=16;if(0!=(2&c[f]))c[f]^=2,v=0===(127&a[f])?15:14;var m=t.readBit(s,v);n[f]=n[f]<<1|m,o[f]++,c[f]|=1}}},runCleanupPass:function(){for(var t,r=this.decoder,i=this.width,n=this.height,a=this.neighborsSignificance,s=this.coefficentsMagnitude,o=this.coefficentsSign,c=this.contexts,h=this.contextLabelTable,l=this.bitsDecoded,u=this.processingFlags,d=i,f=2*i,v=3*i,m=0;m<n;m=t){t=Math.min(m+4,n);for(var p=m*i,b=m+3<n,g=0;g<i;g++){var y,x=p+g,P=0,C=x,M=m;if(b&&0===u[x]&&0===u[x+d]&&0===u[x+f]&&0===u[x+v]&&0===a[x]&&0===a[x+d]&&0===a[x+f]&&0===a[x+v]){if(!r.readBit(c,18)){l[x]++,l[x+d]++,l[x+f]++,l[x+v]++;continue}0!==(P=r.readBit(c,e)<<1|r.readBit(c,e))&&(M=m+P,C+=P*i),y=this.decodeSignBit(M,g,C),o[C]=y,s[C]=1,this.setNeighborsSignificance(M,g,C),u[C]|=2,C=x;for(var w=m;w<=M;w++,C+=i)l[C]++;P++}for(M=m+P;M<t;M++,C+=i)if(!s[C]&&0==(1&u[C])){var S=h[a[C]];1===r.readBit(c,S)&&(y=this.decodeSignBit(M,g,C),o[C]=y,s[C]=1,this.setNeighborsSignificance(M,g,C),u[C]|=2),l[C]++}}}},checkSegmentationSymbol:function(){var t=this.decoder,r=this.contexts;if(10!==(t.readBit(r,e)<<3|t.readBit(r,e)<<2|t.readBit(r,e)<<1|t.readBit(r,e)))throw new Error("JPX Error: Invalid segmentation symbol")}},n}(),M=function(){function e(){}return e.prototype.calculate=function(e,t,r){for(var i=e[0],n=1,a=e.length;n<a;n++)i=this.iterate(i,e[n],t,r);return i},e.prototype.extend=function(e,t,r){var i=t-1,n=t+1,a=t+r-2,s=t+r;e[i--]=e[n++],e[s++]=e[a--],e[i--]=e[n++],e[s++]=e[a--],e[i--]=e[n++],e[s++]=e[a--],e[i]=e[n],e[s]=e[a]},e.prototype.iterate=function(e,t,r,i){var n,a,s,o,c,h,l=e.width,u=e.height,d=e.items,f=t.width,v=t.height,m=t.items;for(s=0,n=0;n<u;n++)for(o=2*n*f,a=0;a<l;a++,s++,o+=2)m[o]=d[s];d=e.items=null;var p=new Float32Array(f+8);if(1===f){if(0!=(1&r))for(h=0,s=0;h<v;h++,s+=f)m[s]*=.5}else for(h=0,s=0;h<v;h++,s+=f)p.set(m.subarray(s,s+f),4),this.extend(p,4,f),this.filter(p,4,f),m.set(p.subarray(4,4+f),s);var b=16,g=[];for(n=0;n<b;n++)g.push(new Float32Array(v+8));var y,x=0;if(e=4+v,1===v){if(0!=(1&i))for(c=0;c<f;c++)m[c]*=.5}else for(c=0;c<f;c++){if(0===x){for(b=Math.min(f-c,b),s=c,o=4;o<e;s+=f,o++)for(y=0;y<b;y++)g[y][o]=m[s+y];x=b}var P=g[--x];if(this.extend(P,4,v),this.filter(P,4,v),0===x)for(s=c-b+1,o=4;o<e;s+=f,o++)for(y=0;y<b;y++)m[s+y]=g[y][o]}return{width:f,height:v,items:m}},e}(),w=function(){function e(){M.call(this)}return e.prototype=Object.create(M.prototype),e.prototype.filter=function(e,t,r){var i,n,a,s,o=r>>1,c=-1.586134342059924,h=-.052980118572961,l=.882911075530934,u=.443506852043971,d=1.230174104914001;for(i=(t|=0)-3,n=o+4;n--;i+=2)e[i]*=.8128930661159609;for(a=u*e[(i=t-2)-1],n=o+3;n--&&(s=u*e[i+1],e[i]=d*e[i]-a-s,n--);i+=2)a=u*e[(i+=2)+1],e[i]=d*e[i]-a-s;for(a=l*e[(i=t-1)-1],n=o+2;n--&&(s=l*e[i+1],e[i]-=a+s,n--);i+=2)a=l*e[(i+=2)+1],e[i]-=a+s;for(a=h*e[(i=t)-1],n=o+1;n--&&(s=h*e[i+1],e[i]-=a+s,n--);i+=2)a=h*e[(i+=2)+1],e[i]-=a+s;if(0!==o)for(a=c*e[(i=t+1)-1],n=o;n--&&(s=c*e[i+1],e[i]-=a+s,n--);i+=2)a=c*e[(i+=2)+1],e[i]-=a+s},e}(),S=function(){function e(){M.call(this)}return e.prototype=Object.create(M.prototype),e.prototype.filter=function(e,t,r){var i,n,a=r>>1;for(i=t|=0,n=a+1;n--;i+=2)e[i]-=e[i-1]+e[i+1]+2>>2;for(i=t+1,n=a;n--;i+=2)e[i]+=e[i-1]+e[i+1]>>1},e}();return t}();
