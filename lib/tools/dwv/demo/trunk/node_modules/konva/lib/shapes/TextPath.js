import{Util}from"../Util.js";import{Factory}from"../Factory.js";import{Shape}from"../Shape.js";import{Path}from"./Path.js";import{Text,stringToArray}from"./Text.js";import{getNumberValidator}from"../Validators.js";import{_registerNode}from"../Global.js";var EMPTY_STRING="",NORMAL="normal";function _fillFunc(t){t.fillText(this.partialText,0,0)}function _strokeFunc(t){t.strokeText(this.partialText,0,0)}export class TextPath extends Shape{constructor(t){super(t),this.dummyCanvas=Util.createCanvasElement(),this.dataArray=[],this.dataArray=Path.parsePathData(this.attrs.data),this.on("dataChange.konva",(function(){this.dataArray=Path.parsePathData(this.attrs.data),this._setTextData()})),this.on("textChange.konva alignChange.konva letterSpacingChange.konva kerningFuncChange.konva fontSizeChange.konva fontFamilyChange.konva",this._setTextData),this._setTextData()}_sceneFunc(t){t.setAttr("font",this._getContextFont()),t.setAttr("textBaseline",this.textBaseline()),t.setAttr("textAlign","left"),t.save();var e=this.textDecoration(),a=this.fill(),r=this.fontSize(),i=this.glyphInfo;"underline"===e&&t.beginPath();for(var n=0;n<i.length;n++){t.save();var h=i[n].p0;t.translate(h.x,h.y),t.rotate(i[n].rotation),this.partialText=i[n].text,t.fillStrokeShape(this),"underline"===e&&(0===n&&t.moveTo(0,r/2+1),t.lineTo(r,r/2+1)),t.restore()}"underline"===e&&(t.strokeStyle=a,t.lineWidth=r/20,t.stroke()),t.restore()}_hitFunc(t){t.beginPath();var e=this.glyphInfo;if(e.length>=1){var a=e[0].p0;t.moveTo(a.x,a.y)}for(var r=0;r<e.length;r++){var i=e[r].p1;t.lineTo(i.x,i.y)}t.setAttr("lineWidth",this.fontSize()),t.setAttr("strokeStyle",this.colorKey),t.stroke()}getTextWidth(){return this.textWidth}getTextHeight(){return Util.warn("text.getTextHeight() method is deprecated. Use text.height() - for full height and text.fontSize() - for one line height."),this.textHeight}setText(t){return Text.prototype.setText.call(this,t)}_getContextFont(){return Text.prototype._getContextFont.call(this)}_getTextSize(t){var e=this.dummyCanvas.getContext("2d");e.save(),e.font=this._getContextFont();var a=e.measureText(t);return e.restore(),{width:a.width,height:parseInt(this.attrs.fontSize,10)}}_setTextData(){var t=this,e=this._getTextSize(this.attrs.text),a=this.letterSpacing(),r=this.align(),i=this.kerningFunc();this.textWidth=e.width,this.textHeight=e.height;var n=Math.max(this.textWidth+((this.attrs.text||"").length-1)*a,0);this.glyphInfo=[];for(var h=0,o=0;o<t.dataArray.length;o++)t.dataArray[o].pathLength>0&&(h+=t.dataArray[o].pathLength);var s=0;"center"===r&&(s=Math.max(0,h/2-n/2)),"right"===r&&(s=Math.max(0,h-n));for(var x,p,l,g=stringToArray(this.text()),d=this.text().split(" ").length-1,y=-1,c=0,f=function(){c=0;for(var e=t.dataArray,a=y+1;a<e.length;a++){if(e[a].pathLength>0)return y=a,e[a];"M"===e[a].command&&(x={x:e[a].points[0],y:e[a].points[1]})}return{}},u=function(e){var i=t._getTextSize(e).width+a;" "===e&&"justify"===r&&(i+=(h-n)/d);var o=0,s=0;for(p=void 0;Math.abs(i-o)/i>.01&&s<20;){s++;for(var g=o;void 0===l;)(l=f())&&g+l.pathLength<i&&(g+=l.pathLength,l=void 0);if(0===Object.keys(l).length||void 0===x)return;var y=!1;switch(l.command){case"L":Path.getLineLength(x.x,x.y,l.points[0],l.points[1])>i?p=Path.getPointOnLine(i,x.x,x.y,l.points[0],l.points[1],x.x,x.y):l=void 0;break;case"A":var u=l.points[4],v=l.points[5],T=l.points[4]+v;0===c?c=u+1e-8:i>o?c+=Math.PI/180*v/Math.abs(v):c-=Math.PI/360*v/Math.abs(v),(v<0&&c<T||v>=0&&c>T)&&(c=T,y=!0),p=Path.getPointOnEllipticalArc(l.points[0],l.points[1],l.points[2],l.points[3],c,l.points[6]);break;case"C":0===c?c=i>l.pathLength?1e-8:i/l.pathLength:i>o?c+=(i-o)/l.pathLength/2:c=Math.max(c-(o-i)/l.pathLength/2,0),c>1&&(c=1,y=!0),p=Path.getPointOnCubicBezier(c,l.start.x,l.start.y,l.points[0],l.points[1],l.points[2],l.points[3],l.points[4],l.points[5]);break;case"Q":0===c?c=i/l.pathLength:i>o?c+=(i-o)/l.pathLength:c-=(o-i)/l.pathLength,c>1&&(c=1,y=!0),p=Path.getPointOnQuadraticBezier(c,l.start.x,l.start.y,l.points[0],l.points[1],l.points[2],l.points[3])}void 0!==p&&(o=Path.getLineLength(x.x,x.y,p.x,p.y)),y&&(y=!1,l=void 0)}},v=s/(t._getTextSize("C").width+a)-1,T=0;T<v&&(u("C"),void 0!==x&&void 0!==p);T++)x=p;for(var m=0;m<g.length&&(u(g[m]),void 0!==x&&void 0!==p);m++){var P=Path.getLineLength(x.x,x.y,p.x,p.y),S=0;if(i)try{S=i(g[m-1],g[m])*this.fontSize()}catch(t){S=0}x.x+=S,p.x+=S,this.textWidth+=S;var F=Path.getPointOnLine(S+P/2,x.x,x.y,p.x,p.y),_=Math.atan2(p.y-x.y,p.x-x.x);this.glyphInfo.push({transposeX:F.x,transposeY:F.y,text:g[m],rotation:_,p0:x,p1:p}),x=p}}getSelfRect(){if(!this.glyphInfo.length)return{x:0,y:0,width:0,height:0};var t=[];this.glyphInfo.forEach((function(e){t.push(e.p0.x),t.push(e.p0.y),t.push(e.p1.x),t.push(e.p1.y)}));for(var e,a,r=t[0]||0,i=t[0]||0,n=t[1]||0,h=t[1]||0,o=0;o<t.length/2;o++)e=t[2*o],a=t[2*o+1],r=Math.min(r,e),i=Math.max(i,e),n=Math.min(n,a),h=Math.max(h,a);var s=this.fontSize();return{x:r-s/2,y:n-s/2,width:i-r+s,height:h-n+s}}destroy(){return Util.releaseCanvas(this.dummyCanvas),super.destroy()}}TextPath.prototype._fillFunc=_fillFunc,TextPath.prototype._strokeFunc=_strokeFunc,TextPath.prototype._fillFuncHit=_fillFunc,TextPath.prototype._strokeFuncHit=_strokeFunc,TextPath.prototype.className="TextPath",TextPath.prototype._attrsAffectingSize=["text","fontSize","data"],_registerNode(TextPath),Factory.addGetterSetter(TextPath,"data"),Factory.addGetterSetter(TextPath,"fontFamily","Arial"),Factory.addGetterSetter(TextPath,"fontSize",12,getNumberValidator()),Factory.addGetterSetter(TextPath,"fontStyle",NORMAL),Factory.addGetterSetter(TextPath,"align","left"),Factory.addGetterSetter(TextPath,"letterSpacing",0,getNumberValidator()),Factory.addGetterSetter(TextPath,"textBaseline","middle"),Factory.addGetterSetter(TextPath,"fontVariant",NORMAL),Factory.addGetterSetter(TextPath,"text",EMPTY_STRING),Factory.addGetterSetter(TextPath,"textDecoration",null),Factory.addGetterSetter(TextPath,"kerningFunc",null);
