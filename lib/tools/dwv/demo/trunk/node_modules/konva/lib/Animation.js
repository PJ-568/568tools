import{glob}from"./Global.js";import{Util}from"./Util.js";var now=glob.performance&&glob.performance.now?function(){return glob.performance.now()}:function(){return(new Date).getTime()};export class Animation{constructor(i,t){this.id=Animation.animIdCounter++,this.frame={time:0,timeDiff:0,lastTime:now(),frameRate:0},this.func=i,this.setLayers(t)}setLayers(i){var t=[];return t=i?i.length>0?i:[i]:[],this.layers=t,this}getLayers(){return this.layers}addLayer(i){var t,n=this.layers,a=n.length;for(t=0;t<a;t++)if(n[t]._id===i._id)return!1;return this.layers.push(i),!0}isRunning(){var i,t=Animation.animations,n=t.length;for(i=0;i<n;i++)if(t[i].id===this.id)return!0;return!1}start(){return this.stop(),this.frame.timeDiff=0,this.frame.lastTime=now(),Animation._addAnimation(this),this}stop(){return Animation._removeAnimation(this),this}_updateFrameObject(i){this.frame.timeDiff=i-this.frame.lastTime,this.frame.lastTime=i,this.frame.time+=this.frame.timeDiff,this.frame.frameRate=1e3/this.frame.timeDiff}static _addAnimation(i){this.animations.push(i),this._handleAnimation()}static _removeAnimation(i){var t,n=i.id,a=this.animations,e=a.length;for(t=0;t<e;t++)if(a[t].id===n){this.animations.splice(t,1);break}}static _runFrames(){var i,t,n,a,e,r,s,m,o={},h=this.animations;for(a=0;a<h.length;a++)if(t=(i=h[a]).layers,n=i.func,i._updateFrameObject(now()),r=t.length,!n||!1!==n.call(i,i.frame))for(e=0;e<r;e++)void 0!==(s=t[e])._id&&(o[s._id]=s);for(m in o)o.hasOwnProperty(m)&&o[m].batchDraw()}static _animationLoop(){var i=Animation;i.animations.length?(i._runFrames(),Util.requestAnimFrame(i._animationLoop)):i.animRunning=!1}static _handleAnimation(){this.animRunning||(this.animRunning=!0,Util.requestAnimFrame(this._animationLoop))}}Animation.animations=[],Animation.animIdCounter=0,Animation.animRunning=!1;
