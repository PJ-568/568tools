"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Kaleidoscope=void 0;const Factory_1=require("../Factory"),Node_1=require("../Node"),Util_1=require("../Util"),Validators_1=require("../Validators");var ToPolar=function(a,t,o){var r,e,d,i,l=a.data,h=t.data,s=a.width,c=a.height,n=o.polarCenterX||s/2,f=o.polarCenterY||c/2,M=0,p=0,_=0,u=0,v=Math.sqrt(n*n+f*f);e=s-n,d=c-f,v=(i=Math.sqrt(e*e+d*d))>v?i:v;var F,g,y,q,C=c,P=s,N=360/P*Math.PI/180;for(g=0;g<P;g+=1)for(y=Math.sin(g*N),q=Math.cos(g*N),F=0;F<C;F+=1)e=Math.floor(n+v*F/C*q),M=l[(r=4*((d=Math.floor(f+v*F/C*y))*s+e))+0],p=l[r+1],_=l[r+2],u=l[r+3],h[(r=4*(g+F*s))+0]=M,h[r+1]=p,h[r+2]=_,h[r+3]=u},FromPolar=function(a,t,o){var r,e,d,i,l,h,s=a.data,c=t.data,n=a.width,f=a.height,M=o.polarCenterX||n/2,p=o.polarCenterY||f/2,_=0,u=0,v=0,F=0,g=Math.sqrt(M*M+p*p);e=n-M,d=f-p,g=(h=Math.sqrt(e*e+d*d))>g?h:g;var y,q,C,P=f,N=n,w=o.polarRotation||0;for(e=0;e<n;e+=1)for(d=0;d<f;d+=1)i=e-M,l=d-p,y=Math.sqrt(i*i+l*l)*P/g,q=(q=(180*Math.atan2(l,i)/Math.PI+360+w)%360)*N/360,C=Math.floor(q),_=s[(r=4*(Math.floor(y)*n+C))+0],u=s[r+1],v=s[r+2],F=s[r+3],c[(r=4*(d*n+e))+0]=_,c[r+1]=u,c[r+2]=v,c[r+3]=F};const Kaleidoscope=function(a){var t,o,r,e,d,i,l,h,s,c=a.width,n=a.height,f=Math.round(this.kaleidoscopePower()),M=Math.round(this.kaleidoscopeAngle()),p=Math.floor(c*(M%360)/360);if(!(f<1)){var _=Util_1.Util.createCanvasElement();_.width=c,_.height=n;var u=_.getContext("2d").getImageData(0,0,c,n);Util_1.Util.releaseCanvas(_),ToPolar(a,u,{polarCenterX:c/2,polarCenterY:n/2});for(var v=c/Math.pow(2,f);v<=8;)v*=2,f-=1;var F=v=Math.ceil(v),g=0,y=F,q=1;for(p+v>c&&(g=F,y=0,q=-1),o=0;o<n;o+=1)for(t=g;t!==y;t+=q)h=4*(c*o+Math.round(t+p)%c),e=u.data[h+0],d=u.data[h+1],i=u.data[h+2],l=u.data[h+3],s=4*(c*o+t),u.data[s+0]=e,u.data[s+1]=d,u.data[s+2]=i,u.data[s+3]=l;for(o=0;o<n;o+=1)for(F=Math.floor(v),r=0;r<f;r+=1){for(t=0;t<F+1;t+=1)h=4*(c*o+t),e=u.data[h+0],d=u.data[h+1],i=u.data[h+2],l=u.data[h+3],s=4*(c*o+2*F-t-1),u.data[s+0]=e,u.data[s+1]=d,u.data[s+2]=i,u.data[s+3]=l;F*=2}FromPolar(u,a,{polarRotation:0})}};exports.Kaleidoscope=Kaleidoscope,Factory_1.Factory.addGetterSetter(Node_1.Node,"kaleidoscopePower",2,(0,Validators_1.getNumberValidator)(),Factory_1.Factory.afterSetFilter),Factory_1.Factory.addGetterSetter(Node_1.Node,"kaleidoscopeAngle",0,(0,Validators_1.getNumberValidator)(),Factory_1.Factory.afterSetFilter);
