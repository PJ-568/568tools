"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TextPath=void 0;const Util_1=require("../Util"),Factory_1=require("../Factory"),Shape_1=require("../Shape"),Path_1=require("./Path"),Text_1=require("./Text"),Validators_1=require("../Validators"),Global_1=require("../Global");var EMPTY_STRING="",NORMAL="normal";function _fillFunc(t){t.fillText(this.partialText,0,0)}function _strokeFunc(t){t.strokeText(this.partialText,0,0)}class TextPath extends Shape_1.Shape{constructor(t){super(t),this.dummyCanvas=Util_1.Util.createCanvasElement(),this.dataArray=[],this.dataArray=Path_1.Path.parsePathData(this.attrs.data),this.on("dataChange.konva",(function(){this.dataArray=Path_1.Path.parsePathData(this.attrs.data),this._setTextData()})),this.on("textChange.konva alignChange.konva letterSpacingChange.konva kerningFuncChange.konva fontSizeChange.konva fontFamilyChange.konva",this._setTextData),this._setTextData()}_sceneFunc(t){t.setAttr("font",this._getContextFont()),t.setAttr("textBaseline",this.textBaseline()),t.setAttr("textAlign","left"),t.save();var e=this.textDecoration(),a=this.fill(),r=this.fontSize(),i=this.glyphInfo;"underline"===e&&t.beginPath();for(var h=0;h<i.length;h++){t.save();var n=i[h].p0;t.translate(n.x,n.y),t.rotate(i[h].rotation),this.partialText=i[h].text,t.fillStrokeShape(this),"underline"===e&&(0===h&&t.moveTo(0,r/2+1),t.lineTo(r,r/2+1)),t.restore()}"underline"===e&&(t.strokeStyle=a,t.lineWidth=r/20,t.stroke()),t.restore()}_hitFunc(t){t.beginPath();var e=this.glyphInfo;if(e.length>=1){var a=e[0].p0;t.moveTo(a.x,a.y)}for(var r=0;r<e.length;r++){var i=e[r].p1;t.lineTo(i.x,i.y)}t.setAttr("lineWidth",this.fontSize()),t.setAttr("strokeStyle",this.colorKey),t.stroke()}getTextWidth(){return this.textWidth}getTextHeight(){return Util_1.Util.warn("text.getTextHeight() method is deprecated. Use text.height() - for full height and text.fontSize() - for one line height."),this.textHeight}setText(t){return Text_1.Text.prototype.setText.call(this,t)}_getContextFont(){return Text_1.Text.prototype._getContextFont.call(this)}_getTextSize(t){var e=this.dummyCanvas.getContext("2d");e.save(),e.font=this._getContextFont();var a=e.measureText(t);return e.restore(),{width:a.width,height:parseInt(this.attrs.fontSize,10)}}_setTextData(){var t=this,e=this._getTextSize(this.attrs.text),a=this.letterSpacing(),r=this.align(),i=this.kerningFunc();this.textWidth=e.width,this.textHeight=e.height;var h=Math.max(this.textWidth+((this.attrs.text||"").length-1)*a,0);this.glyphInfo=[];for(var n=0,o=0;o<t.dataArray.length;o++)t.dataArray[o].pathLength>0&&(n+=t.dataArray[o].pathLength);var s=0;"center"===r&&(s=Math.max(0,n/2-h/2)),"right"===r&&(s=Math.max(0,n-h));for(var x,l,p,g=(0,Text_1.stringToArray)(this.text()),d=this.text().split(" ").length-1,y=-1,c=0,_=function(){c=0;for(var e=t.dataArray,a=y+1;a<e.length;a++){if(e[a].pathLength>0)return y=a,e[a];"M"===e[a].command&&(x={x:e[a].points[0],y:e[a].points[1]})}return{}},u=function(e){var i=t._getTextSize(e).width+a;" "===e&&"justify"===r&&(i+=(n-h)/d);var o=0,s=0;for(l=void 0;Math.abs(i-o)/i>.01&&s<20;){s++;for(var g=o;void 0===p;)(p=_())&&g+p.pathLength<i&&(g+=p.pathLength,p=void 0);if(0===Object.keys(p).length||void 0===x)return;var y=!1;switch(p.command){case"L":Path_1.Path.getLineLength(x.x,x.y,p.points[0],p.points[1])>i?l=Path_1.Path.getPointOnLine(i,x.x,x.y,p.points[0],p.points[1],x.x,x.y):p=void 0;break;case"A":var u=p.points[4],f=p.points[5],P=p.points[4]+f;0===c?c=u+1e-8:i>o?c+=Math.PI/180*f/Math.abs(f):c-=Math.PI/360*f/Math.abs(f),(f<0&&c<P||f>=0&&c>P)&&(c=P,y=!0),l=Path_1.Path.getPointOnEllipticalArc(p.points[0],p.points[1],p.points[2],p.points[3],c,p.points[6]);break;case"C":0===c?c=i>p.pathLength?1e-8:i/p.pathLength:i>o?c+=(i-o)/p.pathLength/2:c=Math.max(c-(o-i)/p.pathLength/2,0),c>1&&(c=1,y=!0),l=Path_1.Path.getPointOnCubicBezier(c,p.start.x,p.start.y,p.points[0],p.points[1],p.points[2],p.points[3],p.points[4],p.points[5]);break;case"Q":0===c?c=i/p.pathLength:i>o?c+=(i-o)/p.pathLength:c-=(o-i)/p.pathLength,c>1&&(c=1,y=!0),l=Path_1.Path.getPointOnQuadraticBezier(c,p.start.x,p.start.y,p.points[0],p.points[1],p.points[2],p.points[3])}void 0!==l&&(o=Path_1.Path.getLineLength(x.x,x.y,l.x,l.y)),y&&(y=!1,p=void 0)}},f=s/(t._getTextSize("C").width+a)-1,P=0;P<f&&(u("C"),void 0!==x&&void 0!==l);P++)x=l;for(var T=0;T<g.length&&(u(g[T]),void 0!==x&&void 0!==l);T++){var v=Path_1.Path.getLineLength(x.x,x.y,l.x,l.y),F=0;if(i)try{F=i(g[T-1],g[T])*this.fontSize()}catch(t){F=0}x.x+=F,l.x+=F,this.textWidth+=F;var S=Path_1.Path.getPointOnLine(F+v/2,x.x,x.y,l.x,l.y),m=Math.atan2(l.y-x.y,l.x-x.x);this.glyphInfo.push({transposeX:S.x,transposeY:S.y,text:g[T],rotation:m,p0:x,p1:l}),x=l}}getSelfRect(){if(!this.glyphInfo.length)return{x:0,y:0,width:0,height:0};var t=[];this.glyphInfo.forEach((function(e){t.push(e.p0.x),t.push(e.p0.y),t.push(e.p1.x),t.push(e.p1.y)}));for(var e,a,r=t[0]||0,i=t[0]||0,h=t[1]||0,n=t[1]||0,o=0;o<t.length/2;o++)e=t[2*o],a=t[2*o+1],r=Math.min(r,e),i=Math.max(i,e),h=Math.min(h,a),n=Math.max(n,a);var s=this.fontSize();return{x:r-s/2,y:h-s/2,width:i-r+s,height:n-h+s}}destroy(){return Util_1.Util.releaseCanvas(this.dummyCanvas),super.destroy()}}exports.TextPath=TextPath,TextPath.prototype._fillFunc=_fillFunc,TextPath.prototype._strokeFunc=_strokeFunc,TextPath.prototype._fillFuncHit=_fillFunc,TextPath.prototype._strokeFuncHit=_strokeFunc,TextPath.prototype.className="TextPath",TextPath.prototype._attrsAffectingSize=["text","fontSize","data"],(0,Global_1._registerNode)(TextPath),Factory_1.Factory.addGetterSetter(TextPath,"data"),Factory_1.Factory.addGetterSetter(TextPath,"fontFamily","Arial"),Factory_1.Factory.addGetterSetter(TextPath,"fontSize",12,(0,Validators_1.getNumberValidator)()),Factory_1.Factory.addGetterSetter(TextPath,"fontStyle",NORMAL),Factory_1.Factory.addGetterSetter(TextPath,"align","left"),Factory_1.Factory.addGetterSetter(TextPath,"letterSpacing",0,(0,Validators_1.getNumberValidator)()),Factory_1.Factory.addGetterSetter(TextPath,"textBaseline","middle"),Factory_1.Factory.addGetterSetter(TextPath,"fontVariant",NORMAL),Factory_1.Factory.addGetterSetter(TextPath,"text",EMPTY_STRING),Factory_1.Factory.addGetterSetter(TextPath,"textDecoration",null),Factory_1.Factory.addGetterSetter(TextPath,"kerningFunc",null);
