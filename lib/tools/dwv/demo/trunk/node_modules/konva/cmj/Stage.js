"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Stage=exports.stages=void 0;const Util_1=require("./Util"),Factory_1=require("./Factory"),Container_1=require("./Container"),Global_1=require("./Global"),Canvas_1=require("./Canvas"),DragAndDrop_1=require("./DragAndDrop"),Global_2=require("./Global"),PointerEvents=require("./PointerEvents");var STAGE="Stage",STRING="string",PX="px",MOUSEOUT="mouseout",MOUSELEAVE="mouseleave",MOUSEOVER="mouseover",MOUSEENTER="mouseenter",MOUSEMOVE="mousemove",MOUSEDOWN="mousedown",MOUSEUP="mouseup",POINTERMOVE="pointermove",POINTERDOWN="pointerdown",POINTERUP="pointerup",POINTERCANCEL="pointercancel",LOSTPOINTERCAPTURE="lostpointercapture",POINTEROUT="pointerout",POINTERLEAVE="pointerleave",POINTEROVER="pointerover",POINTERENTER="pointerenter",CONTEXTMENU="contextmenu",TOUCHSTART="touchstart",TOUCHEND="touchend",TOUCHMOVE="touchmove",TOUCHCANCEL="touchcancel",WHEEL="wheel",MAX_LAYERS_NUMBER=5,EVENTS=[[MOUSEENTER,"_pointerenter"],[MOUSEDOWN,"_pointerdown"],[MOUSEMOVE,"_pointermove"],[MOUSEUP,"_pointerup"],[MOUSELEAVE,"_pointerleave"],[TOUCHSTART,"_pointerdown"],[TOUCHMOVE,"_pointermove"],[TOUCHEND,"_pointerup"],[TOUCHCANCEL,"_pointercancel"],[MOUSEOVER,"_pointerover"],[WHEEL,"_wheel"],[CONTEXTMENU,"_contextmenu"],[POINTERDOWN,"_pointerdown"],[POINTERMOVE,"_pointermove"],[POINTERUP,"_pointerup"],[POINTERCANCEL,"_pointercancel"],[LOSTPOINTERCAPTURE,"_lostpointercapture"]];const EVENTS_MAP={mouse:{[POINTEROUT]:MOUSEOUT,[POINTERLEAVE]:MOUSELEAVE,[POINTEROVER]:MOUSEOVER,[POINTERENTER]:MOUSEENTER,[POINTERMOVE]:MOUSEMOVE,[POINTERDOWN]:MOUSEDOWN,[POINTERUP]:MOUSEUP,[POINTERCANCEL]:"mousecancel",pointerclick:"click",pointerdblclick:"dblclick"},touch:{[POINTEROUT]:"touchout",[POINTERLEAVE]:"touchleave",[POINTEROVER]:"touchover",[POINTERENTER]:"touchenter",[POINTERMOVE]:TOUCHMOVE,[POINTERDOWN]:TOUCHSTART,[POINTERUP]:TOUCHEND,[POINTERCANCEL]:TOUCHCANCEL,pointerclick:"tap",pointerdblclick:"dbltap"},pointer:{[POINTEROUT]:POINTEROUT,[POINTERLEAVE]:POINTERLEAVE,[POINTEROVER]:POINTEROVER,[POINTERENTER]:POINTERENTER,[POINTERMOVE]:POINTERMOVE,[POINTERDOWN]:POINTERDOWN,[POINTERUP]:POINTERUP,[POINTERCANCEL]:POINTERCANCEL,pointerclick:"pointerclick",pointerdblclick:"pointerdblclick"}},getEventType=t=>t.indexOf("pointer")>=0?"pointer":t.indexOf("touch")>=0?"touch":"mouse",getEventsMap=t=>{const e=getEventType(t);return"pointer"===e?Global_1.Konva.pointerEventsEnabled&&EVENTS_MAP.pointer:"touch"===e?EVENTS_MAP.touch:"mouse"===e?EVENTS_MAP.mouse:void 0};function checkNoClip(t={}){return(t.clipFunc||t.clipWidth||t.clipHeight)&&Util_1.Util.warn("Stage does not support clipping. Please use clip for Layers or Groups."),t}const NO_POINTERS_MESSAGE="Pointer position is missing and not registered by the stage. Looks like it is outside of the stage container. You can set it manually from event: stage.setPointersPositions(event);";exports.stages=[];class Stage extends Container_1.Container{constructor(t){super(checkNoClip(t)),this._pointerPositions=[],this._changedPointerPositions=[],this._buildDOM(),this._bindContentEvents(),exports.stages.push(this),this.on("widthChange.konva heightChange.konva",this._resizeDOM),this.on("visibleChange.konva",this._checkVisibility),this.on("clipWidthChange.konva clipHeightChange.konva clipFuncChange.konva",(()=>{checkNoClip(this.attrs)})),this._checkVisibility()}_validateAdd(t){const e="Layer"===t.getType(),i="FastLayer"===t.getType();e||i||Util_1.Util.throw("You may only add layers to the stage.")}_checkVisibility(){if(!this.content)return;const t=this.visible()?"":"none";this.content.style.display=t}setContainer(t){if(typeof t===STRING){if("."===t.charAt(0)){var e=t.slice(1);t=document.getElementsByClassName(e)[0]}else{var i;i="#"!==t.charAt(0)?t:t.slice(1),t=document.getElementById(i)}if(!t)throw"Can not find container in document with id "+i}return this._setAttr("container",t),this.content&&(this.content.parentElement&&this.content.parentElement.removeChild(this.content),t.appendChild(this.content)),this}shouldDrawHit(){return!0}clear(){var t,e=this.children,i=e.length;for(t=0;t<i;t++)e[t].clear();return this}clone(t){return t||(t={}),t.container="undefined"!=typeof document&&document.createElement("div"),Container_1.Container.prototype.clone.call(this,t)}destroy(){super.destroy();var t=this.content;t&&Util_1.Util._isInDocument(t)&&this.container().removeChild(t);var e=exports.stages.indexOf(this);return e>-1&&exports.stages.splice(e,1),Util_1.Util.releaseCanvas(this.bufferCanvas._canvas,this.bufferHitCanvas._canvas),this}getPointerPosition(){const t=this._pointerPositions[0]||this._changedPointerPositions[0];return t?{x:t.x,y:t.y}:(Util_1.Util.warn(NO_POINTERS_MESSAGE),null)}_getPointerById(t){return this._pointerPositions.find((e=>e.id===t))}getPointersPositions(){return this._pointerPositions}getStage(){return this}getContent(){return this.content}_toKonvaCanvas(t){(t=t||{}).x=t.x||0,t.y=t.y||0,t.width=t.width||this.width(),t.height=t.height||this.height();var e=new Canvas_1.SceneCanvas({width:t.width,height:t.height,pixelRatio:t.pixelRatio||1}),i=e.getContext()._context,n=this.children;return(t.x||t.y)&&i.translate(-1*t.x,-1*t.y),n.forEach((function(e){if(e.isVisible()){var n=e._toKonvaCanvas(t);i.drawImage(n._canvas,t.x,t.y,n.getWidth()/n.getPixelRatio(),n.getHeight()/n.getPixelRatio())}})),e}getIntersection(t){if(!t)return null;var e,i=this.children;for(e=i.length-1;e>=0;e--){const n=i[e].getIntersection(t);if(n)return n}return null}_resizeDOM(){var t=this.width(),e=this.height();this.content&&(this.content.style.width=t+PX,this.content.style.height=e+PX),this.bufferCanvas.setSize(t,e),this.bufferHitCanvas.setSize(t,e),this.children.forEach((i=>{i.setSize({width:t,height:e}),i.draw()}))}add(t,...e){if(arguments.length>1){for(var i=0;i<arguments.length;i++)this.add(arguments[i]);return this}super.add(t);var n=this.children.length;return n>MAX_LAYERS_NUMBER&&Util_1.Util.warn("The stage has "+n+" layers. Recommended maximum number of layers is 3-5. Adding more layers into the stage may drop the performance. Rethink your tree structure, you can use Konva.Group."),t.setSize({width:this.width(),height:this.height()}),t.draw(),Global_1.Konva.isBrowser&&this.content.appendChild(t.canvas._canvas),this}getParent(){return null}getLayer(){return null}hasPointerCapture(t){return PointerEvents.hasPointerCapture(t,this)}setPointerCapture(t){PointerEvents.setPointerCapture(t,this)}releaseCapture(t){PointerEvents.releaseCapture(t,this)}getLayers(){return this.children}_bindContentEvents(){Global_1.Konva.isBrowser&&EVENTS.forEach((([t,e])=>{this.content.addEventListener(t,(t=>{this[e](t)}),{passive:!1})}))}_pointerenter(t){this.setPointersPositions(t);const e=getEventsMap(t.type);this._fire(e.pointerenter,{evt:t,target:this,currentTarget:this})}_pointerover(t){this.setPointersPositions(t);const e=getEventsMap(t.type);this._fire(e.pointerover,{evt:t,target:this,currentTarget:this})}_getTargetShape(t){let e=this[t+"targetShape"];return e&&!e.getStage()&&(e=null),e}_pointerleave(t){const e=getEventsMap(t.type),i=getEventType(t.type);if(e){this.setPointersPositions(t);var n=this._getTargetShape(i),r=!DragAndDrop_1.DD.isDragging||Global_1.Konva.hitOnDragEnabled;n&&r?(n._fireAndBubble(e.pointerout,{evt:t}),n._fireAndBubble(e.pointerleave,{evt:t}),this._fire(e.pointerleave,{evt:t,target:this,currentTarget:this}),this[i+"targetShape"]=null):r&&(this._fire(e.pointerleave,{evt:t,target:this,currentTarget:this}),this._fire(e.pointerout,{evt:t,target:this,currentTarget:this})),this.pointerPos=void 0,this._pointerPositions=[]}}_pointerdown(t){const e=getEventsMap(t.type),i=getEventType(t.type);if(e){this.setPointersPositions(t);var n=!1;this._changedPointerPositions.forEach((r=>{var o=this.getIntersection(r);DragAndDrop_1.DD.justDragged=!1,Global_1.Konva["_"+i+"ListenClick"]=!0;if(!(o&&o.isListening()))return;Global_1.Konva.capturePointerEventsEnabled&&o.setPointerCapture(r.id),this[i+"ClickStartShape"]=o,o._fireAndBubble(e.pointerdown,{evt:t,pointerId:r.id}),n=!0;const s=t.type.indexOf("touch")>=0;o.preventDefault()&&t.cancelable&&s&&t.preventDefault()})),n||this._fire(e.pointerdown,{evt:t,target:this,currentTarget:this,pointerId:this._pointerPositions[0].id})}}_pointermove(t){const e=getEventsMap(t.type),i=getEventType(t.type);if(!e)return;if(DragAndDrop_1.DD.isDragging&&DragAndDrop_1.DD.node.preventDefault()&&t.cancelable&&t.preventDefault(),this.setPointersPositions(t),!(!DragAndDrop_1.DD.isDragging||Global_1.Konva.hitOnDragEnabled))return;var n={};let r=!1;var o=this._getTargetShape(i);this._changedPointerPositions.forEach((s=>{const a=PointerEvents.getCapturedShape(s.id)||this.getIntersection(s),h=s.id,l={evt:t,pointerId:h};var c=o!==a;if(c&&o&&(o._fireAndBubble(e.pointerout,Object.assign({},l),a),o._fireAndBubble(e.pointerleave,Object.assign({},l),a)),a){if(n[a._id])return;n[a._id]=!0}a&&a.isListening()?(r=!0,c&&(a._fireAndBubble(e.pointerover,Object.assign({},l),o),a._fireAndBubble(e.pointerenter,Object.assign({},l),o),this[i+"targetShape"]=a),a._fireAndBubble(e.pointermove,Object.assign({},l))):o&&(this._fire(e.pointerover,{evt:t,target:this,currentTarget:this,pointerId:h}),this[i+"targetShape"]=null)})),r||this._fire(e.pointermove,{evt:t,target:this,currentTarget:this,pointerId:this._changedPointerPositions[0].id})}_pointerup(t){const e=getEventsMap(t.type),i=getEventType(t.type);if(!e)return;this.setPointersPositions(t);const n=this[i+"ClickStartShape"],r=this[i+"ClickEndShape"];var o={};let s=!1;this._changedPointerPositions.forEach((a=>{const h=PointerEvents.getCapturedShape(a.id)||this.getIntersection(a);if(h){if(h.releaseCapture(a.id),o[h._id])return;o[h._id]=!0}const l=a.id,c={evt:t,pointerId:l};let p=!1;Global_1.Konva["_"+i+"InDblClickWindow"]?(p=!0,clearTimeout(this[i+"DblTimeout"])):DragAndDrop_1.DD.justDragged||(Global_1.Konva["_"+i+"InDblClickWindow"]=!0,clearTimeout(this[i+"DblTimeout"])),this[i+"DblTimeout"]=setTimeout((function(){Global_1.Konva["_"+i+"InDblClickWindow"]=!1}),Global_1.Konva.dblClickWindow),h&&h.isListening()?(s=!0,this[i+"ClickEndShape"]=h,h._fireAndBubble(e.pointerup,Object.assign({},c)),Global_1.Konva["_"+i+"ListenClick"]&&n&&n===h&&(h._fireAndBubble(e.pointerclick,Object.assign({},c)),p&&r&&r===h&&h._fireAndBubble(e.pointerdblclick,Object.assign({},c)))):(this[i+"ClickEndShape"]=null,Global_1.Konva["_"+i+"ListenClick"]&&this._fire(e.pointerclick,{evt:t,target:this,currentTarget:this,pointerId:l}),p&&this._fire(e.pointerdblclick,{evt:t,target:this,currentTarget:this,pointerId:l}))})),s||this._fire(e.pointerup,{evt:t,target:this,currentTarget:this,pointerId:this._changedPointerPositions[0].id}),Global_1.Konva["_"+i+"ListenClick"]=!1,t.cancelable&&"touch"!==i&&t.preventDefault()}_contextmenu(t){this.setPointersPositions(t);var e=this.getIntersection(this.getPointerPosition());e&&e.isListening()?e._fireAndBubble(CONTEXTMENU,{evt:t}):this._fire(CONTEXTMENU,{evt:t,target:this,currentTarget:this})}_wheel(t){this.setPointersPositions(t);var e=this.getIntersection(this.getPointerPosition());e&&e.isListening()?e._fireAndBubble(WHEEL,{evt:t}):this._fire(WHEEL,{evt:t,target:this,currentTarget:this})}_pointercancel(t){this.setPointersPositions(t);const e=PointerEvents.getCapturedShape(t.pointerId)||this.getIntersection(this.getPointerPosition());e&&e._fireAndBubble(POINTERUP,PointerEvents.createEvent(t)),PointerEvents.releaseCapture(t.pointerId)}_lostpointercapture(t){PointerEvents.releaseCapture(t.pointerId)}setPointersPositions(t){var e=this._getContentPosition(),i=null,n=null;void 0!==(t=t||window.event).touches?(this._pointerPositions=[],this._changedPointerPositions=[],Array.prototype.forEach.call(t.touches,(t=>{this._pointerPositions.push({id:t.identifier,x:(t.clientX-e.left)/e.scaleX,y:(t.clientY-e.top)/e.scaleY})})),Array.prototype.forEach.call(t.changedTouches||t.touches,(t=>{this._changedPointerPositions.push({id:t.identifier,x:(t.clientX-e.left)/e.scaleX,y:(t.clientY-e.top)/e.scaleY})}))):(i=(t.clientX-e.left)/e.scaleX,n=(t.clientY-e.top)/e.scaleY,this.pointerPos={x:i,y:n},this._pointerPositions=[{x:i,y:n,id:Util_1.Util._getFirstPointerId(t)}],this._changedPointerPositions=[{x:i,y:n,id:Util_1.Util._getFirstPointerId(t)}])}_setPointerPosition(t){Util_1.Util.warn('Method _setPointerPosition is deprecated. Use "stage.setPointersPositions(event)" instead.'),this.setPointersPositions(t)}_getContentPosition(){if(!this.content||!this.content.getBoundingClientRect)return{top:0,left:0,scaleX:1,scaleY:1};var t=this.content.getBoundingClientRect();return{top:t.top,left:t.left,scaleX:t.width/this.content.clientWidth||1,scaleY:t.height/this.content.clientHeight||1}}_buildDOM(){if(this.bufferCanvas=new Canvas_1.SceneCanvas({width:this.width(),height:this.height()}),this.bufferHitCanvas=new Canvas_1.HitCanvas({pixelRatio:1,width:this.width(),height:this.height()}),Global_1.Konva.isBrowser){var t=this.container();if(!t)throw"Stage has no container. A container is required.";t.innerHTML="",this.content=document.createElement("div"),this.content.style.position="relative",this.content.style.userSelect="none",this.content.className="konvajs-content",this.content.setAttribute("role","presentation"),t.appendChild(this.content),this._resizeDOM()}}cache(){return Util_1.Util.warn("Cache function is not allowed for stage. You may use cache only for layers, groups and shapes."),this}clearCache(){return this}batchDraw(){return this.getChildren().forEach((function(t){t.batchDraw()})),this}}exports.Stage=Stage,Stage.prototype.nodeType=STAGE,(0,Global_2._registerNode)(Stage),Factory_1.Factory.addGetterSetter(Stage,"container");
