"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Text=exports.stringToArray=void 0;const Util_1=require("../Util"),Factory_1=require("../Factory"),Shape_1=require("../Shape"),Validators_1=require("../Validators"),Global_1=require("../Global");function stringToArray(t){return Array.from(t)}exports.stringToArray=stringToArray;var dummyContext,AUTO="auto",CENTER="center",JUSTIFY="justify",CHANGE_KONVA="Change.konva",CONTEXT_2D="2d",DASH="-",LEFT="left",TEXT="text",TEXT_UPPER="Text",TOP="top",BOTTOM="bottom",MIDDLE="middle",NORMAL="normal",PX_SPACE="px ",SPACE=" ",RIGHT="right",WORD="word",CHAR="char",NONE="none",ELLIPSIS="â€¦",ATTR_CHANGE_LIST=["fontFamily","fontSize","fontStyle","fontVariant","padding","align","verticalAlign","lineHeight","text","width","height","wrap","ellipsis","letterSpacing"],attrChangeListLen=ATTR_CHANGE_LIST.length;function normalizeFontFamily(t){return t.split(",").map((t=>{const e=(t=t.trim()).indexOf(" ")>=0,i=t.indexOf('"')>=0||t.indexOf("'")>=0;return e&&!i&&(t=`"${t}"`),t})).join(", ")}function getDummyContext(){return dummyContext||(dummyContext=Util_1.Util.createCanvasElement().getContext(CONTEXT_2D))}function _fillFunc(t){t.fillText(this._partialText,this._partialTextX,this._partialTextY)}function _strokeFunc(t){t.strokeText(this._partialText,this._partialTextX,this._partialTextY)}function checkDefaultFill(t){return(t=t||{}).fillLinearGradientColorStops||t.fillRadialGradientColorStops||t.fillPatternImage||(t.fill=t.fill||"black"),t}class Text extends Shape_1.Shape{constructor(t){super(checkDefaultFill(t)),this._partialTextX=0,this._partialTextY=0;for(var e=0;e<attrChangeListLen;e++)this.on(ATTR_CHANGE_LIST[e]+CHANGE_KONVA,this._setTextData);this._setTextData()}_sceneFunc(t){var e=this.textArr,i=e.length;if(this.text()){var r,a=this.padding(),s=this.fontSize(),h=this.lineHeight()*s,n=this.verticalAlign(),o=0,l=this.align(),d=this.getWidth(),x=this.letterSpacing(),g=this.fill(),T=this.textDecoration(),_=-1!==T.indexOf("underline"),c=-1!==T.indexOf("line-through"),p=0,S=(p=h/2,0),f=0;for(t.setAttr("font",this._getContextFont()),t.setAttr("textBaseline",MIDDLE),t.setAttr("textAlign",LEFT),n===MIDDLE?o=(this.getHeight()-i*h-2*a)/2:n===BOTTOM&&(o=this.getHeight()-i*h-2*a),t.translate(a,o+a),r=0;r<i;r++){S=0,f=0;var u,A,y,F=e[r],m=F.text,E=F.width,v=F.lastInParagraph;if(t.save(),l===RIGHT?S+=d-E-2*a:l===CENTER&&(S+=(d-E-2*a)/2),_){t.save(),t.beginPath(),t.moveTo(S,p+f+Math.round(s/2)),A=0===(u=m.split(" ").length-1),y=l!==JUSTIFY||v?E:d-2*a,t.lineTo(S+Math.round(y),p+f+Math.round(s/2)),t.lineWidth=s/15;const e=this._getLinearGradient();t.strokeStyle=e||g,t.stroke(),t.restore()}if(c){t.save(),t.beginPath(),t.moveTo(S,p+f),A=0===(u=m.split(" ").length-1),y=l===JUSTIFY&&v&&!A?d-2*a:E,t.lineTo(S+Math.round(y),p+f),t.lineWidth=s/15;const e=this._getLinearGradient();t.strokeStyle=e||g,t.stroke(),t.restore()}if(0!==x||l===JUSTIFY){u=m.split(" ").length-1;for(var L=stringToArray(m),C=0;C<L.length;C++){var O=L[C];" "!==O||v||l!==JUSTIFY||(S+=(d-2*a-E)/u),this._partialTextX=S,this._partialTextY=p+f,this._partialText=O,t.fillStrokeShape(this),S+=this.measureSize(O).width+x}}else this._partialTextX=S,this._partialTextY=p+f,this._partialText=m,t.fillStrokeShape(this);t.restore(),i>1&&(p+=h)}}}_hitFunc(t){var e=this.getWidth(),i=this.getHeight();t.beginPath(),t.rect(0,0,e,i),t.closePath(),t.fillStrokeShape(this)}setText(t){var e=Util_1.Util._isString(t)?t:null==t?"":t+"";return this._setAttr(TEXT,e),this}getWidth(){return this.attrs.width===AUTO||void 0===this.attrs.width?this.getTextWidth()+2*this.padding():this.attrs.width}getHeight(){return this.attrs.height===AUTO||void 0===this.attrs.height?this.fontSize()*this.textArr.length*this.lineHeight()+2*this.padding():this.attrs.height}getTextWidth(){return this.textWidth}getTextHeight(){return Util_1.Util.warn("text.getTextHeight() method is deprecated. Use text.height() - for full height and text.fontSize() - for one line height."),this.textHeight}measureSize(t){var e,i=getDummyContext(),r=this.fontSize();return i.save(),i.font=this._getContextFont(),e=i.measureText(t),i.restore(),{width:e.width,height:r}}_getContextFont(){return this.fontStyle()+SPACE+this.fontVariant()+SPACE+(this.fontSize()+PX_SPACE)+normalizeFontFamily(this.fontFamily())}_addTextLine(t){this.align()===JUSTIFY&&(t=t.trim());var e=this._getTextWidth(t);return this.textArr.push({text:t,width:e,lastInParagraph:!1})}_getTextWidth(t){var e=this.letterSpacing(),i=t.length;return getDummyContext().measureText(t).width+(i?e*(i-1):0)}_setTextData(){var t=this.text().split("\n"),e=+this.fontSize(),i=0,r=this.lineHeight()*e,a=this.attrs.width,s=this.attrs.height,h=a!==AUTO&&void 0!==a,n=s!==AUTO&&void 0!==s,o=this.padding(),l=a-2*o,d=s-2*o,x=0,g=this.wrap(),T=g!==CHAR&&g!==NONE,_=this.ellipsis();this.textArr=[],getDummyContext().font=this._getContextFont();for(var c=_?this._getTextWidth(ELLIPSIS):0,p=0,S=t.length;p<S;++p){var f=t[p],u=this._getTextWidth(f);if(h&&u>l)for(;f.length>0;){for(var A=0,y=f.length,F="",m=0;A<y;){var E=A+y>>>1,v=f.slice(0,E+1),L=this._getTextWidth(v)+c;L<=l?(A=E+1,F=v,m=L):y=E}if(!F)break;if(T){var C,O=f[F.length];(C=(O===SPACE||O===DASH)&&m<=l?F.length:Math.max(F.lastIndexOf(SPACE),F.lastIndexOf(DASH))+1)>0&&(A=C,F=F.slice(0,A),m=this._getTextWidth(F))}if(F=F.trimRight(),this._addTextLine(F),i=Math.max(i,m),x+=r,this._shouldHandleEllipsis(x)){this._tryToAddEllipsisToLastLine();break}if((f=(f=f.slice(A)).trimLeft()).length>0&&(u=this._getTextWidth(f))<=l){this._addTextLine(f),x+=r,i=Math.max(i,u);break}}else this._addTextLine(f),x+=r,i=Math.max(i,u),this._shouldHandleEllipsis(x)&&p<S-1&&this._tryToAddEllipsisToLastLine();if(this.textArr[this.textArr.length-1]&&(this.textArr[this.textArr.length-1].lastInParagraph=!0),n&&x+r>d)break}this.textHeight=e,this.textWidth=i}_shouldHandleEllipsis(t){var e=+this.fontSize(),i=this.lineHeight()*e,r=this.attrs.height,a=r!==AUTO&&void 0!==r,s=r-2*this.padding();return!(this.wrap()!==NONE)||a&&t+i>s}_tryToAddEllipsisToLastLine(){var t=this.attrs.width,e=t!==AUTO&&void 0!==t,i=t-2*this.padding(),r=this.ellipsis(),a=this.textArr[this.textArr.length-1];if(a&&r){if(e)this._getTextWidth(a.text+ELLIPSIS)<i||(a.text=a.text.slice(0,a.text.length-3));this.textArr.splice(this.textArr.length-1,1),this._addTextLine(a.text+ELLIPSIS)}}getStrokeScaleEnabled(){return!0}}exports.Text=Text,Text.prototype._fillFunc=_fillFunc,Text.prototype._strokeFunc=_strokeFunc,Text.prototype.className=TEXT_UPPER,Text.prototype._attrsAffectingSize=["text","fontSize","padding","wrap","lineHeight","letterSpacing"],(0,Global_1._registerNode)(Text),Factory_1.Factory.overWriteSetter(Text,"width",(0,Validators_1.getNumberOrAutoValidator)()),Factory_1.Factory.overWriteSetter(Text,"height",(0,Validators_1.getNumberOrAutoValidator)()),Factory_1.Factory.addGetterSetter(Text,"fontFamily","Arial"),Factory_1.Factory.addGetterSetter(Text,"fontSize",12,(0,Validators_1.getNumberValidator)()),Factory_1.Factory.addGetterSetter(Text,"fontStyle",NORMAL),Factory_1.Factory.addGetterSetter(Text,"fontVariant",NORMAL),Factory_1.Factory.addGetterSetter(Text,"padding",0,(0,Validators_1.getNumberValidator)()),Factory_1.Factory.addGetterSetter(Text,"align",LEFT),Factory_1.Factory.addGetterSetter(Text,"verticalAlign",TOP),Factory_1.Factory.addGetterSetter(Text,"lineHeight",1,(0,Validators_1.getNumberValidator)()),Factory_1.Factory.addGetterSetter(Text,"wrap",WORD),Factory_1.Factory.addGetterSetter(Text,"ellipsis",!1,(0,Validators_1.getBooleanValidator)()),Factory_1.Factory.addGetterSetter(Text,"letterSpacing",0,(0,Validators_1.getNumberValidator)()),Factory_1.Factory.addGetterSetter(Text,"text","",(0,Validators_1.getStringValidator)()),Factory_1.Factory.addGetterSetter(Text,"textDecoration","");
