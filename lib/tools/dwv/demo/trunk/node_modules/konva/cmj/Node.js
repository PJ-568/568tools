"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Node=void 0;const Util_1=require("./Util"),Factory_1=require("./Factory"),Canvas_1=require("./Canvas"),Global_1=require("./Global"),DragAndDrop_1=require("./DragAndDrop"),Validators_1=require("./Validators");var ABSOLUTE_OPACITY="absoluteOpacity",ALL_LISTENERS="allEventListeners",ABSOLUTE_TRANSFORM="absoluteTransform",ABSOLUTE_SCALE="absoluteScale",CANVAS="canvas",CHANGE="Change",CHILDREN="children",KONVA="konva",LISTENING="listening",MOUSEENTER="mouseenter",MOUSELEAVE="mouseleave",NAME="name",SET="set",SHAPE="Shape",SPACE=" ",STAGE="stage",TRANSFORM="transform",UPPER_STAGE="Stage",VISIBLE="visible",TRANSFORM_CHANGE_STR=["xChange.konva","yChange.konva","scaleXChange.konva","scaleYChange.konva","skewXChange.konva","skewYChange.konva","rotationChange.konva","offsetXChange.konva","offsetYChange.konva","transformsEnabledChange.konva"].join(SPACE);let idCounter=1;class Node{constructor(t){this._id=idCounter++,this.eventListeners={},this.attrs={},this.index=0,this._allEventListeners=null,this.parent=null,this._cache=new Map,this._attachedDepsListeners=new Map,this._lastPos=null,this._batchingTransformChange=!1,this._needClearTransformCache=!1,this._filterUpToDate=!1,this._isUnderCache=!1,this._dragEventId=null,this._shouldFireChangeEvents=!1,this.setAttrs(t),this._shouldFireChangeEvents=!0}hasChildren(){return!1}_clearCache(t){t!==TRANSFORM&&t!==ABSOLUTE_TRANSFORM||!this._cache.get(t)?t?this._cache.delete(t):this._cache.clear():this._cache.get(t).dirty=!0}_getCache(t,e){var i=this._cache.get(t);return(void 0===i||(t===TRANSFORM||t===ABSOLUTE_TRANSFORM)&&!0===i.dirty)&&(i=e.call(this),this._cache.set(t,i)),i}_calculate(t,e,i){if(!this._attachedDepsListeners.get(t)){const i=e.map((t=>t+"Change.konva")).join(SPACE);this.on(i,(()=>{this._clearCache(t)})),this._attachedDepsListeners.set(t,!0)}return this._getCache(t,i)}_getCanvasCache(){return this._cache.get(CANVAS)}_clearSelfAndDescendantCache(t){this._clearCache(t),t===ABSOLUTE_TRANSFORM&&this.fire("absoluteTransformChange")}clearCache(){if(this._cache.has(CANVAS)){const{scene:t,filter:e,hit:i}=this._cache.get(CANVAS);Util_1.Util.releaseCanvas(t,e,i),this._cache.delete(CANVAS)}return this._clearSelfAndDescendantCache(),this._requestDraw(),this}cache(t){var e=t||{},i={};void 0!==e.x&&void 0!==e.y&&void 0!==e.width&&void 0!==e.height||(i=this.getClientRect({skipTransform:!0,relativeTo:this.getParent()}));var r=Math.ceil(e.width||i.width),a=Math.ceil(e.height||i.height),s=e.pixelRatio,n=void 0===e.x?Math.floor(i.x):e.x,o=void 0===e.y?Math.floor(i.y):e.y,h=e.offset||0,l=e.drawBorder||!1,d=e.hitCanvasPixelRatio||1;if(r&&a){r+=2*h+1,a+=2*h+1,n-=h,o-=h;var c=new Canvas_1.SceneCanvas({pixelRatio:s,width:r,height:a}),g=new Canvas_1.SceneCanvas({pixelRatio:s,width:0,height:0}),_=new Canvas_1.HitCanvas({pixelRatio:d,width:r,height:a}),f=c.getContext(),u=_.getContext();return _.isCache=!0,c.isCache=!0,this._cache.delete(CANVAS),this._filterUpToDate=!1,!1===e.imageSmoothingEnabled&&(c.getContext()._context.imageSmoothingEnabled=!1,g.getContext()._context.imageSmoothingEnabled=!1),f.save(),u.save(),f.translate(-n,-o),u.translate(-n,-o),this._isUnderCache=!0,this._clearSelfAndDescendantCache(ABSOLUTE_OPACITY),this._clearSelfAndDescendantCache(ABSOLUTE_SCALE),this.drawScene(c,this),this.drawHit(_,this),this._isUnderCache=!1,f.restore(),u.restore(),l&&(f.save(),f.beginPath(),f.rect(0,0,r,a),f.closePath(),f.setAttr("strokeStyle","red"),f.setAttr("lineWidth",5),f.stroke(),f.restore()),this._cache.set(CANVAS,{scene:c,filter:g,hit:_,x:n,y:o}),this._requestDraw(),this}Util_1.Util.error("Can not cache the node. Width or height of the node equals 0. Caching is skipped.")}isCached(){return this._cache.has(CANVAS)}getClientRect(t){throw new Error('abstract "getClientRect" method call')}_transformedRect(t,e){var i,r,a,s,n=[{x:t.x,y:t.y},{x:t.x+t.width,y:t.y},{x:t.x+t.width,y:t.y+t.height},{x:t.x,y:t.y+t.height}],o=this.getAbsoluteTransform(e);return n.forEach((function(t){var e=o.point(t);void 0===i&&(i=a=e.x,r=s=e.y),i=Math.min(i,e.x),r=Math.min(r,e.y),a=Math.max(a,e.x),s=Math.max(s,e.y)})),{x:i,y:r,width:a-i,height:s-r}}_drawCachedSceneCanvas(t){t.save(),t._applyOpacity(this),t._applyGlobalCompositeOperation(this);const e=this._getCanvasCache();t.translate(e.x,e.y);var i=this._getCachedSceneCanvas(),r=i.pixelRatio;t.drawImage(i._canvas,0,0,i.width/r,i.height/r),t.restore()}_drawCachedHitCanvas(t){var e=this._getCanvasCache(),i=e.hit;t.save(),t.translate(e.x,e.y),t.drawImage(i._canvas,0,0,i.width/i.pixelRatio,i.height/i.pixelRatio),t.restore()}_getCachedSceneCanvas(){var t,e,i,r,a=this.filters(),s=this._getCanvasCache(),n=s.scene,o=s.filter,h=o.getContext();if(a){if(!this._filterUpToDate){var l=n.pixelRatio;o.setSize(n.width/n.pixelRatio,n.height/n.pixelRatio);try{for(t=a.length,h.clear(),h.drawImage(n._canvas,0,0,n.getWidth()/l,n.getHeight()/l),e=h.getImageData(0,0,o.getWidth(),o.getHeight()),i=0;i<t;i++)"function"==typeof(r=a[i])?(r.call(this,e),h.putImageData(e,0,0)):Util_1.Util.error("Filter should be type of function, but got "+typeof r+" instead. Please check correct filters")}catch(t){Util_1.Util.error("Unable to apply filter. "+t.message+" This post my help you https://konvajs.org/docs/posts/Tainted_Canvas.html.")}this._filterUpToDate=!0}return o}return n}on(t,e){if(this._cache&&this._cache.delete(ALL_LISTENERS),3===arguments.length)return this._delegate.apply(this,arguments);var i,r,a,s,n=t.split(SPACE),o=n.length;for(i=0;i<o;i++)a=(r=n[i].split("."))[0],s=r[1]||"",this.eventListeners[a]||(this.eventListeners[a]=[]),this.eventListeners[a].push({name:s,handler:e});return this}off(t,e){var i,r,a,s,n,o=(t||"").split(SPACE),h=o.length;if(this._cache&&this._cache.delete(ALL_LISTENERS),!t)for(r in this.eventListeners)this._off(r);for(i=0;i<h;i++)if(s=(a=o[i].split("."))[0],n=a[1],s)this.eventListeners[s]&&this._off(s,n,e);else for(r in this.eventListeners)this._off(r,n,e);return this}dispatchEvent(t){var e={target:this,type:t.type,evt:t};return this.fire(t.type,e),this}addEventListener(t,e){return this.on(t,(function(t){e.call(this,t.evt)})),this}removeEventListener(t){return this.off(t),this}_delegate(t,e,i){var r=this;this.on(t,(function(t){for(var a=t.target.findAncestors(e,!0,r),s=0;s<a.length;s++)(t=Util_1.Util.cloneObject(t)).currentTarget=a[s],i.call(a[s],t)}))}remove(){return this.isDragging()&&this.stopDrag(),DragAndDrop_1.DD._dragElements.delete(this._id),this._remove(),this}_clearCaches(){this._clearSelfAndDescendantCache(ABSOLUTE_TRANSFORM),this._clearSelfAndDescendantCache(ABSOLUTE_OPACITY),this._clearSelfAndDescendantCache(ABSOLUTE_SCALE),this._clearSelfAndDescendantCache(STAGE),this._clearSelfAndDescendantCache(VISIBLE),this._clearSelfAndDescendantCache(LISTENING)}_remove(){this._clearCaches();var t=this.getParent();t&&t.children&&(t.children.splice(this.index,1),t._setChildrenIndices(),this.parent=null)}destroy(){return this.remove(),this.clearCache(),this}getAttr(t){var e="get"+Util_1.Util._capitalize(t);return Util_1.Util._isFunction(this[e])?this[e]():this.attrs[t]}getAncestors(){for(var t=this.getParent(),e=[];t;)e.push(t),t=t.getParent();return e}getAttrs(){return this.attrs||{}}setAttrs(t){return this._batchTransformChanges((()=>{var e,i;if(!t)return this;for(e in t)e!==CHILDREN&&(i=SET+Util_1.Util._capitalize(e),Util_1.Util._isFunction(this[i])?this[i](t[e]):this._setAttr(e,t[e]))})),this}isListening(){return this._getCache(LISTENING,this._isListening)}_isListening(t){if(!this.listening())return!1;const e=this.getParent();return!e||e===t||this===t||e._isListening(t)}isVisible(){return this._getCache(VISIBLE,this._isVisible)}_isVisible(t){if(!this.visible())return!1;const e=this.getParent();return!e||e===t||this===t||e._isVisible(t)}shouldDrawHit(t,e=!1){if(t)return this._isVisible(t)&&this._isListening(t);var i=this.getLayer(),r=!1;DragAndDrop_1.DD._dragElements.forEach((t=>{"dragging"===t.dragStatus&&("Stage"===t.node.nodeType||t.node.getLayer()===i)&&(r=!0)}));var a=!e&&!Global_1.Konva.hitOnDragEnabled&&r;return this.isListening()&&this.isVisible()&&!a}show(){return this.visible(!0),this}hide(){return this.visible(!1),this}getZIndex(){return this.index||0}getAbsoluteZIndex(){var t,e,i,r,a=this.getDepth(),s=this,n=0;return s.nodeType!==UPPER_STAGE&&function o(h){for(t=[],e=h.length,i=0;i<e;i++)r=h[i],n++,r.nodeType!==SHAPE&&(t=t.concat(r.getChildren().slice())),r._id===s._id&&(i=e);t.length>0&&t[0].getDepth()<=a&&o(t)}(s.getStage().getChildren()),n}getDepth(){for(var t=0,e=this.parent;e;)t++,e=e.parent;return t}_batchTransformChanges(t){this._batchingTransformChange=!0,t(),this._batchingTransformChange=!1,this._needClearTransformCache&&(this._clearCache(TRANSFORM),this._clearSelfAndDescendantCache(ABSOLUTE_TRANSFORM)),this._needClearTransformCache=!1}setPosition(t){return this._batchTransformChanges((()=>{this.x(t.x),this.y(t.y)})),this}getPosition(){return{x:this.x(),y:this.y()}}getRelativePointerPosition(){if(!this.getStage())return null;var t=this.getStage().getPointerPosition();if(!t)return null;var e=this.getAbsoluteTransform().copy();return e.invert(),e.point(t)}getAbsolutePosition(t){let e=!1,i=this.parent;for(;i;){if(i.isCached()){e=!0;break}i=i.parent}e&&!t&&(t=!0);var r=this.getAbsoluteTransform(t).getMatrix(),a=new Util_1.Transform,s=this.offset();return a.m=r.slice(),a.translate(s.x,s.y),a.getTranslation()}setAbsolutePosition(t){var e=this._clearTransform();this.attrs.x=e.x,this.attrs.y=e.y,delete e.x,delete e.y,this._clearCache(TRANSFORM);var i=this._getAbsoluteTransform().copy();return i.invert(),i.translate(t.x,t.y),t={x:this.attrs.x+i.getTranslation().x,y:this.attrs.y+i.getTranslation().y},this._setTransform(e),this.setPosition({x:t.x,y:t.y}),this._clearCache(TRANSFORM),this._clearSelfAndDescendantCache(ABSOLUTE_TRANSFORM),this}_setTransform(t){var e;for(e in t)this.attrs[e]=t[e]}_clearTransform(){var t={x:this.x(),y:this.y(),rotation:this.rotation(),scaleX:this.scaleX(),scaleY:this.scaleY(),offsetX:this.offsetX(),offsetY:this.offsetY(),skewX:this.skewX(),skewY:this.skewY()};return this.attrs.x=0,this.attrs.y=0,this.attrs.rotation=0,this.attrs.scaleX=1,this.attrs.scaleY=1,this.attrs.offsetX=0,this.attrs.offsetY=0,this.attrs.skewX=0,this.attrs.skewY=0,t}move(t){var e=t.x,i=t.y,r=this.x(),a=this.y();return void 0!==e&&(r+=e),void 0!==i&&(a+=i),this.setPosition({x:r,y:a}),this}_eachAncestorReverse(t,e){var i,r,a=[],s=this.getParent();if(!e||e._id!==this._id){for(a.unshift(this);s&&(!e||s._id!==e._id);)a.unshift(s),s=s.parent;for(i=a.length,r=0;r<i;r++)t(a[r])}}rotate(t){return this.rotation(this.rotation()+t),this}moveToTop(){if(!this.parent)return Util_1.Util.warn("Node has no parent. moveToTop function is ignored."),!1;var t=this.index;return t<this.parent.getChildren().length-1&&(this.parent.children.splice(t,1),this.parent.children.push(this),this.parent._setChildrenIndices(),!0)}moveUp(){if(!this.parent)return Util_1.Util.warn("Node has no parent. moveUp function is ignored."),!1;var t=this.index;return t<this.parent.getChildren().length-1&&(this.parent.children.splice(t,1),this.parent.children.splice(t+1,0,this),this.parent._setChildrenIndices(),!0)}moveDown(){if(!this.parent)return Util_1.Util.warn("Node has no parent. moveDown function is ignored."),!1;var t=this.index;return t>0&&(this.parent.children.splice(t,1),this.parent.children.splice(t-1,0,this),this.parent._setChildrenIndices(),!0)}moveToBottom(){if(!this.parent)return Util_1.Util.warn("Node has no parent. moveToBottom function is ignored."),!1;var t=this.index;return t>0&&(this.parent.children.splice(t,1),this.parent.children.unshift(this),this.parent._setChildrenIndices(),!0)}setZIndex(t){if(!this.parent)return Util_1.Util.warn("Node has no parent. zIndex parameter is ignored."),this;(t<0||t>=this.parent.children.length)&&Util_1.Util.warn("Unexpected value "+t+" for zIndex property. zIndex is just index of a node in children of its parent. Expected value is from 0 to "+(this.parent.children.length-1)+".");var e=this.index;return this.parent.children.splice(e,1),this.parent.children.splice(t,0,this),this.parent._setChildrenIndices(),this}getAbsoluteOpacity(){return this._getCache(ABSOLUTE_OPACITY,this._getAbsoluteOpacity)}_getAbsoluteOpacity(){var t=this.opacity(),e=this.getParent();return e&&!e._isUnderCache&&(t*=e.getAbsoluteOpacity()),t}moveTo(t){return this.getParent()!==t&&(this._remove(),t.add(this)),this}toObject(){var t,e,i,r,a={},s=this.getAttrs();for(t in a.attrs={},s)e=s[t],Util_1.Util.isObject(e)&&!Util_1.Util._isPlainObject(e)&&!Util_1.Util._isArray(e)||(i="function"==typeof this[t]&&this[t],delete s[t],r=i?i.call(this):null,s[t]=e,r!==e&&(a.attrs[t]=e));return a.className=this.getClassName(),Util_1.Util._prepareToStringify(a)}toJSON(){return JSON.stringify(this.toObject())}getParent(){return this.parent}findAncestors(t,e,i){var r=[];e&&this._isMatch(t)&&r.push(this);for(var a=this.parent;a;){if(a===i)return r;a._isMatch(t)&&r.push(a),a=a.parent}return r}isAncestorOf(t){return!1}findAncestor(t,e,i){return this.findAncestors(t,e,i)[0]}_isMatch(t){if(!t)return!1;if("function"==typeof t)return t(this);var e,i,r=t.replace(/ /g,"").split(","),a=r.length;for(e=0;e<a;e++)if(i=r[e],Util_1.Util.isValidSelector(i)||(Util_1.Util.warn('Selector "'+i+'" is invalid. Allowed selectors examples are "#foo", ".bar" or "Group".'),Util_1.Util.warn('If you have a custom shape with such className, please change it to start with upper letter like "Triangle".'),Util_1.Util.warn("Konva is awesome, right?")),"#"===i.charAt(0)){if(this.id()===i.slice(1))return!0}else if("."===i.charAt(0)){if(this.hasName(i.slice(1)))return!0}else if(this.className===i||this.nodeType===i)return!0;return!1}getLayer(){var t=this.getParent();return t?t.getLayer():null}getStage(){return this._getCache(STAGE,this._getStage)}_getStage(){var t=this.getParent();return t?t.getStage():void 0}fire(t,e={},i){return e.target=e.target||this,i?this._fireAndBubble(t,e):this._fire(t,e),this}getAbsoluteTransform(t){return t?this._getAbsoluteTransform(t):this._getCache(ABSOLUTE_TRANSFORM,this._getAbsoluteTransform)}_getAbsoluteTransform(t){var e;if(t)return e=new Util_1.Transform,this._eachAncestorReverse((function(t){var i=t.transformsEnabled();"all"===i?e.multiply(t.getTransform()):"position"===i&&e.translate(t.x()-t.offsetX(),t.y()-t.offsetY())}),t),e;e=this._cache.get(ABSOLUTE_TRANSFORM)||new Util_1.Transform,this.parent?this.parent.getAbsoluteTransform().copyInto(e):e.reset();var i=this.transformsEnabled();if("all"===i)e.multiply(this.getTransform());else if("position"===i){const t=this.attrs.x||0,i=this.attrs.y||0,r=this.attrs.offsetX||0,a=this.attrs.offsetY||0;e.translate(t-r,i-a)}return e.dirty=!1,e}getAbsoluteScale(t){for(var e=this;e;)e._isUnderCache&&(t=e),e=e.getParent();const i=this.getAbsoluteTransform(t).decompose();return{x:i.scaleX,y:i.scaleY}}getAbsoluteRotation(){return this.getAbsoluteTransform().decompose().rotation}getTransform(){return this._getCache(TRANSFORM,this._getTransform)}_getTransform(){var t,e,i=this._cache.get(TRANSFORM)||new Util_1.Transform;i.reset();var r=this.x(),a=this.y(),s=Global_1.Konva.getAngle(this.rotation()),n=null!==(t=this.attrs.scaleX)&&void 0!==t?t:1,o=null!==(e=this.attrs.scaleY)&&void 0!==e?e:1,h=this.attrs.skewX||0,l=this.attrs.skewY||0,d=this.attrs.offsetX||0,c=this.attrs.offsetY||0;return 0===r&&0===a||i.translate(r,a),0!==s&&i.rotate(s),0===h&&0===l||i.skew(h,l),1===n&&1===o||i.scale(n,o),0===d&&0===c||i.translate(-1*d,-1*c),i.dirty=!1,i}clone(t){var e,i,r,a,s,n=Util_1.Util.cloneObject(this.attrs);for(e in t)n[e]=t[e];var o=new this.constructor(n);for(e in this.eventListeners)for(r=(i=this.eventListeners[e]).length,a=0;a<r;a++)(s=i[a]).name.indexOf(KONVA)<0&&(o.eventListeners[e]||(o.eventListeners[e]=[]),o.eventListeners[e].push(s));return o}_toKonvaCanvas(t){t=t||{};var e=this.getClientRect(),i=this.getStage(),r=void 0!==t.x?t.x:Math.floor(e.x),a=void 0!==t.y?t.y:Math.floor(e.y),s=t.pixelRatio||1,n=new Canvas_1.SceneCanvas({width:t.width||Math.ceil(e.width)||(i?i.width():0),height:t.height||Math.ceil(e.height)||(i?i.height():0),pixelRatio:s}),o=n.getContext();return!1===t.imageSmoothingEnabled&&(o._context.imageSmoothingEnabled=!1),o.save(),(r||a)&&o.translate(-1*r,-1*a),this.drawScene(n),o.restore(),n}toCanvas(t){return this._toKonvaCanvas(t)._canvas}toDataURL(t){var e=(t=t||{}).mimeType||null,i=t.quality||null,r=this._toKonvaCanvas(t).toDataURL(e,i);return t.callback&&t.callback(r),r}toImage(t){return new Promise(((e,i)=>{try{const i=null==t?void 0:t.callback;i&&delete t.callback,Util_1.Util._urlToImage(this.toDataURL(t),(function(t){e(t),null==i||i(t)}))}catch(t){i(t)}}))}toBlob(t){return new Promise(((e,i)=>{try{const i=null==t?void 0:t.callback;i&&delete t.callback,this.toCanvas(t).toBlob((t=>{e(t),null==i||i(t)}))}catch(t){i(t)}}))}setSize(t){return this.width(t.width),this.height(t.height),this}getSize(){return{width:this.width(),height:this.height()}}getClassName(){return this.className||this.nodeType}getType(){return this.nodeType}getDragDistance(){return void 0!==this.attrs.dragDistance?this.attrs.dragDistance:this.parent?this.parent.getDragDistance():Global_1.Konva.dragDistance}_off(t,e,i){var r,a,s,n=this.eventListeners[t];for(r=0;r<n.length;r++)if(a=n[r].name,s=n[r].handler,!("konva"===a&&"konva"!==e||e&&a!==e||i&&i!==s)){if(n.splice(r,1),0===n.length){delete this.eventListeners[t];break}r--}}_fireChangeEvent(t,e,i){this._fire(t+CHANGE,{oldVal:e,newVal:i})}addName(t){if(!this.hasName(t)){var e=this.name(),i=e?e+" "+t:t;this.name(i)}return this}hasName(t){if(!t)return!1;const e=this.name();return!!e&&-1!==(e||"").split(/\s/g).indexOf(t)}removeName(t){var e=(this.name()||"").split(/\s/g),i=e.indexOf(t);return-1!==i&&(e.splice(i,1),this.name(e.join(" "))),this}setAttr(t,e){var i=this[SET+Util_1.Util._capitalize(t)];return Util_1.Util._isFunction(i)?i.call(this,e):this._setAttr(t,e),this}_requestDraw(){if(Global_1.Konva.autoDrawEnabled){const t=this.getLayer()||this.getStage();null==t||t.batchDraw()}}_setAttr(t,e){var i=this.attrs[t];(i!==e||Util_1.Util.isObject(e))&&(null==e?delete this.attrs[t]:this.attrs[t]=e,this._shouldFireChangeEvents&&this._fireChangeEvent(t,i,e),this._requestDraw())}_setComponentAttr(t,e,i){var r;void 0!==i&&((r=this.attrs[t])||(this.attrs[t]=this.getAttr(t)),this.attrs[t][e]=i,this._fireChangeEvent(t,r,i))}_fireAndBubble(t,e,i){if(e&&this.nodeType===SHAPE&&(e.target=this),!((t===MOUSEENTER||t===MOUSELEAVE)&&(i&&(this===i||this.isAncestorOf&&this.isAncestorOf(i))||"Stage"===this.nodeType&&!i))){this._fire(t,e);var r=(t===MOUSEENTER||t===MOUSELEAVE)&&i&&i.isAncestorOf&&i.isAncestorOf(this)&&!i.isAncestorOf(this.parent);(e&&!e.cancelBubble||!e)&&this.parent&&this.parent.isListening()&&!r&&(i&&i.parent?this._fireAndBubble.call(this.parent,t,e,i):this._fireAndBubble.call(this.parent,t,e))}}_getProtoListeners(t){let e=this._cache.get(ALL_LISTENERS);if(!e){e={};let t=Object.getPrototypeOf(this);for(;t;)if(t.eventListeners){for(var i in t.eventListeners){const r=t.eventListeners[i],a=e[i]||[];e[i]=r.concat(a)}t=Object.getPrototypeOf(t)}else t=Object.getPrototypeOf(t);this._cache.set(ALL_LISTENERS,e)}return e[t]}_fire(t,e){(e=e||{}).currentTarget=this,e.type=t;const i=this._getProtoListeners(t);if(i)for(var r=0;r<i.length;r++)i[r].handler.call(this,e);const a=this.eventListeners[t];if(a)for(r=0;r<a.length;r++)a[r].handler.call(this,e)}draw(){return this.drawScene(),this.drawHit(),this}_createDragElement(t){var e=t?t.pointerId:void 0,i=this.getStage(),r=this.getAbsolutePosition(),a=i._getPointerById(e)||i._changedPointerPositions[0]||r;DragAndDrop_1.DD._dragElements.set(this._id,{node:this,startPointerPos:a,offset:{x:a.x-r.x,y:a.y-r.y},dragStatus:"ready",pointerId:e})}startDrag(t,e=!0){DragAndDrop_1.DD._dragElements.has(this._id)||this._createDragElement(t);DragAndDrop_1.DD._dragElements.get(this._id).dragStatus="dragging",this.fire("dragstart",{type:"dragstart",target:this,evt:t&&t.evt},e)}_setDragPosition(t,e){const i=this.getStage()._getPointerById(e.pointerId);if(i){var r={x:i.x-e.offset.x,y:i.y-e.offset.y},a=this.dragBoundFunc();if(void 0!==a){const e=a.call(this,r,t);e?r=e:Util_1.Util.warn("dragBoundFunc did not return any value. That is unexpected behavior. You must return new absolute position from dragBoundFunc.")}this._lastPos&&this._lastPos.x===r.x&&this._lastPos.y===r.y||(this.setAbsolutePosition(r),this._requestDraw()),this._lastPos=r}}stopDrag(t){const e=DragAndDrop_1.DD._dragElements.get(this._id);e&&(e.dragStatus="stopped"),DragAndDrop_1.DD._endDragBefore(t),DragAndDrop_1.DD._endDragAfter(t)}setDraggable(t){this._setAttr("draggable",t),this._dragChange()}isDragging(){const t=DragAndDrop_1.DD._dragElements.get(this._id);return!!t&&"dragging"===t.dragStatus}_listenDrag(){this._dragCleanup(),this.on("mousedown.konva touchstart.konva",(function(t){if((!(void 0!==t.evt.button)||Global_1.Konva.dragButtons.indexOf(t.evt.button)>=0)&&!this.isDragging()){var e=!1;DragAndDrop_1.DD._dragElements.forEach((t=>{this.isAncestorOf(t.node)&&(e=!0)})),e||this._createDragElement(t)}}))}_dragChange(){if(this.attrs.draggable)this._listenDrag();else{if(this._dragCleanup(),!this.getStage())return;const t=DragAndDrop_1.DD._dragElements.get(this._id),e=t&&"dragging"===t.dragStatus,i=t&&"ready"===t.dragStatus;e?this.stopDrag():i&&DragAndDrop_1.DD._dragElements.delete(this._id)}}_dragCleanup(){this.off("mousedown.konva"),this.off("touchstart.konva")}isClientRectOnScreen(t={x:0,y:0}){const e=this.getStage();if(!e)return!1;const i={x:-t.x,y:-t.y,width:e.width()+2*t.x,height:e.height()+2*t.y};return Util_1.Util.haveIntersection(i,this.getClientRect())}static create(t,e){return Util_1.Util._isString(t)&&(t=JSON.parse(t)),this._createNode(t,e)}static _createNode(t,e){var i,r,a,s=Node.prototype.getClassName.call(t),n=t.children;e&&(t.attrs.container=e),Global_1.Konva[s]||(Util_1.Util.warn('Can not find a node with class name "'+s+'". Fallback to "Shape".'),s="Shape");if(i=new(0,Global_1.Konva[s])(t.attrs),n)for(r=n.length,a=0;a<r;a++)i.add(Node._createNode(n[a]));return i}}exports.Node=Node,Node.prototype.nodeType="Node",Node.prototype._attrsAffectingSize=[],Node.prototype.eventListeners={},Node.prototype.on.call(Node.prototype,TRANSFORM_CHANGE_STR,(function(){this._batchingTransformChange?this._needClearTransformCache=!0:(this._clearCache(TRANSFORM),this._clearSelfAndDescendantCache(ABSOLUTE_TRANSFORM))})),Node.prototype.on.call(Node.prototype,"visibleChange.konva",(function(){this._clearSelfAndDescendantCache(VISIBLE)})),Node.prototype.on.call(Node.prototype,"listeningChange.konva",(function(){this._clearSelfAndDescendantCache(LISTENING)})),Node.prototype.on.call(Node.prototype,"opacityChange.konva",(function(){this._clearSelfAndDescendantCache(ABSOLUTE_OPACITY)}));const addGetterSetter=Factory_1.Factory.addGetterSetter;addGetterSetter(Node,"zIndex"),addGetterSetter(Node,"absolutePosition"),addGetterSetter(Node,"position"),addGetterSetter(Node,"x",0,(0,Validators_1.getNumberValidator)()),addGetterSetter(Node,"y",0,(0,Validators_1.getNumberValidator)()),addGetterSetter(Node,"globalCompositeOperation","source-over",(0,Validators_1.getStringValidator)()),addGetterSetter(Node,"opacity",1,(0,Validators_1.getNumberValidator)()),addGetterSetter(Node,"name","",(0,Validators_1.getStringValidator)()),addGetterSetter(Node,"id","",(0,Validators_1.getStringValidator)()),addGetterSetter(Node,"rotation",0,(0,Validators_1.getNumberValidator)()),Factory_1.Factory.addComponentsGetterSetter(Node,"scale",["x","y"]),addGetterSetter(Node,"scaleX",1,(0,Validators_1.getNumberValidator)()),addGetterSetter(Node,"scaleY",1,(0,Validators_1.getNumberValidator)()),Factory_1.Factory.addComponentsGetterSetter(Node,"skew",["x","y"]),addGetterSetter(Node,"skewX",0,(0,Validators_1.getNumberValidator)()),addGetterSetter(Node,"skewY",0,(0,Validators_1.getNumberValidator)()),Factory_1.Factory.addComponentsGetterSetter(Node,"offset",["x","y"]),addGetterSetter(Node,"offsetX",0,(0,Validators_1.getNumberValidator)()),addGetterSetter(Node,"offsetY",0,(0,Validators_1.getNumberValidator)()),addGetterSetter(Node,"dragDistance",null,(0,Validators_1.getNumberValidator)()),addGetterSetter(Node,"width",0,(0,Validators_1.getNumberValidator)()),addGetterSetter(Node,"height",0,(0,Validators_1.getNumberValidator)()),addGetterSetter(Node,"listening",!0,(0,Validators_1.getBooleanValidator)()),addGetterSetter(Node,"preventDefault",!0,(0,Validators_1.getBooleanValidator)()),addGetterSetter(Node,"filters",null,(function(t){return this._filterUpToDate=!1,t})),addGetterSetter(Node,"visible",!0,(0,Validators_1.getBooleanValidator)()),addGetterSetter(Node,"transformsEnabled","all",(0,Validators_1.getStringValidator)()),addGetterSetter(Node,"size"),addGetterSetter(Node,"dragBoundFunc"),addGetterSetter(Node,"draggable",!1,(0,Validators_1.getBooleanValidator)()),Factory_1.Factory.backCompat(Node,{rotateDeg:"rotate",setRotationDeg:"setRotation",getRotationDeg:"getRotation"});
