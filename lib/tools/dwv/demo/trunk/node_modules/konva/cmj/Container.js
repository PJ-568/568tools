"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Container=void 0;const Factory_1=require("./Factory"),Node_1=require("./Node"),Validators_1=require("./Validators");class Container extends Node_1.Node{constructor(){super(...arguments),this.children=[]}getChildren(t){if(!t)return this.children||[];const e=this.children||[];var r=[];return e.forEach((function(e){t(e)&&r.push(e)})),r}hasChildren(){return this.getChildren().length>0}removeChildren(){return this.getChildren().forEach((t=>{t.parent=null,t.index=0,t.remove()})),this.children=[],this._requestDraw(),this}destroyChildren(){return this.getChildren().forEach((t=>{t.parent=null,t.index=0,t.destroy()})),this.children=[],this._requestDraw(),this}add(...t){if(0===t.length)return this;if(t.length>1){for(var e=0;e<t.length;e++)this.add(t[e]);return this}const r=t[0];return r.getParent()?(r.moveTo(this),this):(this._validateAdd(r),r.index=this.getChildren().length,r.parent=this,r._clearCaches(),this.getChildren().push(r),this._fire("add",{child:r}),this._requestDraw(),this)}destroy(){return this.hasChildren()&&this.destroyChildren(),super.destroy(),this}find(t){return this._generalFind(t,!1)}findOne(t){var e=this._generalFind(t,!0);return e.length>0?e[0]:void 0}_generalFind(t,e){var r=[];return this._descendants((i=>{const n=i._isMatch(t);return n&&r.push(i),!(!n||!e)})),r}_descendants(t){let e=!1;const r=this.getChildren();for(const i of r){if(e=t(i),e)return!0;if(i.hasChildren()&&(e=i._descendants(t),e))return!0}return!1}toObject(){var t=Node_1.Node.prototype.toObject.call(this);return t.children=[],this.getChildren().forEach((e=>{t.children.push(e.toObject())})),t}isAncestorOf(t){for(var e=t.getParent();e;){if(e._id===this._id)return!0;e=e.getParent()}return!1}clone(t){var e=Node_1.Node.prototype.clone.call(this,t);return this.getChildren().forEach((function(t){e.add(t.clone())})),e}getAllIntersections(t){var e=[];return this.find("Shape").forEach((function(r){r.isVisible()&&r.intersects(t)&&e.push(r)})),e}_clearSelfAndDescendantCache(t){var e;super._clearSelfAndDescendantCache(t),this.isCached()||null===(e=this.children)||void 0===e||e.forEach((function(e){e._clearSelfAndDescendantCache(t)}))}_setChildrenIndices(){var t;null===(t=this.children)||void 0===t||t.forEach((function(t,e){t.index=e})),this._requestDraw()}drawScene(t,e){var r=this.getLayer(),i=t||r&&r.getCanvas(),n=i&&i.getContext(),a=this._getCanvasCache(),s=a&&a.scene,h=i&&i.isCache;if(!this.isVisible()&&!h)return this;if(s){n.save();var o=this.getAbsoluteTransform(e).getMatrix();n.transform(o[0],o[1],o[2],o[3],o[4],o[5]),this._drawCachedSceneCanvas(n),n.restore()}else this._drawChildren("drawScene",i,e);return this}drawHit(t,e){if(!this.shouldDrawHit(e))return this;var r=this.getLayer(),i=t||r&&r.hitCanvas,n=i&&i.getContext(),a=this._getCanvasCache();if(a&&a.hit){n.save();var s=this.getAbsoluteTransform(e).getMatrix();n.transform(s[0],s[1],s[2],s[3],s[4],s[5]),this._drawCachedHitCanvas(n),n.restore()}else this._drawChildren("drawHit",i,e);return this}_drawChildren(t,e,r){var i,n=e&&e.getContext(),a=this.clipWidth(),s=this.clipHeight(),h=this.clipFunc(),o=a&&s||h;const d=r===this;if(o){n.save();var l=this.getAbsoluteTransform(r),c=l.getMatrix();if(n.transform(c[0],c[1],c[2],c[3],c[4],c[5]),n.beginPath(),h)h.call(this,n,this);else{var u=this.clipX(),f=this.clipY();n.rect(u,f,a,s)}n.clip(),c=l.copy().invert().getMatrix(),n.transform(c[0],c[1],c[2],c[3],c[4],c[5])}var g=!d&&"source-over"!==this.globalCompositeOperation()&&"drawScene"===t;g&&(n.save(),n._applyGlobalCompositeOperation(this)),null===(i=this.children)||void 0===i||i.forEach((function(i){i[t](e,r)})),g&&n.restore(),o&&n.restore()}getClientRect(t){var e,r,i,n,a,s=(t=t||{}).skipTransform,h=t.relativeTo,o={x:1/0,y:1/0,width:0,height:0},d=this;null===(e=this.children)||void 0===e||e.forEach((function(e){if(e.visible()){var s=e.getClientRect({relativeTo:d,skipShadow:t.skipShadow,skipStroke:t.skipStroke});0===s.width&&0===s.height||(void 0===r?(r=s.x,i=s.y,n=s.x+s.width,a=s.y+s.height):(r=Math.min(r,s.x),i=Math.min(i,s.y),n=Math.max(n,s.x+s.width),a=Math.max(a,s.y+s.height)))}}));for(var l=this.find("Shape"),c=!1,u=0;u<l.length;u++){if(l[u]._isVisible(this)){c=!0;break}}return o=c&&void 0!==r?{x:r,y:i,width:n-r,height:a-i}:{x:0,y:0,width:0,height:0},s?o:this._transformedRect(o,h)}}exports.Container=Container,Factory_1.Factory.addComponentsGetterSetter(Container,"clip",["x","y","width","height"]),Factory_1.Factory.addGetterSetter(Container,"clipX",void 0,(0,Validators_1.getNumberValidator)()),Factory_1.Factory.addGetterSetter(Container,"clipY",void 0,(0,Validators_1.getNumberValidator)()),Factory_1.Factory.addGetterSetter(Container,"clipWidth",void 0,(0,Validators_1.getNumberValidator)()),Factory_1.Factory.addGetterSetter(Container,"clipHeight",void 0,(0,Validators_1.getNumberValidator)()),Factory_1.Factory.addGetterSetter(Container,"clipFunc");
