"use strict";var immediate=require("immediate");function INTERNAL(){}var handlers={},REJECTED=["REJECTED"],FULFILLED=["FULFILLED"],PENDING=["PENDING"];function Promise(e){if("function"!=typeof e)throw new TypeError("resolver must be a function");this.state=PENDING,this.queue=[],this.outcome=void 0,e!==INTERNAL&&safelyResolveThenable(this,e)}function QueueItem(e,t,r){this.promise=e,"function"==typeof t&&(this.onFulfilled=t,this.callFulfilled=this.otherCallFulfilled),"function"==typeof r&&(this.onRejected=r,this.callRejected=this.otherCallRejected)}function unwrap(e,t,r){immediate((function(){var n;try{n=t(r)}catch(t){return handlers.reject(e,t)}n===e?handlers.reject(e,new TypeError("Cannot resolve promise with itself")):handlers.resolve(e,n)}))}function getThen(e){var t=e&&e.then;if(e&&("object"==typeof e||"function"==typeof e)&&"function"==typeof t)return function(){t.apply(e,arguments)}}function safelyResolveThenable(e,t){var r=!1;function n(t){r||(r=!0,handlers.reject(e,t))}function o(t){r||(r=!0,handlers.resolve(e,t))}var i=tryCatch((function(){t(o,n)}));"error"===i.status&&n(i.value)}function tryCatch(e,t){var r={};try{r.value=e(t),r.status="success"}catch(e){r.status="error",r.value=e}return r}function resolve(e){return e instanceof this?e:handlers.resolve(new this(INTERNAL),e)}function reject(e){var t=new this(INTERNAL);return handlers.reject(t,e)}function all(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var r=e.length,n=!1;if(!r)return this.resolve([]);for(var o=new Array(r),i=0,s=-1,u=new this(INTERNAL);++s<r;)l(e[s],s);return u;function l(e,s){t.resolve(e).then((function(e){o[s]=e,++i!==r||n||(n=!0,handlers.resolve(u,o))}),(function(e){n||(n=!0,handlers.reject(u,e))}))}}function race(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var r=e.length,n=!1;if(!r)return this.resolve([]);for(var o,i=-1,s=new this(INTERNAL);++i<r;)o=e[i],t.resolve(o).then((function(e){n||(n=!0,handlers.resolve(s,e))}),(function(e){n||(n=!0,handlers.reject(s,e))}));return s}module.exports=Promise,Promise.prototype.finally=function(e){if("function"!=typeof e)return this;var t=this.constructor;return this.then((function(r){return t.resolve(e()).then((function(){return r}))}),(function(r){return t.resolve(e()).then((function(){throw r}))}))},Promise.prototype.catch=function(e){return this.then(null,e)},Promise.prototype.then=function(e,t){if("function"!=typeof e&&this.state===FULFILLED||"function"!=typeof t&&this.state===REJECTED)return this;var r=new this.constructor(INTERNAL);this.state!==PENDING?unwrap(r,this.state===FULFILLED?e:t,this.outcome):this.queue.push(new QueueItem(r,e,t));return r},QueueItem.prototype.callFulfilled=function(e){handlers.resolve(this.promise,e)},QueueItem.prototype.otherCallFulfilled=function(e){unwrap(this.promise,this.onFulfilled,e)},QueueItem.prototype.callRejected=function(e){handlers.reject(this.promise,e)},QueueItem.prototype.otherCallRejected=function(e){unwrap(this.promise,this.onRejected,e)},handlers.resolve=function(e,t){var r=tryCatch(getThen,t);if("error"===r.status)return handlers.reject(e,r.value);var n=r.value;if(n)safelyResolveThenable(e,n);else{e.state=FULFILLED,e.outcome=t;for(var o=-1,i=e.queue.length;++o<i;)e.queue[o].callFulfilled(t)}return e},handlers.reject=function(e,t){e.state=REJECTED,e.outcome=t;for(var r=-1,n=e.queue.length;++r<n;)e.queue[r].callRejected(t);return e},Promise.resolve=resolve,Promise.reject=reject,Promise.all=all,Promise.race=race;
