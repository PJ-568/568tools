import{getStrWithBrFromHtml,checkNodeOuter}from"../../utils";export default class TextEdit{constructor(t){this.renderer=t,this.mindMap=t.mindMap,this.currentNode=null,this.textEditNode=null,this.showTextEdit=!1,this.cacheEditingText="",this.bindEvent()}bindEvent(){this.show=this.show.bind(this),this.onScale=this.onScale.bind(this),this.mindMap.on("node_dblclick",this.show),this.mindMap.on("draw_click",(()=>{this.hideEditTextBox()})),this.mindMap.on("body_click",(()=>{this.mindMap.opt.isEndNodeTextEditOnClickOuter&&this.hideEditTextBox()})),this.mindMap.on("svg_mousedown",(()=>{this.hideEditTextBox()})),this.mindMap.on("expand_btn_click",(()=>{this.hideEditTextBox()})),this.mindMap.on("before_node_active",(()=>{this.hideEditTextBox()})),this.mindMap.keyCommand.addShortcut("F2",(()=>{this.renderer.activeNodeList.length<=0||this.show(this.renderer.activeNodeList[0])})),this.mindMap.on("scale",this.onScale)}registerTmpShortcut(){this.mindMap.keyCommand.addShortcut("Enter",(()=>{this.hideEditTextBox()}))}async show(t){if(t.isUseCustomNodeContent())return;let{beforeTextEdit:e}=this.mindMap.opt;if("function"==typeof e){let i=!1;try{i=await e(t)}catch(t){i=!1}if(!i)return}this.currentNode=t;let{offsetLeft:i,offsetTop:d}=checkNodeOuter(this.mindMap,t);this.mindMap.view.translateXY(i,d);let s=t._textData.node.node.getBoundingClientRect();this.mindMap.richText?this.mindMap.richText.showEditText(t,s):this.showEditTextBox(t,s)}onScale(){this.currentNode&&(this.mindMap.richText?(this.mindMap.richText.cacheEditingText=this.mindMap.richText.getEditText(),this.mindMap.richText.showTextEdit=!1):(this.cacheEditingText=this.getEditText(),this.showTextEdit=!1),this.show(this.currentNode))}showEditTextBox(t,e){this.mindMap.emit("before_show_text_edit"),this.registerTmpShortcut(),this.textEditNode||(this.textEditNode=document.createElement("div"),this.textEditNode.style.cssText="position:fixed;box-sizing: border-box;background-color:#fff;box-shadow: 0 0 20px rgba(0,0,0,.5);padding: 3px 5px;margin-left: -5px;margin-top: -3px;outline: none; word-break: break-all;",this.textEditNode.setAttribute("contenteditable",!0),this.textEditNode.addEventListener("keyup",(t=>{t.stopPropagation()})),this.textEditNode.addEventListener("click",(t=>{t.stopPropagation()})),document.body.appendChild(this.textEditNode));let i=this.mindMap.view.scale,d=t.style.merge("lineHeight"),s=t.style.merge("fontSize"),o=(this.cacheEditingText||t.nodeData.data.text).split(/\n/gim),h="true"===t._textData.node.attr("data-ismultiLine");t.style.domText(this.textEditNode,i,h),this.textEditNode.style.zIndex=this.mindMap.opt.nodeTextEditZIndex,this.textEditNode.innerHTML=o.join("<br>"),this.textEditNode.style.minWidth=e.width+10+"px",this.textEditNode.style.minHeight=e.height+6+"px",this.textEditNode.style.left=e.left+"px",this.textEditNode.style.top=e.top+"px",this.textEditNode.style.display="block",this.textEditNode.style.maxWidth=this.mindMap.opt.textAutoWrapWidth*i+"px",h&&1!==d&&(this.textEditNode.style.transform=`translateY(${-(d*s-s)/2*i}px)`),this.showTextEdit=!0,this.cacheEditingText||this.selectNodeText(),this.cacheEditingText=""}selectNodeText(){let t=window.getSelection(),e=document.createRange();e.selectNodeContents(this.textEditNode),t.removeAllRanges(),t.addRange(e)}getEditText(){return getStrWithBrFromHtml(this.textEditNode.innerHTML)}hideEditTextBox(){if(this.currentNode=null,this.mindMap.richText)return this.mindMap.richText.hideEditText();this.showTextEdit&&(this.renderer.activeNodeList.forEach((t=>{let e=this.getEditText();this.mindMap.execCommand("SET_NODE_TEXT",t,e),t.isGeneralization&&t.generalizationBelongNode.updateGeneralization(),this.mindMap.render()})),this.mindMap.emit("hide_text_edit",this.textEditNode,this.renderer.activeNodeList),this.textEditNode.style.display="none",this.textEditNode.innerHTML="",this.textEditNode.style.fontFamily="inherit",this.textEditNode.style.fontSize="inherit",this.textEditNode.style.fontWeight="normal",this.textEditNode.style.transform="translateY(0)",this.showTextEdit=!1)}}
