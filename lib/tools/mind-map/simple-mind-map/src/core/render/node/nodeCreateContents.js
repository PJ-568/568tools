import{measureText,resizeImgSize,getTextFromHtml}from"../../../utils";import{Image,SVG,A,G,Rect,Text,ForeignObject}from"@svgdotjs/svg.js";import iconsSvg from"../../../svg/icons";import{CONSTANTS}from"../../../constants/constant";function createImgNode(){let t=this.nodeData.data.image;if(!t)return;let e=this.getImgShowSize(),i=(new Image).load(t).size(...e);return this.nodeData.data.imageTitle&&i.attr("title",this.nodeData.data.imageTitle),i.on("dblclick",(t=>{this.mindMap.emit("node_img_dblclick",this,t)})),{node:i,width:e[0],height:e[1]}}function getImgShowSize(){return resizeImgSize(this.nodeData.data.imageSize.width,this.nodeData.data.imageSize.height,this.mindMap.themeConfig.imgMaxWidth,this.mindMap.themeConfig.imgMaxHeight)}function createIconNode(){let t=this.nodeData.data;if(!t.icon||t.icon.length<=0)return[];let e=this.mindMap.themeConfig.iconSize;return t.icon.map((t=>{let i=iconsSvg.getNodeIconListIcon(t,this.mindMap.opt.iconList||[]),n=null;return n=/^<svg/.test(i)?SVG(i):(new Image).load(i),n.size(e,e),{node:n,width:e,height:e}}))}function createRichTextNode(){let t=new G,e=!1;if(this.nodeData.data.resetRichText&&(delete this.nodeData.data.resetRichText,e=!0),[CONSTANTS.CHANGE_THEME].includes(this.mindMap.renderer.renderSource)&&(this.hasCustomStyle()||(e=!0)),e){let t=getTextFromHtml(this.nodeData.data.text);this.nodeData.data.text=`<p><span style="${this.style.createStyleText()}">${t}</span></p>`}let i=`<div>${this.nodeData.data.text}</div>`,n=document.createElement("div");n.innerHTML=i,n.style.cssText="position: fixed; left: -999999px;";let o=n.children[0];o.classList.add("smm-richtext-node-wrap"),o.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),o.style.maxWidth=this.mindMap.opt.textAutoWrapWidth+"px",this.mindMap.el.appendChild(n);let{width:a,height:d}=o.getBoundingClientRect();a=Math.ceil(a),d=Math.ceil(d),t.attr("data-width",a),t.attr("data-height",d),i=n.innerHTML,this.mindMap.el.removeChild(n);let s=new ForeignObject;return s.width(a),s.height(d),s.add(SVG(i)),t.add(s),{node:t,width:a,height:d}}function createTextNode(){if(this.nodeData.data.richText)return this.createRichTextNode();let t=new G,e=this.getStyle("fontSize",!1,this.nodeData.data.isActive),i=this.getStyle("lineHeight",!1,this.nodeData.data.isActive),n=this.style.getTextFontStyle(),o=this.nodeData.data.text.split(/\n/gim),a=this.mindMap.opt.textAutoWrapWidth,d=!1;o.forEach(((t,e)=>{let i=t.split(""),s=[],h=[];for(;i.length;){let t=i.shift(),e=[...h,t].join("");measureText(e,n).width<=a?h.push(t):(s.push(h.join("")),h=[t])}h.length>0&&s.push(h.join("")),s.length>1&&(d=!0),o[e]=s.join("\n")})),o=o.join("\n").split(/\n/gim),o.forEach(((n,o)=>{let a=(new Text).text(n);this.style.text(a),a.y(e*i*o),t.add(a)}));let{width:s,height:h}=t.bbox();return s=Math.ceil(s),h=Math.ceil(h),t.attr("data-width",s),t.attr("data-height",h),t.attr("data-ismultiLine",d||o.length>1),{node:t,width:s,height:h}}function createHyperlinkNode(){let{hyperlink:t,hyperlinkTitle:e}=this.nodeData.data;if(!t)return;let i=this.mindMap.themeConfig.iconSize,n=new SVG,o=(new A).to(t).target("_blank");o.node.addEventListener("click",(t=>{t.stopPropagation()})),e&&o.attr("title",e),o.rect(i,i).fill({color:"transparent"});let a=SVG(iconsSvg.hyperlink).size(i,i);return this.style.iconNode(a),o.add(a),n.add(o),{node:n,width:i,height:i}}function createTagNode(){let t=this.nodeData.data.tag;if(!t||t.length<=0)return[];let e=[];return t.slice(0,this.mindMap.opt.maxTag).forEach(((t,i)=>{let n=new G,o=(new Text).text(t).x(8).cy(10);this.style.tagText(o,i);let{width:a}=o.bbox(),d=(new Rect).size(a+16,20);this.style.tagRect(d,i),n.add(d).add(o),e.push({node:n,width:a+16,height:20})})),e}function createNoteNode(){if(!this.nodeData.data.note)return null;let t=this.mindMap.themeConfig.iconSize,e=(new SVG).attr("cursor","pointer");e.add((new Rect).size(t,t).fill({color:"transparent"}));let i=SVG(iconsSvg.note).size(t,t);return this.style.iconNode(i),e.add(i),this.mindMap.opt.customNoteContentShow||(this.noteEl||(this.noteEl=document.createElement("div"),this.noteEl.style.cssText=`\n          position: absolute;\n          padding: 10px;\n          border-radius: 5px;\n          box-shadow: 0 2px 5px rgb(0 0 0 / 10%);\n          display: none;\n          background-color: #fff;\n          z-index: ${this.mindMap.opt.nodeNoteTooltipZIndex}\n      `,document.body.appendChild(this.noteEl)),this.noteEl.innerText=this.nodeData.data.note),e.on("mouseover",(()=>{let{left:i,top:n}=e.node.getBoundingClientRect();this.mindMap.opt.customNoteContentShow?this.mindMap.opt.customNoteContentShow.show(this.nodeData.data.note,i,n+t):(this.noteEl.style.left=i+"px",this.noteEl.style.top=n+t+"px",this.noteEl.style.display="block")})),e.on("mouseout",(()=>{this.mindMap.opt.customNoteContentShow?this.mindMap.opt.customNoteContentShow.hide():this.noteEl.style.display="none"})),{node:e,width:t,height:t}}let warpEl=null;function measureCustomNodeContentSize(t){warpEl||(warpEl=document.createElement("div"),warpEl.style.cssText="\n      position: fixed;\n      left: -99999px;\n      top: -99999px;\n    ",this.mindMap.el.appendChild(warpEl)),warpEl.innerHTML="",warpEl.appendChild(t);let e=warpEl.getBoundingClientRect();return{width:e.width,height:e.height}}function isUseCustomNodeContent(){return!!this._customNodeContent}export default{createImgNode:createImgNode,getImgShowSize:getImgShowSize,createIconNode:createIconNode,createRichTextNode:createRichTextNode,createTextNode:createTextNode,createHyperlinkNode:createHyperlinkNode,createTagNode:createTagNode,createNoteNode:createNoteNode,measureCustomNodeContentSize:measureCustomNodeContentSize,isUseCustomNodeContent:isUseCustomNodeContent};
