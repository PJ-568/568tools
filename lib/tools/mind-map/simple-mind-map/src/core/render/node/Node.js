import Style from"./Style";import Shape from"./Shape";import{asyncRun,nodeToHTML}from"../../../utils";import{G,Rect,ForeignObject,SVG}from"@svgdotjs/svg.js";import nodeGeneralizationMethods from"./nodeGeneralization";import nodeExpandBtnMethods from"./nodeExpandBtn";import nodeCommandWrapsMethods from"./nodeCommandWraps";import nodeCreateContentsMethods from"./nodeCreateContents";import{CONSTANTS}from"../../../constants/constant";class Node{constructor(t={}){this.nodeData=this.handleData(t.data||{}),this.uid=t.uid,this.mindMap=t.mindMap,this.renderer=t.renderer,this.draw=t.draw||null,this.style=new Style(this),this.shapeInstance=new Shape(this),this.shapePadding={paddingX:0,paddingY:0},this.isRoot=void 0!==t.isRoot&&t.isRoot,this.isGeneralization=void 0!==t.isGeneralization&&t.isGeneralization,this.generalizationBelongNode=null,this.layerIndex=void 0===t.layerIndex?0:t.layerIndex,this.width=t.width||0,this.height=t.height||0,this._left=t.left||0,this._top=t.top||0,this.customLeft=t.data.data.customLeft||void 0,this.customTop=t.data.data.customTop||void 0,this.isDrag=!1,this.parent=t.parent||null,this.children=t.children||[],this.group=null,this.shapeNode=null,this._customNodeContent=null,this._imgData=null,this._iconData=null,this._textData=null,this._hyperlinkData=null,this._tagData=null,this._noteData=null,this.noteEl=null,this._expandBtn=null,this._lastExpandBtnType=null,this._showExpandBtn=!1,this._openExpandNode=null,this._closeExpandNode=null,this._fillExpandNode=null,this._lines=[],this._generalizationLine=null,this._generalizationNode=null,this._unVisibleRectRegionNode=null,this._isMouseenter=!1,this._rectInfo={imgContentWidth:0,imgContentHeight:0,textContentWidth:0,textContentHeight:0},this._generalizationNodeWidth=0,this._generalizationNodeHeight=0,this.textContentItemMargin=this.mindMap.opt.textContentMargin,this.blockContentMargin=this.mindMap.opt.imgTextMargin,this.expandBtnSize=this.mindMap.opt.expandBtnSize,this.isMultipleChoice=!1,this.needLayout=!1,Object.keys(nodeGeneralizationMethods).forEach((t=>{this[t]=nodeGeneralizationMethods[t].bind(this)})),Object.keys(nodeExpandBtnMethods).forEach((t=>{this[t]=nodeExpandBtnMethods[t].bind(this)})),Object.keys(nodeCommandWrapsMethods).forEach((t=>{this[t]=nodeCommandWrapsMethods[t].bind(this)})),Object.keys(nodeCreateContentsMethods).forEach((t=>{this[t]=nodeCreateContentsMethods[t].bind(this)})),this.getSize()}get left(){return this.customLeft||this._left}set left(t){this._left=t}get top(){return this.customTop||this._top}set top(t){this._top=t}reset(){this.children=[],this.parent=null,this.isRoot=!1,this.layerIndex=0,this.left=0,this.top=0}handleData(t){return t.data.expand=!1!==t.data.expand,t.data.isActive=!0===t.data.isActive,t.children=t.children||[],t}createNodeData(){let{isUseCustomNodeContent:t,customCreateNodeContent:e}=this.mindMap.opt;t&&e&&(this._customNodeContent=e(this)),this._customNodeContent||(this._imgData=this.createImgNode(),this._iconData=this.createIconNode(),this._textData=this.createTextNode(),this._hyperlinkData=this.createHyperlinkNode(),this._tagData=this.createTagNode(),this._noteData=this.createNoteNode())}getSize(){this.updateGeneralization(),this.createNodeData();let{width:t,height:e}=this.getNodeRect(),i=this.width!==t||this.height!==e;return this.width=t,this.height=e,i}getNodeRect(){if(this.isUseCustomNodeContent()){let t=this.measureCustomNodeContentSize(this._customNodeContent);return{width:t.width,height:t.height}}let t=0,e=0,i=0,n=0;this._imgData&&(this._rectInfo.imgContentWidth=t=this._imgData.width,this._rectInfo.imgContentHeight=e=this._imgData.height),this._iconData.length>0&&(i+=this._iconData.reduce(((t,e)=>(n=Math.max(n,e.height),t+(e.width+this.textContentItemMargin))),0)),this._textData&&(i+=this._textData.width,n=Math.max(n,this._textData.height)),this._hyperlinkData&&(i+=this._hyperlinkData.width,n=Math.max(n,this._hyperlinkData.height)),this._tagData.length>0&&(i+=this._tagData.reduce(((t,e)=>(n=Math.max(n,e.height),t+(e.width+this.textContentItemMargin))),0)),this._noteData&&(i+=this._noteData.width,n=Math.max(n,this._noteData.height)),this._rectInfo.textContentWidth=i,this._rectInfo.textContentHeight=n;let s=e>0&&n>0?this.blockContentMargin:0,{paddingX:h,paddingY:a}=this.getPaddingVale(),o=Math.max(t,i),d=e+n,{paddingX:r,paddingY:l}=this.shapeInstance.getShapePadding(o,d,h,a);return this.shapePadding.paddingX=r,this.shapePadding.paddingY=l,{width:o+2*h+2*r,height:d+2*a+s+2*l}}layout(){this.group.clear();let{width:t,height:e,textContentItemMargin:i}=this,{paddingY:n}=this.getPaddingVale();if(n+=this.shapePadding.paddingY,this.shapeNode=this.shapeInstance.createShape(),this.group.add(this.shapeNode),this.updateNodeShape(),this.mindMap.opt.alwaysShowExpandBtn||(this._unVisibleRectRegionNode||(this._unVisibleRectRegionNode=new Rect),this._unVisibleRectRegionNode.fill({color:"transparent"}).size(this.expandBtnSize,e).x(t).y(0),this.group.add(this._unVisibleRectRegionNode)),this.isGeneralization&&this.generalizationBelongNode&&this.group.addClass("generalization_"+this.generalizationBelongNode.uid),this.isUseCustomNodeContent()){let i=new ForeignObject;return i.width(t),i.height(e),i.add(SVG(this._customNodeContent)),void this.group.add(i)}let s=0;this._imgData&&(s=this._imgData.height,this.group.add(this._imgData.node),this._imgData.node.cx(t/2).y(n));let h=new G,a=0,o=new G;if(this._iconData&&this._iconData.length>0){let t=0;this._iconData.forEach((e=>{e.node.x(a+t).y((this._rectInfo.textContentHeight-e.height)/2),o.add(e.node),t+=e.width+i})),h.add(o),a+=t}this._textData&&(this._textData.node.attr("data-offsetx",a),this._textData.node.x(a).y(0),h.add(this._textData.node),a+=this._textData.width+i),this._hyperlinkData&&(this._hyperlinkData.node.x(a).y((this._rectInfo.textContentHeight-this._hyperlinkData.height)/2),h.add(this._hyperlinkData.node),a+=this._hyperlinkData.width+i);let d=new G;if(this._tagData&&this._tagData.length>0){let t=0;this._tagData.forEach((e=>{e.node.x(a+t).y((this._rectInfo.textContentHeight-e.height)/2),d.add(e.node),t+=e.width+i})),h.add(d),a+=t}this._noteData&&(this._noteData.node.x(a).y((this._rectInfo.textContentHeight-this._noteData.height)/2),h.add(this._noteData.node),a+=this._noteData.width),h.translate(t/2-h.bbox().width/2,s+n+(s>0&&this._rectInfo.textContentHeight>0?this.blockContentMargin:0)),this.group.add(h)}bindGroupEvent(){this.group.on("click",(t=>{if(this.mindMap.emit("node_click",this,t),this.isMultipleChoice)return t.stopPropagation(),void(this.isMultipleChoice=!1);this.active(t)})),this.group.on("mousedown",(t=>{if(this.isRoot&&3===t.which&&t.stopPropagation(),this.isRoot||t.stopPropagation(),t.ctrlKey&&this.mindMap.opt.enableCtrlKeyNodeSelection){this.isMultipleChoice=!0;let t=this.nodeData.data.isActive;t||this.mindMap.emit("before_node_active",this,this.renderer.activeNodeList),this.mindMap.execCommand("SET_NODE_ACTIVE",this,!t),this.mindMap.renderer[t?"removeActiveNode":"addActiveNode"](this),this.mindMap.emit("node_active",t?null:this,this.mindMap.renderer.activeNodeList)}this.mindMap.emit("node_mousedown",this,t)})),this.group.on("mouseup",(t=>{this.isRoot||t.stopPropagation(),this.mindMap.emit("node_mouseup",this,t)})),this.group.on("mouseenter",(t=>{this._isMouseenter=!0,this.showExpandBtn(),this.mindMap.emit("node_mouseenter",this,t)})),this.group.on("mouseleave",(t=>{this._isMouseenter=!1,this.hideExpandBtn(),this.mindMap.emit("node_mouseleave",this,t)})),this.group.on("dblclick",(t=>{this.mindMap.opt.readonly||(t.stopPropagation(),this.mindMap.emit("node_dblclick",this,t))})),this.group.on("contextmenu",(t=>{this.mindMap.opt.readonly||t.ctrlKey||(t.stopPropagation(),t.preventDefault(),this.nodeData.data.isActive&&this.renderer.clearActive(),this.active(t),this.mindMap.emit("node_contextmenu",t,this))}))}active(t){this.mindMap.opt.readonly||(t&&t.stopPropagation(),this.nodeData.data.isActive||(this.mindMap.emit("before_node_active",this,this.renderer.activeNodeList),this.renderer.clearActive(),this.mindMap.execCommand("SET_NODE_ACTIVE",this,!0),this.renderer.addActiveNode(this),this.mindMap.emit("node_active",this,this.renderer.activeNodeList)))}update(t=!1){if(!this.group)return;let{enableNodeTransitionMove:e,nodeTransitionMoveDuration:i,alwaysShowExpandBtn:n}=this.mindMap.opt;if(n)this._expandBtn&&this.nodeData.children.length<=0?this.removeExpandBtn():this.renderExpandBtn();else{let{isActive:t,expand:e}=this.nodeData.data;!e||t||this._isMouseenter?this.showExpandBtn():this.hideExpandBtn()}this.renderGeneralization();let s=this.group.transform();this.left===s.translateX&&this.top===s.translateY||(!t&&e?this.group.animate(i).translate(this.left-s.translateX,this.top-s.translateY):this.group.translate(this.left-s.translateX,this.top-s.translateY))}reRender(){let t=this.getSize();return this.layout(),this.update(),t}updateNodeShape(){if(!this.shapeNode)return;const t=this.getShape();this.style[t===CONSTANTS.SHAPE.RECTANGLE?"rect":"shape"](this.shapeNode)}render(t=(()=>{})){let{enableNodeTransitionMove:e,nodeTransitionMoveDuration:i}=this.mindMap.opt;this.renderLine();let n=!1;if(this.group?(this.draw.add(this.group),this.needLayout&&(this.needLayout=!1,this.layout()),this.update()):(n=!0,this.group=new G,this.group.css({cursor:"default"}),this.bindGroupEvent(),this.draw.add(this.group),this.layout(),this.update(n)),this.children&&this.children.length&&!1!==this.nodeData.data.expand){let e=0;asyncRun(this.children.map((i=>()=>{i.render((()=>{e++,e>=this.children.length&&t()}))})))}else e&&!n?setTimeout((()=>{t()}),i):t();this.nodeData.inserting&&(delete this.nodeData.inserting,this.active(),setTimeout((()=>{this.mindMap.emit("node_dblclick",this)}),0))}remove(){this.group&&(this.group.remove(),this.removeGeneralization(),this.removeLine(),this.children&&this.children.length&&asyncRun(this.children.map((t=>()=>{t.remove()}))))}destroy(){this.group&&(this.group.remove(),this.removeGeneralization(),this.removeLine(),this.group=null)}hide(){if(this.group.hide(),this.hideGeneralization(),this.parent){let t=this.parent.children.indexOf(this);this.parent._lines[t]&&this.parent._lines[t].hide(),this._lines.forEach((t=>{t.hide()}))}this.children&&this.children.length&&asyncRun(this.children.map((t=>()=>{t.hide()})))}show(){if(this.group){if(this.group.show(),this.showGeneralization(),this.parent){let t=this.parent.children.indexOf(this);this.parent._lines[t]&&this.parent._lines[t].show(),this._lines.forEach((t=>{t.show()}))}this.children&&this.children.length&&asyncRun(this.children.map((t=>()=>{t.show()})))}}renderLine(t=!1){if(!1===this.nodeData.data.expand)return;let e=this.nodeData.children.length;this.mindMap.opt.layout!==CONSTANTS.LAYOUT.FISHBONE||!this.isRoot&&1!==this.layerIndex||(e=0),e>this._lines.length?new Array(e-this._lines.length).fill(0).forEach((()=>{this._lines.push(this.draw.path())})):e<this._lines.length&&(this._lines.slice(e).forEach((t=>{t.remove()})),this._lines=this._lines.slice(0,e)),this.renderer.layout.renderLine(this,this._lines,((t,e)=>{this.styleLine(t,e)}),this.style.getStyle("lineStyle",!0)),t&&this.children&&this.children.length>0&&this.children.forEach((e=>{e.renderLine(t)}))}getShape(){return this.mindMap.themeConfig.nodeUseLineStyle?CONSTANTS.SHAPE.RECTANGLE:this.style.getStyle("shape",!1,!1)}hasCustomPosition(){return void 0!==this.customLeft&&void 0!==this.customTop}ancestorHasCustomPosition(){let t=this;for(;t;){if(t.hasCustomPosition())return!0;t=t.parent}return!1}addChildren(t){this.children.push(t)}styleLine(t,e){let i=e.getSelfInhertStyle("lineWidth")||e.getStyle("lineWidth",!0),n=e.getSelfInhertStyle("lineColor")||e.getStyle("lineColor",!0),s=e.getSelfInhertStyle("lineDasharray")||e.getStyle("lineDasharray",!0);this.style.line(t,{width:i,color:n,dasharray:s})}removeLine(){this._lines.forEach((t=>{t.remove()})),this._lines=[]}isParent(t){if(this===t)return!1;let e=t.parent;for(;e;){if(this===e)return!0;e=e.parent}return!1}isBrother(t){return!(!this.parent||this===t)&&this.parent.children.find((e=>e===t))}getPaddingVale(){let{isActive:t}=this.nodeData.data;return{paddingX:this.getStyle("paddingX",!0,t),paddingY:this.getStyle("paddingY",!0,t)}}getStyle(t,e,i){let n=this.style.merge(t,e,i);return void 0===n?"":n}getSelfStyle(t){return this.style.getSelfStyle(t)}getParentSelfStyle(t){return this.parent?this.parent.getSelfStyle(t)||this.parent.getParentSelfStyle(t):null}getSelfInhertStyle(t){return this.getSelfStyle(t)||this.getParentSelfStyle(t)}getData(t){return t?this.nodeData.data[t]||"":this.nodeData.data}hasCustomStyle(){return this.style.hasCustomStyle()}}export default Node;
