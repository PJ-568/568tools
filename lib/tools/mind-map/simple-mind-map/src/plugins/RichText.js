import Quill from"quill";import"quill/dist/quill.snow.css";import html2canvas from"html2canvas";import{walk,getTextFromHtml}from"../utils";import{CONSTANTS}from"../constants/constant";let extended=!1,fontFamilyList=["宋体, SimSun, Songti SC","微软雅黑, Microsoft YaHei","楷体, 楷体_GB2312, SimKai, STKaiti","黑体, SimHei, Heiti SC","隶书, SimLi","andale mono","arial, helvetica, sans-serif","arial black, avant garde","comic sans ms","impact, chicago","times new roman","sans-serif","serif"],fontSizeList=new Array(100).fill(0).map(((t,e)=>e+"px"));class RichText{constructor({mindMap:t,pluginOpt:e}){this.mindMap=t,this.pluginOpt=e,this.textEditNode=null,this.showTextEdit=!1,this.quill=null,this.range=null,this.lastRange=null,this.node=null,this.styleEl=null,this.cacheEditingText="",this.lostStyle=!1,this.isCompositing=!1,this.initOpt(),this.extendQuill(),this.appendCss(),this.bindEvent(),this.mindMap.opt.data&&(this.mindMap.opt.data=this.handleSetData(this.mindMap.opt.data))}bindEvent(){this.onCompositionStart=this.onCompositionStart.bind(this),this.onCompositionEnd=this.onCompositionEnd.bind(this),window.addEventListener("compositionstart",this.onCompositionStart),window.addEventListener("compositionend",this.onCompositionEnd)}unbindEvent(){window.removeEventListener("compositionstart",this.onCompositionStart),window.removeEventListener("compositionend",this.onCompositionEnd)}appendCss(){this.styleEl=document.createElement("style"),this.styleEl.type="text/css",this.styleEl.innerHTML="\n      .ql-editor {\n        overflow: hidden;\n        padding: 0;\n        height: auto;\n        line-height: normal;\n        -webkit-user-select: text;\n      }\n      \n      .ql-container {\n        height: auto;\n        font-size: inherit;\n      }\n\n      .ql-container.ql-snow {\n        border: none;\n      }\n\n      .smm-richtext-node-wrap p {\n        font-family: auto;\n      }\n\n      .smm-richtext-node-edit-wrap p {\n        font-family: auto;\n      }\n    ",document.head.appendChild(this.styleEl)}initOpt(){this.pluginOpt.fontFamilyList&&Array.isArray(this.pluginOpt.fontFamilyList)&&(fontFamilyList=this.pluginOpt.fontFamilyList),this.pluginOpt.fontSizeList&&Array.isArray(this.pluginOpt.fontSizeList)&&(fontSizeList=this.pluginOpt.fontSizeList)}extendQuill(){if(extended)return;extended=!0;const t=Quill.import("attributors/class/font");t.whitelist=fontFamilyList,Quill.register(t,!0);const e=Quill.import("attributors/style/font");e.whitelist=fontFamilyList,Quill.register(e,!0);const i=Quill.import("attributors/class/size");i.whitelist=fontSizeList,Quill.register(i,!0);const n=Quill.import("attributors/style/size");n.whitelist=fontSizeList,Quill.register(n,!0)}showEditText(t,e){if(this.showTextEdit)return;this.node=t,e||(e=t._textData.node.node.getBoundingClientRect()),this.mindMap.emit("before_show_text_edit"),this.mindMap.renderer.textEdit.registerTmpShortcut();let i=t._textData.node,n=i.attr("data-width"),o=i.attr("data-height"),s=e.width/n,l=e.height/o;this.textEditNode||(this.textEditNode=document.createElement("div"),this.textEditNode.classList.add("smm-richtext-node-edit-wrap"),this.textEditNode.style.cssText="position:fixed;box-sizing: border-box;box-shadow: 0 0 20px rgba(0,0,0,.5);outline: none; word-break: break-all;padding: 4px 6px;",this.textEditNode.addEventListener("click",(t=>{t.stopPropagation()})),document.body.appendChild(this.textEditNode));let a=t.style.merge("fillColor");if(this.textEditNode.style.marginLeft=`-${6*s}px`,this.textEditNode.style.marginTop=`-${4*l}px`,this.textEditNode.style.zIndex=this.mindMap.opt.nodeTextEditZIndex,this.textEditNode.style.backgroundColor="transparent"===a?"#fff":a,this.textEditNode.style.minWidth=n+12+"px",this.textEditNode.style.minHeight=o+"px",this.textEditNode.style.left=e.left+"px",this.textEditNode.style.top=e.top+"px",this.textEditNode.style.display="block",this.textEditNode.style.maxWidth=this.mindMap.opt.textAutoWrapWidth+12+"px",this.textEditNode.style.transform=`scale(${s}, ${l})`,this.textEditNode.style.transformOrigin="left top",t.nodeData.data.richText)this.textEditNode.innerHTML=this.cacheEditingText||t.nodeData.data.text;else{let e=`<p>${t.nodeData.data.text.split(/\n/gim).join("<br>")}</p>`;this.textEditNode.innerHTML=this.cacheEditingText||e}this.initQuillEditor(),document.querySelector(".ql-editor").style.minHeight=o+"px",this.showTextEdit=!0,this.focus(),t.nodeData.data.richText||this.setTextStyleIfNotRichText(t),this.cacheEditingText=""}setTextStyleIfNotRichText(t){let e={font:t.style.merge("fontFamily"),color:t.style.merge("color"),italic:"italic"===t.style.merge("fontStyle"),bold:"bold"===t.style.merge("fontWeight"),size:t.style.merge("fontSize")+"px",underline:"underline"===t.style.merge("textDecoration"),strike:"line-through"===t.style.merge("textDecoration")};this.pureFormatAllText(e)}getEditText(){return this.quill.container.firstChild.innerHTML.replace(/<p><br><\/p>$/,"")}hideEditText(t){if(!this.showTextEdit)return;let e=this.getEditText(),i=t&&t.length>0?t:this.mindMap.renderer.activeNodeList;i.forEach((t=>{this.mindMap.execCommand("SET_NODE_TEXT",t,e,!0),t.isGeneralization&&t.generalizationBelongNode.updateGeneralization(),this.mindMap.render()})),this.mindMap.emit("hide_text_edit",this.textEditNode,i),this.textEditNode.style.display="none",this.showTextEdit=!1,this.mindMap.emit("rich_text_selection_change",!1),this.node=null}initQuillEditor(){this.quill=new Quill(this.textEditNode,{modules:{toolbar:!1,keyboard:{bindings:{enter:{key:13,handler:function(){}}}}},theme:"snow"}),this.quill.on("selection-change",(t=>{if(this.lastRange=this.range,this.range=null,t){let e=this.quill.getBounds(t.index,t.length),i=this.textEditNode.getBoundingClientRect(),n={left:e.left+i.left,top:e.top+i.top,right:e.right+i.left,bottom:e.bottom+i.top,width:e.width},o=this.quill.getFormat(t.index,t.length),s=!1;0==t.length?s=!1:(this.range=t,s=!0),this.mindMap.emit("rich_text_selection_change",s,n,o)}})),this.quill.on("text-change",(()=>{let t=this.quill.getContents(),e=t.ops.length;e<=0||1===e&&"\n"===t.ops[0].insert?(this.lostStyle=!0,this.syncFormatToNodeConfig(null,!0)):this.lostStyle&&!this.isCompositing&&(this.setTextStyleIfNotRichText(this.node),this.lostStyle=!1)}))}onCompositionStart(){this.showTextEdit&&(this.isCompositing=!0)}onCompositionEnd(){this.showTextEdit&&this.lostStyle&&(this.isCompositing=!1,this.setTextStyleIfNotRichText(this.node))}selectAll(){this.quill.setSelection(0,this.quill.getLength())}focus(){let t=this.quill.getLength();this.quill.setSelection(t,t)}formatText(t={},e=!1){if(!this.range&&!this.lastRange)return;this.syncFormatToNodeConfig(t,e);let i=!this.range,n=i?this.lastRange:this.range;e?this.quill.removeFormat(n.index,n.length):this.quill.formatText(n.index,n.length,t),i&&this.quill.setSelection(this.lastRange.index,this.lastRange.length)}removeFormat(){this.formatText({},!0)}formatRangeText(t,e={}){t&&(this.syncFormatToNodeConfig(e),this.quill.formatText(t.index,t.length,e))}formatAllText(t={}){this.syncFormatToNodeConfig(t),this.pureFormatAllText(t)}pureFormatAllText(t={}){this.quill.formatText(0,this.quill.getLength(),t)}syncFormatToNodeConfig(t,e){if(this.node)if(e)["fontFamily","fontSize","fontWeight","fontStyle","textDecoration","color"].forEach((t=>{delete this.node.nodeData.data[t]}));else{let e=this.richTextStyleToNormalStyle(t);this.mindMap.renderer.setNodeData(this.node,e)}}normalStyleToRichTextStyle(t){let e={};return Object.keys(t).forEach((i=>{let n=t[i];switch(i){case"fontFamily":e.font=n;break;case"fontSize":e.size=n+"px";break;case"fontWeight":e.bold="bold"===n;break;case"fontStyle":e.italic="italic"===n;break;case"textDecoration":e.underline="underline"===n,e.strike="line-through"===n;break;case"color":e.color=n}})),e}richTextStyleToNormalStyle(t){let e={};return Object.keys(t).forEach((i=>{let n=t[i];switch(i){case"font":e.fontFamily=n;break;case"size":e.fontSize=parseFloat(n);break;case"bold":e.fontWeight=n?"bold":"normal";break;case"italic":e.fontStyle=n?"italic":"normal";break;case"underline":e.textDecoration=n?"underline":"none";break;case"strike":e.textDecoration=n?"line-through":"none";break;case"color":e.color=n}})),e}async handleExportPng(t){let e=document.createElement("div");e.style.position="absolute",e.style.left="-9999999px",e.appendChild(t),this.mindMap.el.appendChild(e);let i=t=>{t.style.margin=0,t.style.padding=0,t.hasChildNodes()&&Array.from(t.children).forEach((t=>{i(t)}))};i(t);let n=await html2canvas(e,{backgroundColor:null});return this.mindMap.el.removeChild(e),n.toDataURL()}transformAllNodesToNormalNode(){walk(this.mindMap.renderer.renderTree,null,(t=>{t.data.richText&&(t.data.richText=!1,t.data.text=getTextFromHtml(t.data.text))}),null,!0,0,0),this.mindMap.command.clearHistory(),this.mindMap.command.addHistory(),this.mindMap.render(null,CONSTANTS.TRANSFORM_TO_NORMAL_NODE)}handleSetData(t){let e=t=>{t.data.richText||(t.data.richText=!0,t.data.resetRichText=!0),t.children&&t.children.length>0&&Array.from(t.children).forEach((t=>{e(t)}))};return e(t),t}beforePluginRemove(){this.transformAllNodesToNormalNode(),document.head.removeChild(this.styleEl)}}RichText.instanceName="richText";export default RichText;
