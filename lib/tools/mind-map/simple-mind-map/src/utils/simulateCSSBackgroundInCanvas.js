const getNumberValueFromStr=t=>String(t).split(/\s+/).map((t=>{if(/^[\d.]+/.test(t)){let e=/^([\d.]+)(.*)$/.exec(t);return[Number(e[1]),e[2]]}return t})),zoomWidth=(t,e)=>t*e,zoomHeight=(t,e)=>e/t,keyWordToPercentageMap={left:0,top:0,center:50,bottom:100,right:100},handleBackgroundSize=({backgroundSize:t,drawOpt:e,imageRatio:a,canvasWidth:i,canvasHeight:r,canvasRatio:o})=>{if(t){let h=getNumberValueFromStr(t);if("auto"===h[0]&&"auto"===h[1])return;if("cover"===h[0])return void(a>o?(e.height=r,e.width=zoomWidth(a,r)):(e.width=i,e.height=zoomHeight(a,i)));if("contain"===h[0])return void(a>o?(e.width=i,e.height=zoomHeight(a,i)):(e.height=r,e.width=zoomWidth(a,r)));let g=-1;h[0]&&(Array.isArray(h[0])?"%"===h[0][1]?(e.width=h[0][0]/100*i,g=e.width):(e.width=h[0][0],g=h[0][0]):"auto"===h[0]&&h[1]&&("%"===h[1][1]?e.width=zoomWidth(a,h[1][0]/100*r):e.width=zoomWidth(a,h[1][0]))),h[1]&&Array.isArray(h[1])?"%"===h[1][1]?e.height=h[1][0]/100*r:e.height=h[1][0]:-1!==g&&(e.height=zoomHeight(a,g))}},handleBackgroundPosition=({backgroundPosition:t,drawOpt:e,imgWidth:a,imgHeight:i,canvasWidth:r,canvasHeight:o})=>{if(t){let h=getNumberValueFromStr(t);if(h=h.map((t=>"string"==typeof t&&void 0!==keyWordToPercentageMap[t]?[keyWordToPercentageMap[t],"%"]:t)),Array.isArray(h[0])){if(1===h.length&&h.push([50,"%"]),"%"===h[0][1]){let t=h[0][0]/100*r,i=h[0][0]/100*a;e.x=t-i}else e.x=h[0][0];if("%"===h[1][1]){let t=h[1][0]/100*o,a=h[1][0]/100*i;e.y=t-a}else e.y=h[1][0]}}},handleBackgroundRepeat=({ctx:t,image:e,backgroundRepeat:a,drawOpt:i,imgWidth:r,imgHeight:o,canvasWidth:h,canvasHeight:g})=>{if(a){let d=i.x,n=i.y,c=d-Math.ceil(d/r)*r,m=n-Math.ceil(n/o)*o,s=getNumberValueFromStr(a);if("no-repeat"===s[0]||r>=h&&o>=g)return;if("repeat-x"===s[0]&&h>r){let a=c;for(;a<h;)drawImage(t,e,{...i,x:a}),a+=r;return!0}if("repeat-y"===s[0]&&g>o){let a=m;for(;a<g;)drawImage(t,e,{...i,y:a}),a+=o;return!0}if("repeat"===s[0]){let a=c;for(;a<h;){if(g>o){let r=m;for(;r<g;)drawImage(t,e,{...i,x:a,y:r}),r+=o}a+=r}return!0}}},drawImage=(t,e,a)=>{t.drawImage(e,a.sx,a.sy,a.swidth,a.sheight,a.x,a.y,a.width,a.height)},drawBackgroundImageToCanvas=(t,e,a,i,{backgroundSize:r,backgroundPosition:o,backgroundRepeat:h},g=(()=>{}))=>{let d=e/a,n=new Image;n.src=i,n.onload=()=>{let i=n.width,c=n.height,m=i/c,s={sx:0,sy:0,swidth:i,sheight:c,x:0,y:0,width:i,height:c};handleBackgroundSize({backgroundSize:r,drawOpt:s,imageRatio:m,canvasWidth:e,canvasHeight:a,canvasRatio:d}),handleBackgroundPosition({backgroundPosition:o,drawOpt:s,imgWidth:s.width,imgHeight:s.height,imageRatio:m,canvasWidth:e,canvasHeight:a,canvasRatio:d}),handleBackgroundRepeat({ctx:t,image:n,backgroundRepeat:h,drawOpt:s,imgWidth:s.width,imgHeight:s.height,imageRatio:m,canvasWidth:e,canvasHeight:a,canvasRatio:d})||drawImage(t,n,s),g()},n.onerror=t=>{g(t)}};export default drawBackgroundImageToCanvas;
