import Base from"./Base";import{walk,asyncRun}from"../utils";class LogicalStructure extends Base{constructor(e={}){super(e)}doLayout(e){asyncRun([()=>{this.computedBaseValue()},()=>{this.computedTopValue()},()=>{this.adjustTopValue()},()=>{e(this.root)}])}computedBaseValue(){walk(this.renderer.renderTree,null,((e,t,i,n)=>{let r=this.createNode(e,t,i,n);if(i?this.setNodeCenter(r):r.left=t._node.left+t._node.width+this.getMarginX(n),!e.data.expand)return!0}),((e,t,i,n)=>{let r=!1===e.data.expand?0:e._node.children.length;e._node.childrenAreaHeight=r?e._node.children.reduce(((e,t)=>e+t.height),0)+(r+1)*this.getMarginY(n+1):0}),!0,0)}computedTopValue(){walk(this.root,null,((e,t,i,n)=>{if(e.nodeData.data.expand&&e.children&&e.children.length){let t=this.getMarginY(n+1),i=e.top+e.height/2-e.childrenAreaHeight/2+t;e.children.forEach((e=>{e.top=i,i+=e.height+t}))}}),null,!0)}adjustTopValue(){walk(this.root,null,((e,t,i,n)=>{if(!e.nodeData.data.expand)return;let r=e.childrenAreaHeight-2*this.getMarginY(n+1)-e.height;r>0&&this.updateBrothers(e,r/2)}),null,!0)}updateBrothers(e,t){if(e.parent){let i=e.parent.children,n=i.findIndex((t=>t===e));i.forEach(((i,r)=>{if(i===e||i.hasCustomPosition())return;let h=0;r<n?h=-t:r>n&&(h=t),i.top+=h,i.children&&i.children.length&&this.updateChildren(i.children,"top",h)})),this.updateBrothers(e.parent,t)}}renderLine(e,t,i,n){"curve"===n?this.renderLineCurve(e,t,i):"direct"===n?this.renderLineDirect(e,t,i):this.renderLineStraight(e,t,i)}renderLineStraight(e,t,i){if(e.children.length<=0)return[];let{left:n,top:r,width:h,height:a,expandBtnSize:l}=e;this.mindMap.opt.alwaysShowExpandBtn||(l=0);let d=.6*(this.getMarginX(e.layerIndex+1)-l),o=this.mindMap.themeConfig.nodeUseLineStyle;e.children.forEach(((s,p)=>{let g=0===e.layerIndex?n+h:n+h+l,u=r+a/2,c=s.left,f=s.top+s.height/2,m=o?s.width:0;u=o&&!e.isRoot?u+a/2:u,f=o?f+s.height/2:f;let $=`M ${g},${u} L ${g+d},${u} L ${g+d},${f} L ${c+m},${f}`;t[p].plot($),i&&i(t[p],s)}))}renderLineDirect(e,t,i){if(e.children.length<=0)return[];let{left:n,top:r,width:h,height:a,expandBtnSize:l}=e;this.mindMap.opt.alwaysShowExpandBtn||(l=0);let d=this.mindMap.themeConfig.nodeUseLineStyle;e.children.forEach(((o,s)=>{let p=0===e.layerIndex?n+h/2:n+h+l,g=r+a/2,u=o.left,c=o.top+o.height/2;g=d&&!e.isRoot?g+a/2:g,c=d?c+o.height/2:c;let f=`M ${p},${g} L ${u},${c}`+(d?` L ${o.left+o.width},${c}`:"");t[s].plot(f),i&&i(t[s],o)}))}renderLineCurve(e,t,i){if(e.children.length<=0)return[];let{left:n,top:r,width:h,height:a,expandBtnSize:l}=e;this.mindMap.opt.alwaysShowExpandBtn||(l=0);let d=this.mindMap.themeConfig.nodeUseLineStyle;e.children.forEach(((o,s)=>{let p=0===e.layerIndex?n+h/2:n+h+l,g=r+a/2,u=o.left,c=o.top+o.height/2,f="";g=d&&!e.isRoot?g+a/2:g,c=d?c+o.height/2:c;let m=d?` L ${o.left+o.width},${c}`:"";f=e.isRoot?this.quadraticCurvePath(p,g,u,c)+m:this.cubicBezierPath(p,g,u,c)+m,t[s].plot(f),i&&i(t[s],o)}))}renderExpandBtn(e,t){let{width:i,height:n}=e,{translateX:r,translateY:h}=t.transform(),a=i,l=n/2+(this.mindMap.themeConfig.nodeUseLineStyle?n/2:0);a===r&&l===h||t.translate(a-r,l-h)}renderGeneralization(e,t,i){let{top:n,bottom:r,right:h,generalizationLineMargin:a,generalizationNodeMargin:l}=this.getNodeBoundaries(e,"h"),d=h+a,o=`M ${d},${n} Q ${d+20},${n+(r-n)/2} ${h+a},${r}`;t.plot(o),i.left=h+l,i.top=n+(r-n-i.height)/2}}export default LogicalStructure;
