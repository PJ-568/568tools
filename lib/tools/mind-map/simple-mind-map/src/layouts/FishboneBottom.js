import Base from"./Base";import{walk,asyncRun}from"../utils";import{CONSTANTS}from"../utils/constant";const degToRad=e=>Math.PI/180*e;class Fishbone extends Base{constructor(e={}){super(e)}doLayout(e){asyncRun([()=>{this.computedBaseValue()},()=>{this.computedLeftTopValue()},()=>{this.adjustLeftTopValue()},()=>{e(this.root)}])}computedBaseValue(){walk(this.renderer.renderTree,null,((e,t,i,h,n)=>{let l=this.createNode(e,t,i,h);if(i?this.setNodeCenter(l):(t._node.dir?l.dir=t._node.dir:l.dir=n%2==0?CONSTANTS.TIMELINE_DIR.TOP:CONSTANTS.TIMELINE_DIR.BOTTOM,t._node.isRoot&&(l.top=t._node.top+t._node.height)),!e.data.expand)return!0}),null,!0,0)}computedLeftTopValue(){walk(this.root,null,((e,t,i,h,n)=>{if(e.isRoot){let t=e.left+e.width;e.children.forEach((e=>{e.left=t,t+=e.width}))}if(1===h&&e.children){let t=e.left+.5*e.width,i=e.top+e.height+(this.getNodeActChildrenLength(e)>0?e.expandBtnSize:0);e.children.forEach((e=>{e.left=t,e.top=i+(this.getNodeActChildrenLength(e)>0?e.expandBtnSize:0),i+=e.height+(this.getNodeActChildrenLength(e)>0?e.expandBtnSize:0)}))}if(h>1&&e.children){let t=e.left+.5*e.width,i=e.top-(this.getNodeActChildrenLength(e)>0?e.expandBtnSize:0);e.children.forEach((e=>{e.left=t,e.top=i-e.height,i-=e.height+(this.getNodeActChildrenLength(e)>0?e.expandBtnSize:0)}))}}),null,!0)}adjustLeftTopValue(){walk(this.root,null,((e,t,i,h)=>{if(!e.nodeData.data.expand)return;let n=e.children.length;if(h>2&&n>0){let t=e.children.reduce(((e,t)=>e+t.height+(this.getNodeActChildrenLength(t)>0?t.expandBtnSize:0)),0);this.updateBrothersTop(e,-t)}}),((e,t)=>{if(t&&t.isRoot){let t=0,i=0;e.children.forEach((e=>{let h=this.getNodeActChildrenLength(e)>0,n=this.getNodeAreaHeight(e),l=h>0?n-e.height-(h?e.expandBtnSize:0):0,r=t+l;e.top+=r;let d=(i+n)/Math.tan(degToRad(this.mindMap.opt.fishboneDeg));e.left+=d,t+=l,i+=n,this.updateChildrenPro(e.children,{top:r,left:d})}))}if(e.isRoot){let t=0;e.children.forEach((e=>{e.left+=t,this.updateChildren(e.children,"left",t);let{left:i,right:h}=this.getNodeBoundaries(e,"h");t+=h-i}))}}),!0)}getNodeAreaHeight(e){let t=0,i=e=>{t+=e.height+(this.getNodeActChildrenLength(e)>0?e.expandBtnSize:0),e.children.length&&e.children.forEach((e=>{i(e)}))};return i(e),t}updateBrothersLeft(e){let t=e.children,i=0;t.forEach((e=>{e.left+=i,e.children&&e.children.length&&this.updateChildren(e.children,"left",i);let{left:t,right:h}=this.getNodeBoundaries(e,"h"),n=h-t-e.width;n>0&&(i+=n)}))}updateBrothersTop(e,t){if(e.parent&&!e.parent.isRoot){let i=e.parent.children,h=i.findIndex((t=>t===e));i.forEach(((e,i)=>{if(e.hasCustomPosition())return;let n=0;i>h&&(n=t),e.top+=n,e.children&&e.children.length&&this.updateChildren(e.children,"top",n)})),this.updateBrothersTop(e.parent,3===e.layerIndex?0:t)}}renderLine(e,t,i){if(e.children.length<=0)return[];let{left:h,top:n,width:l,height:r,expandBtnSize:d}=e,o=e.children.length;if(e.isRoot){let h=e;e.children.forEach(((n,l)=>{let r=h.left+h.width,d=n.left,o=e.top+e.height/2,a=`M ${r},${o} L ${d},${o}`;t[l].plot(a),i&&i(t[l],n),h=n}))}else{let h=-1/0,l=1/0,a=-1/0,s=e.left+.3*e.width;if(e.children.forEach(((n,r)=>{n.left>a&&(a=n.left);let d=n.top+n.height/2;if(d>h&&(h=d),d<l&&(l=d),e.layerIndex>1){let e=`M ${s},${d} L ${n.left},${d}`;t[r].plot(e),i&&i(t[r],n)}})),o>0){let t=this.draw.path();d=o>0?d:0;let h=a-e.left-.3*e.width;e.parent&&e.parent.isRoot?t.plot(`M ${s},${n+r} L ${s+h},${n+r+Math.tan(degToRad(this.mindMap.opt.fishboneDeg))*h}`):t.plot(`M ${s},${n} L ${s},${l}`),e.style.line(t),e._lines.push(t),i&&i(t,e)}}}renderExpandBtn(e,t){let{width:i,height:h,expandBtnSize:n,isRoot:l}=e;if(!l){let{translateX:l,translateY:r}=t.transform();e.parent&&e.parent.isRoot?t.translate(.3*i-n/2-l,h+n/2-r):t.translate(.3*i-n/2-l,-n/2-r)}}renderGeneralization(e,t,i){let{top:h,bottom:n,right:l,generalizationLineMargin:r,generalizationNodeMargin:d}=this.getNodeBoundaries(e,"h"),o=l+r,a=`M ${o},${h} Q ${o+20},${h+(n-h)/2} ${l+r},${n}`;t.plot(a),i.left=l+d,i.top=h+(n-h-i.height)/2}}export default Fishbone;
