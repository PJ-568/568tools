import Base from"./Base";import{walk,asyncRun}from"../utils";import{CONSTANTS}from"../constants/constant";class Timeline extends Base{constructor(e={},t){super(e),this.layout=t}doLayout(e){asyncRun([()=>{this.computedBaseValue()},()=>{this.computedLeftTopValue()},()=>{this.adjustLeftTopValue()},()=>{e(this.root)}])}computedBaseValue(){walk(this.renderer.renderTree,null,((e,t,i,n,h)=>{let r=this.createNode(e,t,i,n);if(i?this.setNodeCenter(r):(this.layout===CONSTANTS.LAYOUT.TIMELINE2?t._node.dir?r.dir=t._node.dir:r.dir=h%2==0?CONSTANTS.TIMELINE_DIR.BOTTOM:CONSTANTS.TIMELINE_DIR.TOP:r.dir="",t._node.isRoot&&(r.top=t._node.top+(e._node.height>t._node.height?-(e._node.height-t._node.height)/2:(t._node.height-e._node.height)/2))),!e.data.expand)return!0}),null,!0,0)}computedLeftTopValue(){walk(this.root,null,((e,t,i,n,h)=>{if(e.nodeData.data.expand&&e.children&&e.children.length){let t=this.getMarginX(n+1),h=this.getMarginY(n+1);if(i){let i=e.left+e.width+t;e.children.forEach((e=>{e.left=i,i+=e.width+t}))}else{let t=e.top+e.height+h+(this.getNodeActChildrenLength(e)>0?e.expandBtnSize:0);e.children.forEach((i=>{i.left=e.left+.5*e.width,i.top=t,t+=i.height+h+(this.getNodeActChildrenLength(i)>0?i.expandBtnSize:0)}))}}}),null,!0)}adjustLeftTopValue(){walk(this.root,null,((e,t,i,n)=>{if(!e.nodeData.data.expand)return;e.isRoot&&this.updateBrothersLeft(e);let h=e.children.length;if(t&&!t.isRoot&&h>0){let t=this.getMarginY(n+1),i=e.children.reduce(((e,t)=>e+t.height+(this.getNodeActChildrenLength(t)>0?t.expandBtnSize:0)),0)+h*t;this.updateBrothersTop(e,i)}}),((e,t,i,n)=>{t&&t.isRoot&&e.dir===CONSTANTS.TIMELINE_DIR.TOP&&e.children.forEach((t=>{let i=this.getNodeAreaHeight(t),n=t.top;t.top=e.top-(t.top-e.top)-i+e.height,this.updateChildren(t.children,"top",t.top-n)}))}),!0)}getNodeAreaHeight(e){let t=0,i=e=>{t+=e.height+(this.getNodeActChildrenLength(e)>0?e.expandBtnSize:0)+this.getMarginY(e.layerIndex),e.children.length&&e.children.forEach((e=>{i(e)}))};return i(e),t}updateBrothersLeft(e){let t=e.children,i=0;t.forEach((e=>{e.left+=i,e.children&&e.children.length&&this.updateChildren(e.children,"left",i);let{left:t,right:n}=this.getNodeBoundaries(e,"h"),h=n-t-e.width;h>0&&(i+=h)}))}updateBrothersTop(e,t){if(e.parent&&!e.parent.isRoot){let i=e.parent.children,n=i.findIndex((t=>t===e));i.forEach(((e,i)=>{if(e.hasCustomPosition())return;let h=0;i>n&&(h=t),e.top+=h,e.children&&e.children.length&&this.updateChildren(e.children,"top",h)})),this.updateBrothersTop(e.parent,t)}}renderLine(e,t,i){if(e.children.length<=0)return[];let{left:n,top:h,width:r,height:o,expandBtnSize:l}=e;this.mindMap.opt.alwaysShowExpandBtn||(l=0);let d=e.children.length;if(e.isRoot){let n=e;e.children.forEach(((h,r)=>{let o=n.left+n.width,l=h.left,d=e.top+e.height/2,a=`M ${o},${d} L ${l},${d}`;t[r].plot(a),i&&i(t[r],h),n=h}))}else{let n=-1/0,r=1/0,a=e.left+.3*e.width;if(e.children.forEach(((e,h)=>{let o=e.top+e.height/2;o>n&&(n=o),o<r&&(r=o);let l=`M ${a},${o} L ${e.left},${o}`;t[h].plot(l),i&&i(t[h],e)})),d>0){let t=this.draw.path();l=d>0?l:0,e.parent&&e.parent.isRoot&&e.dir===CONSTANTS.TIMELINE_DIR.TOP?t.plot(`M ${a},${h} L ${a},${r}`):t.plot(`M ${a},${h+o+l} L ${a},${n}`),e.style.line(t),e._lines.push(t),i&&i(t,e)}}}renderExpandBtn(e,t){let{width:i,height:n,expandBtnSize:h,isRoot:r}=e;if(!r){let{translateX:r,translateY:o}=t.transform();e.parent&&e.parent.isRoot&&e.dir===CONSTANTS.TIMELINE_DIR.TOP?t.translate(.3*i-h/2-r,-h/2-o):t.translate(.3*i-h/2-r,n+h/2-o)}}renderGeneralization(e,t,i){let{top:n,bottom:h,right:r,generalizationLineMargin:o,generalizationNodeMargin:l}=this.getNodeBoundaries(e,"h"),d=r+o,a=`M ${d},${n} Q ${d+20},${n+(h-n)/2} ${r+o},${h}`;t.plot(a),i.left=r+l,i.top=n+(h-n-i.height)/2}}export default Timeline;
